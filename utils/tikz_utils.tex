% !TEX root = ../../ACT4E-full.tex

\usepackage{tikz}


\usetikzlibrary{positioning,intersections,hobby,patterns,calc,decorations.pathmorphing,decorations.markings, shadows,shapes}

\usetikzlibrary{
    cd,
    decorations.markings,
    positioning,
    arrows.meta,
    shapes,
    calc,
    fit,
    quotes}

\tikzstyle{block} = [draw, rectangle, minimum height=2em, minimum width=3em,thick]

%\tikzcdset{every label/.append style = {font = \footnotesize}}

% Scaling of the fonts
%\tikzset{every picture/.append style={font=\relscale{0.8}}}
%\tikzcdset{every picture/.append style={font=\relscale{1.25}}}


\def\preceqSize{10pt}
\newcommand{\hasselinewidth}{2mm}


\tikzset{fcname/.store in =\fcname, fcname={}}
\tikzset{funame/.store in =\funame, funame={}}
\tikzset{rcname/.store in =\rcname, rcname={}}
\tikzset{runame/.store in =\runame, runame={}}
\tikzset{whereres/.store in =\whereres, whereres=0.5}
\tikzset{wherefun/.store in =\wherefun, wherefun=0.5}
\tikzset{relres/.store in =\relres, relres={right}}
\tikzset{relfun/.store in =\relfun, relfun={left}}
\tikzset{posres/.store in =\posres, posres=0.95}
\tikzset{posfun/.store in =\posfun, posfun=0.95}
\tikzset{loos/.store in =\loos, loos=2}
\tikzset{feedback/.store in =\feedback, feedback=0}
\tikzset{
    DP/.style={%everything after equals replaces "DP" in key.
        %every to/.style={out=0,in=180,draw},
        label/.style={
            font=\everymath\expandafter{\the\everymath\scriptstyle},
            inner sep=5pt,
            node distance=2pt and -2pt},
        semithick,
        node distance=1 and 1,
        rconn/.style={color=white,opacity=0.0,postaction={decorate}, shorten <=3.2pt, shorten >= 0.8,
        decoration={markings,
        mark= at position 0 with {
            \coordinate (a);
        },
        mark=at position .5 with
                {
                \ifthenelse{\equal{\feedback}{1}}{\def\angleOut{-90}\def\angleIn{-90}}{\def\angleOut{0}\def\angleIn{180}}
                \coordinate (b);
                \draw[dashed,\dpred,opacity=1.0] (a) to[out=\angleOut,in=\angleIn,looseness=\loos]
                node[pos=\posres,\relres=\whereres mm,\dpred,opacity=1,fill=white,inner sep=1pt,outer sep=1pt]{\rcname} (b);
            },
            mark= at position 1 with
                {
                \ifthenelse{\equal{\feedback}{1}}{\def\angleOut{0}\def\angleIn{0}}{\def\angleOut{180}\def\angleIn{0}}
                \ifthenelse{\equal{\feedback}{1}}{\def\symbol{\succeq}}{\def\symbol{\preceq}}
                \coordinate (c);
                \draw[\dpgreen,opacity=1.0] (c) to[out=\angleOut,in=\angleIn,looseness=\loos]
                node[pos=\posfun,\relfun=\wherefun mm,\dpgreen,opacity=1,fill=white,inner sep=1pt,outer sep=1pt]{\fcname} (b){}; %bend right
                \node[draw,circle,inner sep=0.5pt,color=black,fill=white,opacity=1.0,line width=0.2mm] at (b) (nodepreceq) {$\symbol$};
            }
        }},
        runconn/.style={color=\dpred,dashed,postaction={decorate},
        decoration={markings,
        mark= at position 1 with {
            \coordinate (a);
            \draw[\dpred,opacity=1.0,dashed] ($(a)+(0.05,0)$) --++ (0.5,0) node[\relres,pos=\posres]{\runame};}
        }
        },
        funconn/.style={color=white,postaction={decorate},
        decoration={markings,
        mark= at position 0 with {
            \coordinate (a);
            \draw[\dpgreen] ($(a)+(-0.05,0)$) -- ($(a)+(-0.5,0)$) node[\relfun,pos=\posfun]{\funame};}
        }
        },
        execute at begin picture={\tikzset{
            x=\dpx, y=\dpy,
            every fit/.style={inner xsep=\dpx, inner ysep=\dpy}}}
    },
    dpx/.store in=\dpx,
    dpx = 1.5cm,
    dpy/.store in=\dpy,
    dpy = 1.5ex,
    dp port sep/.store in=\dpportsep,
    dp port sep=2,
    dp port length/.store in=\dpportlen,
    dp port length=4pt,
    dp min width/.store in=\dpminwidth,
    dp min width=0.5cm,
    dp rounded corners/.store in=\dpcorners,
    dp rounded corners=2pt,
    dp small/.style={dp port sep=1, dp port length=2.5pt, dpx=.4cm, dp min width=.4cm, dpy=.7ex},
    dp/.code 2 args={%When you see this key, run the code below:
        % put padding rather than minimum height
        % the font size should be the same as the text
        \pgfmathsetlengthmacro{\dpheight}{\dpportsep * (max(#1,#2)) * \dpy}
        \pgfkeysalso{draw,%
            minimum width=\dpminwidth,%
            minimum height=\dpheight,%
        %font=\bfseries,
            outer sep=0pt,%
            inner sep=5pt,%
            rounded corners=\dpcorners,
            thick,
            prefix after command={\pgfextra{\let\fixname\tikzlastnode}},
            append after command={\pgfextra{\draw
            \ifnum #1=0{} \else foreach \i in {1,...,#1} {
                ($(\fixname.north west)!{\i/(#1+1)}!(\fixname.south west)$) +(0,0) node[solid,left,circle,color=darkgreen,draw,fill=darkgreen,scale=0.3] {} coordinate (\fixname_fun\i) -- +(0,0) coordinate (\fixname_fun\i')}\fi %Define the endpoints of tickmarks
            \ifnum #2=0{} \else foreach \i in {1,...,#2} {
                ($(\fixname.north east)!{\i/(#2+1)}!(\fixname.south east)$) +(0,0) coordinate (\fixname_res\i') -- +(0,0) node[solid,right,circle,color=darkred,draw,fill=darkred,scale=0.3] {} coordinate (\fixname_res\i)}\fi;
            }}}
    },
    dp name/.style={append after command={\pgfextra{\node[label=center,inner sep=2pt,fill=white] at (\fixname) {#1};}}}
}

\tikzset{
    oriented WD/.style={%everything after equals replaces "oriented WD" in key.
        every to/.style={out=0,in=180,draw},
        label/.style={
            font=\everymath\expandafter{\the\everymath\scriptstyle},
            inner sep=0pt,
            node distance=2pt and -2pt},
        semithick,
        node distance=1 and 1,
        decoration={markings, mark=at position .5 with {\arrow{stealth};}},
        ar/.style={postaction={decorate}},
        execute at begin picture={\tikzset{
            x=\bbx, y=\bby,
            every fit/.style={inner xsep=\bbx, inner ysep=\bby}}}
    },
    bbx/.store in=\bbx,
    bbx = 1.5cm,
    bby/.store in=\bby,
    bby = 1.75ex,
    bb port sep/.store in=\bbportsep,
    bb port sep=2,
% bb wire sep/.store in=\bbwiresep,
% bb wire sep=1.75ex,
    bb port length/.store in=\bbportlen,
    bb port length=4pt,
    bb min width/.store in=\bbminwidth,
    bb min width=1cm,
    bb rounded corners/.store in=\bbcorners,
    bb rounded corners=2pt,
    bb small/.style={bb port sep=1, bb port length=2.5pt, bbx=.4cm, bb min width=.4cm, bby=.7ex},
    bb/.code 2 args={%When you see this key, run the code below:
        \pgfmathsetlengthmacro{\bbheight}{\bbportsep * (max(#1,#2)+1) * \bby}
        \pgfkeysalso{draw,minimum height=\bbheight,minimum width=\bbminwidth,outer sep=0pt,
            rounded corners=\bbcorners,thick,
            prefix after command={\pgfextra{\let\fixname\tikzlastnode}},
            append after command={\pgfextra{\draw
            \ifnum #1=0{} \else foreach \i in {1,...,#1} {
                ($(\fixname.north west)!{\i/(#1+1)}!(\fixname.south west)$) +(-\bbportlen,0) coordinate (\fixname_in\i) -- +(\bbportlen,0) coordinate (\fixname_in\i')}\fi %Define the endpoints of tickmarks
            \ifnum #2=0{} \else foreach \i in {1,...,#2} {
                ($(\fixname.north east)!{\i/(#2+1)}!(\fixname.south east)$) +(-\bbportlen,0) coordinate (\fixname_out\i') -- +(\bbportlen,0) coordinate (\fixname_out\i)}\fi;
            }}}
    },
    bb name/.style={append after command={\pgfextra{\node[anchor=north] at (\fixname.north) {#1};}}}
}

\tikzset{
    tick/.style={postaction={
        decorate,
        decoration={markings, mark=at position 0.5 with {\draw[-] (0,.4ex) -- (0,-.4ex);}}}
    }
}


\newcommand{\includesag}[1]{%
    \ifthenelse{\boolean{cachepdf}}{%
    % \adjustbox{max width=\textwidth}{%
        \scalebox{0.8}{\includegraphics{sag/#1.pdf}}%
    % }%
    }{%
    % \adjustbox{max width=\textwidth}{%
    \scalebox{0.8}{
        \input{sag/#1.tikz}}%
    % }%
    }%
    \ifthenelse{\boolean{debugimages}}{%
        \ \ {\footnotesize{\texttt{\detokenize{#1}}}}%
    }{}%
}


