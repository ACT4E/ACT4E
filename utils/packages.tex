% !TEX root = ../ACT4E-devel-fast.tex

\usepackage[english]{babel} % Load characters and hyphenation
\usepackage[style=russian]{csquotes}

% Load packages for testing
% Load the bibliography package
% \usepackage{styles/kaobiblio}
% \addbibresource{main.bib} % Bibliography file

% \usepackage{styles/mdftheorems}

% \usepackage{styles/kaorefs}

%%% HACKS for kaobook

\let\providelength\relax
\let\openbox\relax

%\newcommand*\flrow@error[1]{\PackageError\flrow@package{#1}\flrow@eh}
\makeatletter
\renewcommand\flrow@error[1]{}
\makeatother

\usepackage{xr}
\usepackage[usenames,dvipsnames,table]{xcolor}

%\WarningsOff[contour]
\usepackage[outline]{contour}

%
\RedeclareSectionCommand[
    beforeskip=10pt,
    afterskip=0pt,
    %  headings=normal,
    style=chapter% no part page
]{part}

%
\RedeclareSectionCommand[
    beforeskip=10pt,
    afterskip=5pt,
    %  headings=normal,
    style=section% no part page
]{section}

%\usepackage{scrpage2}  %<---
\usepackage{scrlayer-scrpage}

%\usepackage[table,svgnames]{xcolor}

\usepackage{pdfpages}
\setlength\parindent{0pt}
\setlength\parskip{3pt}
% used for printing 400 page book
% \usepackage[width=6in, height=9in, top=1.8cm,  bottom=0.8cm,  outer=0.8cm, inner=2.0cm]{geometry}
% used for printing on feb14 (soft + hardcover)
%\usepackage[width=6in, height=9in, top=1.95cm,  bottom=0.95cm,  outer=1.1cm, inner=1.4cm]{geometry}

% trying to go 8x10
%\usepackage[width=8.125in, height=10.250in, top=1.95cm,  bottom=0.95cm,  outer=1.8cm, inner=1.6cm]{geometry}

%\usepackage[width=8.125in, height=10.250in, top=1.95cm, textwidth=10cm, bottom=0.95cm,  outer=1.8cm, inner=1.6cm]{geometry}

% showframe shows the useful margins
% I wish it to make it gray but cannot
% find the way
% https://tex.stackexchange.com/questions/164521/change-color-pitch-line-style-of-showframe-geometry-package

\pagenumbering{arabic}

\renewcommand{\thepart}{\Alph{part}}

\usepackage{marginnote}

\usepackage{fancyvrb}
\newcommand{\outsnippet}[3]{
    \UseVerbatim{#1}
}

\usepackage[backend=bibtex]{biblatex}
\addbibresource{\rootdir/dpcatbib.bib}

\usepackage{ifthen}
\usepackage{iftex}
\usepackage{ifxetex}
\ifxetex
\else
    \usepackage[utf8]{inputenc}
\fi

\usepackage{subcaption}

\usepackage{blkarray, array}


\newcolumntype{L}[1]{>{\raggedright\arraybackslash}m{#1}}   % Left, Middle Align
\newcolumntype{C}[1]{>{\centering\arraybackslash}m{#1}}    % Center, Middle Align
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}m{#1}}   % Right, Middle Align


\usepackage[T1]{fontenc}
\usepackage{lipsum}
\usepackage{xspace}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage[capitalize]{cleveref} % Note: this needs to be just after amsthm
\usepackage{amssymb} % conflict with mathdesign
\usepackage{mathtools}

\usepackage{multirow}
\usepackage{prftree}

\setlength{\prflinepadbefore}{0.9ex}
\setlength{\prflinepadafter}{0.6ex}
\setlength{\prflinethickness}{1.5pt}
\setlength{\prfdoublelineinterspace}{0.2pt}
\usepackage{comment}
\usepackage{accents}

\usepackage{ebproof}
\usepackage{units}

\presetkeys{todonotes}{inline}{}
%\presetkeys{todonotes}{noinline}{}
%\presetkeys{todonotes}{size}{\tiny}

\usepackage{pgfplots}
\pgfplotsset{compat=1.16}
% \pgfplotsset{compat=1.17}
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{graphicx}
\usepackage{array}
\usepackage{calc}


\usepackage{adjustbox}
% means all figures need to be placed before next section starts
\usepackage[section]{placeins}
\usepackage{eso-pic}
\usepackage{capt-of}
\usepackage{wrapfig}
\usepackage[normalem]{ulem}
% \usepackage{newclude} % this broke 2024

% \usepackage{breqn} % doesn't work for us
%%%% FONTS
\usepackage[notextcomp]{stix2}


\newboolean{paperslides}

\usepackage{skull} % skull
% \usepackage{fdsymbol} % heart, spades, ...
% \usepackage{txfonts}
% \usepackage{mathrsfs} % conflict with mathdesign
%\ifbool{paperslides}{

%\let\with\undefined
%\usepackage{cmll}
\usepackage{stmaryrd}

\usepackage{pifont}
% \usepackage[utopia]{mathdesign} % conflict with mathrsfs
\usepackage{relsize}

\usepackage{makeidx}

\usepackage{longtable}

\usepackage{multicol}

\usepackage{caption}
\usepackage{transparent}
\usepackage{datetime2}
\usepackage{anyfontsize}
\usepackage{ifmtarg}

% \let\BreakableUnderscore\relax
% \usepackage{underscore}



% Note we need to add also relative paths for the tiks in sag to compile independently .
\graphicspath{
    {\rootdir/figures/},
    {\rootdir/pics/},
    {\rootdir/slides/},
    {\rootdir/videos/generated/},
    {\rootdir/figures/reits/},
    {\rootdir/figures/firstpaper/},
    {\rootdir/figures/uncertainty/},
    {\rootdir/papers/uncertainty/},
    {},
    {../}}
\providecommand{\tabularnewline}{\\}
\providecommand{\acronym}[1]{\textsc{#1}\xspace}

%%%%%%%%%%%%%%%%%%%%% Typography / fonts

%\usepackage[tracking=true,kerning=true,spacing=true,final,factor=1100]{microtype}

%\ifxetex
%% \usepackage{fontspec}
%% \usepackage[protrusion=true,tracking=false,kerning=false,spacing=false]{microtype}
%\usepackage[protrusion=true,tracking=false,kerning=false,spacing=false]{microtype}
%\else
%
%\usepackage[tracking=true,kerning=true,spacing=true,final,factor=1100]{microtype}
%
%% This is the most stretched...
%% \usepackage[activate={true,nocompatibility},tracking=false,kerning=true,spacing=true,stretch=30,final,babel,factor=1100]{microtype}
%\pdfprotrudechars=2
%\pdfadjustspacing=2
%% \newfontfeature{Microtype}{protrusion=default;expansion=default;}
%% \directlua{fonts.protrusions.setups.default.factor=.5}
%
%\fi

% % cache the tikz
%\usetikzlibrary{external}
%\tikzexternalize[prefix=tikz-cache/]

\makeindex

%\usepackage{fontawesome}
%\def\faBtc{\FA\symbol{"F15A}}
%\usepackage{eurosym}
%\let\EUR\relax

\newcommand{\pointsize}{0.06}

\newboolean{statuscolors}
\newboolean{instructors}
\newboolean{video}
\newboolean{showslides} % show slides-only materials
\newboolean{showproofs}
\newboolean{debugimages}
\newboolean{cachepdf}
\newboolean{devel} % print devel stuff
\newboolean{notproposal} % things to include in the book proposal
\setboolean{notproposal}{true}
\newboolean{codeexercises}
\newboolean{githublink}

\newcommand{\instructors}[1]{\ifbool{instructors}{%
        %    {\color[rgb]{0,0,0.3}\sffamily
        #1
        %  \pagecolor{LightGreen!20}
        %  \clearpage
        %\pagecolor{white}
        %  }
    }{}}

\newcommand{\showslides}[1]{\ifbool{showslides}{#1}{}}
\newcommand{\devel}[1]{\ifbool{devel}{%
        \clearpage
        \pagecolor{yellow!7}
        #1
        \clearpage
        \pagecolor{white}
    }{}
}

\newcommand{\notproposal}[1]{\ifbool{notproposal}{#1}{}}

\newcommand{\toexclude}[1]{\ifbool{devel}{%
        \clearpage
        \pagecolor{gray}
        %  \textbf{From here is under development}
        #1
        %\vfill
        %\textbf{To here is under development}%
        \clearpage
        \pagecolor{white}
    }{}
}
\AtBeginDocument{
    \ifbool{devel}{
        \overfullrule=10mm
    }{}
}

\newcommand{\codeexercises}[1]{%
    \ifbool{codeexercises}{%
        \FloatBarrier
        \clearpage
        \pagecolor{blue!7}
        %  \textbf{From here is under development}
        #1
        %\vfill
        %\textbf{To here is under development}%
        \clearpage
        \pagecolor{white}
    }{}%
}

% Typesetting

\newcommand*{\vcenteredhbox}[1]{\begingroup
    \setbox0=\hbox{#1}\parbox{\wd0}{\box0}\endgroup}

\newcommand{\captionsideleft}[2]{
    \medskip
    \begin{minipage}{1.8cm}{
            \hfill
            \protect\captionof{figure}{#1}}\end{minipage}
    \begin{minipage}{6.6cm}
        \vcenteredhbox{{#2}}
        \hfill
    \end{minipage}
    \medskip
}

\def\currentchapter{}
\def\currentchaptername{}
\newcommand{\chaptersecond}[4]{
    \ifemptyarg{#3}{
        \PackageError{ACT4E}{Empty label argument}{You passed empty label}
    }{}
    \setchapterpreamble[u]{\margintoc}
    \setchapterimage[12cm]{#2.cropped}
    \chapter{#1}
    \begin{quote}
        #4%
    \end{quote}%
    \vfill
    \begin{widepar}
        \footnotesize
        \input{\rootdir/pics/#2.tex}
    \end{widepar}
    \def\currentchapter{#3}
    \def\currentchaptername{\detokenize{#1}}
}


\setcounter{margintocdepth}{\sectiontocdepth}

\newlength\tocrulewidth
\setlength{\tocrulewidth}{1.5pt}
% \usepackage{eso-pic}
% \AddToShipoutPictureFG{
%   \AtPageUpperLeft{%
%     \raisebox{-\height}{%
%       \fbox{everypage}%
%     }%
%   }%
% }
\newcommand{\partfirstb}[4]{
    \part{#1}%
    \ifemptyarg{#3}{
        \PackageError{ACT4E}{Empty label argument}{You passed empty label}%
    }{
        \label{#3}%
    }
    \begin{tikzpicture}
        [remember picture,overlay,shift={(current page.north east)}]
        \node[anchor=north east,xshift=5mm,yshift=-3.4cm]{
            \includegraphics[width=\paperwidth+5mm,keepaspectratio=true]{#2.cropped}%
        };
    \end{tikzpicture}
    \vspace{12.4cm}
    #4
    \etocsettocstyle{\rule{\linewidth}{\tocrulewidth}\vskip0.2\baselineskip}{\rule{\linewidth}{\tocrulewidth}}
    \etocsetnexttocdepth{chapter}
    \vfill
    \begin{widepar}
        \localtableofcontents
    \end{widepar}
    \vfill
    \begin{widepar}
        \footnotesize
        \input{\rootdir/pics/#2.tex}
    \end{widepar}
}

\newcommand{\tableColors}{\rowcolors{2}{green!4}{blue!4}}
\newcommand{\tableColorsTwo}{\rowcolors{3}{green!4}{blue!4}}

\newlength{\dpiconwidth}
\setlength{\dpiconwidth}{1.1cm}


\newcommand{\nomencsectionname}[1]{\rule{0pt}{4mm}\textbf{#1}}
\newcommand{\nomencsubsectionname}[1]{\rule{0pt}{4mm}\emph{#1}}
\newcommand{\unused}{{\color{red}unused}~}

% % just to quiet a warning
% \Crefname{BackrefHyperFootnoteCounter}{-}{-}
%
% % only make equations ref say (1) rather than Eq. (1)
% \crefformat{equation}{(#2#1#3)}
% % except start sentence
% \Crefformat{equation}{Equation~(#2#1#3)}

\usepackage{bbding}

% to avoid page break after part
\makeatletter
\def\@endpart{ }

\makeatother

\newcommand{\partended}{
    \cleardoublepage
    \oldsection*{Solutions to selected exercises}
    \printsolutions}

\newenvironment{longcode}{\captionsetup{type=listing,justification=centering}}{}

\usepackage[outer]{showlabels}
%
%\AtBeginDocument{
%\renewcommand{\showlabels}[1]{}
%}

\renewcommand{\showlabelfont}{%
    \footnotesize\color{gray}%
}

\allowdisplaybreaks[4]

\AtBeginDocument{
    \etocsetnexttocdepth{section}
}

\newcommand{\punctuate}{
    \todotextjira{381}{@Gioele: punctuate equations}
}

% \usepackage[color=blue,
%             width=3pt,
%             height=0.5\baselineskip]{overcolored}
% \overfullrule=5pt

% \usepackage{breqn}
%
% \makeatletter
% \newcommand*{\currentname}{\@currentlabelname}
% \makeatother

\setitemize{leftmargin=*}
\setenumerate{leftmargin=*}
\def\urlnl{\%0A}
\def\urlsp{\%20}
% \def\issuecheck{-\urlsp[\urlsp]\urlsp} % these are seen as tasks
\def\issuecheck{-\urlsp(\urlsp)\urlsp}
\newsavebox{\urlbox}

%%%%%%%%%%%%%%%%%%%%
% Add page break before section
%

\def\tmpname{}
\def\tmpnameb{}
\makeatletter
\newcommand{\ifemptyarg}[3]{
    \@ifmtarg{#1}{%
        #2%
    }{
        #3%
    }%
}
\makeatother

\AtBeginDocument{
    \savebox{\urlbox}{}
    \let\oldsection\section
    % \renewcommand\section{\FloatBarrier\clearpage\oldsection}
    %
    \renewcommand{\section}[2][]{
        \FloatBarrier\clearpage%
        \savebox{\urlbox}{%
            \footnotesize
            \def\tmpname{\ifemptyarg{#1}{\detokenize{#2}}{\detokenize{#1}}}
            \def\tmpnameb{\currentchaptername}
            Something incorrect or unclear or missing?
            \href{https://github.com/ACT4E/ACT4E/issues/new?labels=\currentchapter;body=Chapter:\urlsp\currentchaptername\urlnl Section:\urlsp\tmpname\urlnl Version:\urlsp\today\urlnl\urlnl Check\urlsp all\urlsp that\urlsp apply:\urlnl\issuecheck Something\urlsp incorrect\urlnl\issuecheck Something\urlsp not\urlsp clear\urlnl\issuecheck Something\urlsp missing\urlnl\urlnl Please\urlsp describe\urlsp more\urlsp in\urlsp detail\urlsp below.\urlsp Feel\urlsp free\urlsp to\urlsp change\urlsp the\urlsp title\urlsp to\urlsp something\urlsp more\urlsp informative.\urlnl;title=\currentchaptername\urlsp/\urlsp\tmpname\urlsp/\urlsp\today}{Report issues on GitHub by clicking here}.
        }%
        \ifemptyarg{#1}{%
            \oldsection{#2}%
        }{
            \oldsection[#1]{#2}%
        }%
    }

}

\newcommand{\linkgithub}{
    \ifbool{githublink}{%
        \usebox{\urlbox}%
    }{}
}
\newcommand{\draftnotice}{
    \ifbool{githublink}{%
        \footnotesize You are reading a draft compiled on \DTMnow%
    }{}%
}

\renewpagestyle{scrheadings}{%
    {\smash{\hspace{-\headmarginparwidth}\hspace{-\headmarginparsep}\makebox[\headtotal][l]{%
                    \makebox[7\hscale][r]{\thepage}%
                    \makebox[3\hscale]{}\rule[-1mm]{0.5pt}{19\vscale-1mm}\makebox[3\hscale]{}%
                    \makebox[\headtextwidth][l]{\leftmark}}}}%
        {\smash{\makebox[0pt][l]{\makebox[\headtotal][r]{%
                        \makebox[\headtextwidth][r]{\hfill\rightmark}%
                        \makebox[3\hscale]{}\rule[-1mm]{0.5pt}{19\vscale-1mm}\makebox[3\hscale]{}%
                        \makebox[7\hscale][l]{\thepage}}}}}%
        {\smash{\makebox[0pt][l]{\makebox[\headtotal][r]{%
                        \makebox[\headtextwidth][r]{\hfill\rightmark}%
                        \makebox[3\hscale]{}\rule[-1mm]{0.5pt}{19\vscale-1mm}\makebox[3\hscale]{}%
                        \makebox[7\hscale][l]{\thepage}}}}}%
}{%
    {\hspace{-5cm}\draftnotice}% left page
        {\linkgithub}% right page
        {}% not showing up
}

% Checkmarks
\newcommand{\cmark}{\ding{51}}%
\newcommand{\xmark}{\ding{55}}%

% Give the right spacing for set relations + add possibility of line break
\let\oldsubseteq\subseteq
\renewcommand{\subseteq}{\mathrel{\oldsubseteq}\linebreak[0]}
\let\oldsupseteq\supseteq
\renewcommand{\supseteq}{\mathrel{\oldsupseteq}\linebreak[0]}
\let\oldsubset\subset
\renewcommand{\subset}{\mathrel{\oldsubset}\linebreak[0]}
\let\oldsupset\supset
\renewcommand{\supset}{\mathrel{\oldsupset}\linebreak[0]}

% Hyphenation parameters
\emergencystretch=0pt
\righthyphenmin=4
\lefthyphenmin=4

% Verbose reference format
\newcommand{\refplus}[1]{\cref{#1} - \nameref{#1}}
% Workaround for chapter and part
\newcommand{\chrefplus}[1]{Chapter~\ref{#1} - \nameref{#1}}
\newcommand{\partrefplus}[1]{Part~\ref{#1} - \nameref{#1}}
\AtBeginDocument{
    % \let\cref\vref
    % Too strong, applies also to equations
}

% Disable warning from including SAG
\pdfsuppresswarningpagegroup=1
% Speed up compilation by not compressing
% \pdfcompresslevel=0
% \pdfobjcompresslevel=0

% https://tex.stackexchange.com/questions/528604/fix-inconsistent-matrix-parentheses-size-in-stix2

\delimiterfactor=900
\delimitershortfall=8pt

\usepackage{filemod}

\usepackage{trimclip}


% \usepackage{courier}
% \usepackage[scaled]{ulgothic}
% \usepackage[zerostyle=d]{newtxtt}
% \renewcommand*\ttdefault{lmvtt}

% \newcommand\hmmax{0}
% \newcommand\bmmax{0}

% \usepackage{bm}
% \DeclareMathAlphabet{\mathbbm}{U}{bbm}{m}{n}
% \usepackage{xpatch}
% \WarningsOff[hyperref]
% \usepackage{bm}
% \usepackage{amsbsy}
% \usepackage{multicol} % added package
% \usepackage{tcolorbox}
