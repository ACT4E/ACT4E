% !TEX root = chapter-standalone.tex

\todojira{201}{Change example}

\begin{example}
    Consider a vehicle motor that weighs a certain amount but can also carry some weight (\cref{fig:examplefeedback}).
    \begin{figure}[h!]
        \centering
        \includesag{50_motor1}
        \caption{Example of feedback in design problems.}
        \label{fig:examplefeedback}
    \end{figure}
    In the diagram, we haven't added anything to the weight of the motor, so currently the only thing the motor is carrying is itself.
    Also, note that we are considering~$\text{CO}_2\op$ since we want to optimize toward \emph{less} CO$_2$.
    Fix a given amount of CO$_2$ and fuel.
    In that case, closing the loop corresponds to drawing a line~$(c^\ast = c)$ in the graph of~$\text{weight}\op \cartprod \text{weight}$ and taking only solutions under the line in \cref{fig:weightcarrier}.

\end{example}
\begin{figure}[h!]
    \centering
    \includesag{50_carrier}
    \caption{The shaded area marks a portion of the feasibility set of a traced design problem, `motor'.
        Note that it is not an upper set in the subspace ``weight $\cartprod$ weight'' of `motor'.
    }

    \label{fig:weightcarrier}

\end{figure}

Note that the shaded area is \emph{not} an upper set.
This is admissible, since the actual feasible set of `motor' is a subset of CO$_2 \cartprod$ fuel, and there, it is an upper set.

Suppose that we are given a design problem with a resource and a functionality of the same type~$\posgenC$ (\cref{fig:extrace_1}).

\begin{figure}[h!]
    \centering
    \includesag{50_trace}
    \caption{Design problem with a resource and a functionality of the same type.
    }
    \label{fig:extrace_1}
\end{figure}

Can we ``close the loop'', as in the diagram reported in~\cref{fig:extrace_2}?
\begin{figure}[h!]
    \centering
    \includesag{50_trace2}
    \caption{Closing the loop in the design problem.}
    \label{fig:extrace_2}
\end{figure}

It turns out that we can give a well-defined semantics to this loop-closing operation, which coincides with the notion of a \emph{trace} in category theory.

The following is the formal definition of the trace operation for design problems.

\linkvideo{spring2021-functorial-comp-b:solving-queries:solving-loop} % Loop composition
\begin{definition}[Trace of a design problem]
    \label{def:dp-trace}
    Given a design problem~$\adpa\colon \funposA \cartprod \funposC \profto \resposB \cartprod \resposC$, its \emph{trace}
    \begin{equation}
        \Tr_{\funposA,\resposB}^\posC(\adpa) \colon \funposA \profto \resposB
    \end{equation}
    is defined as follows:
    %
    \begin{equation}
        \label{eq:tracedef}
        \begin{aligned}
            \Tr_{\funposA,\resposB}^\posC(\adpa) \colon  \funposA\op \cartprod \resposB & \toinPos \Bool,                           \\
            \tup{\funposAopel, \R{\posgenBel}}                                          & \mapsto \bigvee_{\posgenCel \in \posgenC}
            \adpa(\tup{\F{\posgenAel}, \F{\posgenCel}}^\F{*},
            \tup{\R{\posgenBel}, \R{\posgenCel}}).
        \end{aligned}
    \end{equation}
\end{definition}

Think of drawing a loop as a way of writing down the following requirement:
Something that produces~$\posC$ should not use up more of~$\posC$ than it produces.

\todotextjira{164}{The following section/paragraph on trace axioms needs attention: we don't use quite the same axioms in our definition of traced monoidal category as are used below in the context of DP.
    I suggest we keep the definition of traced monoidal category that we currently have and change/add diagrams below for DP and/or add a remark.
}

\paragraph{Trace axioms}
We will show that the loop operation~$\Tr_{\funposA,\resposB}^\posC$ corresponds to the \emph{trace} in~\DP.
Intuitively, forming a loop models the idea of feedback in a control-theoretic setting--the output of a process influences the choice of input--
while the idea of ``trace'' of a monoidal category comes from the trace of a square matrix~$(\Tr\mat{A} = \sum_i a_{ii})$, which defines the categorical trace in the (monoidal) category of vector spaces, as previously shown.
The connection between the two is more apparent if one decomposes the trace of a square matrix as a set of properties that any linear map from a space to itself should satisfy.
One can find the trace axioms in  \cite{mac2013categories};
these are equivalent to certain diagrammatic conditions \cite{joyal96}, as in \cref{tab:traceaxioms}.

\begin{table}[h!]
    \begin{center}
        \adjustbox{max width=\textwidth}{
            \begin{tabular}{cc}
                Vanishing I                     & Vanishing II                    \\
                \includesag{50_vanishing_1a_1b} & \includesag{50_vanishing_2a_2b} \\
                Superposing                     & Yanking                         \\
                \includesag{50_superposing_1_2} & \includesag{50_yanking}
            \end{tabular}
        }
    \end{center}
    \caption{The trace axioms in diagrammatic form from \cite{joyal96} in \DP.
        \label{tab:traceaxioms}}
\end{table}

\begin{lemma}
    Trace as in~\cref{def:dp-trace} satisfies the trace axioms.
    In other words,~$\tupp{\DP, \otimes, \singleton, \sigma}$ is a traced monoidal category, with trace as in~\cref{eq:tracedef}.
\end{lemma}
\begin{proof}
    We have already shown that~$\tup{\DP,\otimes,\singleton,\sigma}$ is a symmetric monoidal category (\cref{lem:symmetricmonoidaldp}).
    We prove the trace axioms one by one, starting from vanishing (\cref{eq:vanishing_1}, \cref{eq:vanishing_2}).
    Given any~$\posgenA,\posgenB\in \Obof\DP$ and~$\adpa\colon \F{\posgenA}\cartprod \F{\singleton}\profto \R{\posgenB}\cartprod \R{\singleton}$ in~\DP, we have
    \begin{equation}
        \begin{aligned}
            \Tr_{\F{\posgenA},\R{\posgenB}}^{\singleton}(\adpa)(\F{\posgenAel^*},\R{\posgenBel}) & =\bigvee_{\posCel\in \singleton}\adpa(\tup{\F{\posgenAel},\F{\posgenCel}}^\F{*},\tup{\R{\posgenBel},\R{\posgenCel}}) \\
                                                                                                 & =\adpa(\tup{\F{\posgenAel},\F{\singletonel}}^\F{*},\tup{\R{\posgenBel},\R{\singletonel}})                            \\
                                                                                                 & =\adpa(\F{\posgenAel^*},\R{\posgenBel}).
        \end{aligned}
    \end{equation}
    Furthermore, for any morphism~$\adpa\colon \F{\posgenA}\cartprod \F{\posgenX}\cartprod \F{\posgenY} \profto \R{\posgenB}\cartprod \R{\posgenX} \cartprod \R{\posgenY}$ in \DP, one has
    \begin{equation}
        \begin{aligned}
            \Tr_{\F{\posgenA},\R{\posgenB}}^{\posX\cartprod \posY}(\adpa)(\F{\posgenAel^*},\R{\posgenBel}) & =
            \bigvee_{\tup{\posXel,\posYel} \in \posX\cartprod \posY} \adpa(\tup{\F{\posgenAel},\F{\posgenXel},\F{\posgenYel}}^\F{*},\tup{\R{\posgenBel},\R{\posgenXel},\R{\posgenYel}})                                                                                                              \\
                                                                                                           & =\bigvee_{\posXel \in \posX}\left(\bigvee_{\posYel \in \posY} \adpa(\tup{\F{\posgenAel},\F{\posgenXel},\F{\posgenYel}}^\F{*},\tup{\R{\posgenBel},\R{\posgenXel},\R{\posgenYel}})\right) \\
                                                                                                           & =\Tr_{\F{\posgenA},\R{\posgenB}}^\posX\left(
            \Tr_{\F{\posgenA}\cartprod \F{\posgenX},\R{\posgenB}\cartprod \R{\posgenX}}^\posY(\adpa)(\tup{\F{\posgenAel},\F{\posgenXel}}^\F{*},\tup{\R{\posgenBel},\R{\posgenXel}})\right).
        \end{aligned}
    \end{equation}
    For the superposing axiom (\cref{eq:superposing}), consider~$\adpa\colon \F{\posgenA}\cartprod \F{\posgenX}\profto \R{\posgenB}\cartprod \R{\posgenX}$ in \DP.
    One has
    \begin{equation}
        \begin{aligned}
        {}&
            \Tr_{\R{\posgenC}\cartprod \F{\posgenA},\R{\posgenC}\cartprod \R{\posgenB}}^{\posX}(\id_\posC\mtimescat \adpa)(\tup{\F{\posgenCel_1},\F{\posgenAel}}^\F{*},\tup{\R{\posgenCel_2},\R{\posgenBel}})\\ & =
            \bigvee_{\posXel \in \posX} \id_\posC(\F{\posgenCel_1^*},\R{\posgenCel_2})\booland \adpa(\tup{\F{\posgenAel},\F{\posgenXel}}^\F{*},\tup{\R{\posgenBel},\R{\posgenXel}})                                                                                                                                                                                                      \\
                                                                                                                                                                                                              & =\id_\posC(\F{\posgenCel_1^*},\R{\posgenCel_2}) \booland \bigvee_{\posXel\in \posX} \adpa(\tup{\F{\posgenAel},\F{\posgenXel}}^\F{*},\tup{\R{\posgenBel},\R{\posgenXel}}) \\
                                                                                                                                                                                                              & =(\id_\posC \mtimescat \Tr_{\F{\posgenA},\R{\posgenB}}^\posX(\adpa))(\tup{\F{\posgenCel_1},\F{\posgenAel}}^\F{*},\tup{\R{\posgenCel_2},\R{\posgenBel}}).
        \end{aligned}
    \end{equation}
    Finally, for yanking~\cref{eq:yanking} consider~$\sigma_{\posX,\posX}$.
    One has
    \begin{equation}
        \begin{aligned}
            \Tr_{\posA,\posA}^{\posA}(\sigma_{\posA,\posA})(\F{\posgenAel_1^*},\R{\posgenAel_2}) & =
            \bigvee_{\posAel\in \posA} \sigma_{\posA,\posA}(\tup{\F{\posgenAel_1},\F{\posgenAel}}^\F{*},\tup{\R{\posgenAel},\R{\posgenAel_2}})                                                                         \\
                                                                                                 & =\bigvee_{\posAel\in \posA} \F{\posgenAel_1} \posleq \R{\posgenAel_2} \booland \F{\posgenAel}\posleq \R{\posgenAel} \\
                                                                                                 & =\bigvee_{\posAel\in \posA} \F{\posgenAel_1} \posleq \R{\posgenAel_2}                                               \\
                                                                                                 & =\id_\posA(\F{\posgenAel_1^*},\R{\posgenAel_2}).
        \end{aligned}
    \end{equation}
\end{proof}
