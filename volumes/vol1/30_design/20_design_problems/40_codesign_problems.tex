% !TEX root = chapter-standalone.tex

\section{Co-design problems}
\label{sec:Co-design-problems}

A ``co-design problem'' will be defined as a \emph{multigraph} of design problems.
\begin{definition}[Co-design problem with implementation]
    \label{def:cdpi}
    A \emph{Co-Design Problem with Implementation} (CDPI) is a tuple~$\tup{\funsp,\ressp,\tup{\cdpiN,\cdpiE}}$, where~\funsp and~\ressp are two posets, and~$\tup{ \cdpiN,\cdpiE}$ is a multigraph of DPIs.
    Each node~$\adp\setin\cdpiN$ is a DPI~$\adp=\tup{\funsp_{\adp},\ressp_{\adp},\impsp_{\adp},\prov_{\adp},\req_{\adp}}.
    $
    An edge~$\cdpie\setin\cdpiE$ is a tuple $\cdpie=\tup{ \tup{ \adp_1,\cdpiresindA} ,\tup{\adp_2,\cdpifunindB}}$, where~$\adp_1,\adp_2\setin\cdpiN$ are two nodes and~$\cdpiresindA$ and~$\cdpifunindB$ are the indices of the components of the functionality and resources to be connected, and it holds that~$\pi_{\cdpiresindA}\ressp_{\adp_1}=\pi_{\cdpifunindB}\funsp_{\adp_2}$~(\cref{fig:mcdps}).

\end{definition}

\begin{figure}[h]
    \centering
    %\includegraphics[scale=0.33]{gmcdptro_cdpi}
    \includesag{gmcdptro_cdpi}
    \caption{}
    \label{fig:mcdps}
\end{figure}

A CDPI is equivalent to a DPI with an implementation space~\impsp that is a subset of the product $\prod_{\adp\setin\cdpiN}\impsp_{\adp}$, and contains only the tuples that satisfy the co-design constraints.
An implementation tuple~$\imp\setin\prod_{\adp\setin\cdpiN}\impsp_{\adp}$
belongs to~\impsp iff it respects all functionality--resources constraints on the edges, in the sense that, for all edges~$\tup{\tup{ \adp_1,\cdpiresindA} ,\tup{\adp_2,\cdpifunindB}}$
in~$\cdpiE$, it holds that
\begin{equation}
    \pi_{\cdpiresindA}\req_{\adp_1}(\pi_{\adp_1}\imp)\posleq\pi_{\cdpifunindB}\prov_{\adp_2}(\pi_{\adp_2}\imp).
\end{equation}
The posets~$\funsp,\ressp$ for the entire CDPI are the products of the functionality and resources of the nodes that remain \emph{unconnected}.
For a node~$\adp$, let~$\unconnectedfun_{\adp}$ and~$\unconnectedres_{\adp}$ be the set of unconnected functionalities and resources.
Then~$\funsp$ and~$\ressp$ for the CDPI are defined as the product of the unconnected functionality and resources of all DPIs: $\funsp=\prod_{\adp\setin\cdpiN}\prod_{\cdpifunind\setin\unconnectedfun_{\adp}}\pi_{\cdpifunind}\funsp_{\adp}$ and~$\ressp=\prod_{\adp\setin\cdpiN}\prod_{\cdpiresind\setin\unconnectedres_{\adp}}\pi_{\cdpiresind}\ressp_{\adp}.
$
The maps~$\prov,\req$ return the values of the unconnected functionality and resources:
\begin{equation}
    \begin{aligned}
        \prov\colon \imp & \mapsto{\scriptstyle {\displaystyle \prod_{\adp\setin\cdpiN}\prod_{\cdpifunind\setin\unconnectedfun_{\adp}}}}\pi_{\cdpifunind}\prov_{\adp}(\pi_{\adp}\imp), \\
        \req\colon \imp  & \mapsto{\displaystyle \prod_{\adp\setin\cdpiN}\prod_{\cdpiresind\setin\unconnectedres_{\adp}}}\pi_{\cdpiresind}\req_{\adp}(\pi_{\adp}\imp).
    \end{aligned}
\end{equation}

\begin{figure}
    \centering
    %\includegraphics[scale=0.33]{unc_atoms_g_v_graph}
    \includesag{unc_atoms_g_v_graph}
    \caption{Example of interconnection of 3 DPs}
    \label{fig:exampleq}
\end{figure}
\begin{example}
    The CDPI in~\cref{fig:exampleq} is the interconnection of 3 DPs~$\adpa,\adpb,\adpc$.
    The implementation space is a subset of the product
    \begin{equation}
        \impsp_\adpa \cartprod  \impsp_\adpb \cartprod \impsp_\adpc.
    \end{equation}
    The elements $\tupp{\imp_\adpa, \imp_\adpb, \imp_\adpc}$ that are feasible are the ones that respect the following constraints:
    \begin{enumerate}
        \item Functionality and resources of each DPI are given by their implementation:
              \begin{align}
                  \res_\adpa & = \req(\imp_\adpa), \\
                  \res_\adpb & = \req(\imp_\adpb), \\
                  \res_\adpc & = \req(\imp_\adpc), \\
                  \fun_\adpa & = \prov(\imp_\adpa), \\
                  \fun_\adpb & = \prov(\imp_\adpb), \\
                  \fun_\adpc & = \prov(\imp_\adpc).
              \end{align}
        \item Wiring constraints:
              \begin{align}
                  \tupp{\fun_{\adpa,1}, \fun_{\adpa_2}}  = \fun_\adpa, \\
                  \res_{\adpb,\adpc}=\tup{\res_\adpb,\res_\adpc}, \\
                  \fun_{\adpb,\adpc}=\tup{\fun_\adpb,\fun_\adpc}.
              \end{align}
        \item Co-design constraints:
              \begin{align}
                  \res_{\adpb,\adpc}\posleq \fun_{\adpa,1}, \\
                  \res_\adpa \posleq \fun_{\adpb,\adpc}.
              \end{align}
    \end{enumerate}
\end{example}

\subsection{Expressivity of design problems}

The results are significant because CDPIs induce a rich family of optimization problems.

We are not assuming, let alone strong properties like convexity, even weaker properties like differentiability or continuity of the constraints.
In fact, we are not even assuming that functionality and resources are continuous spaces; they could be arbitrary discrete posets.
(Indeed, in that case, completeness and \scottcontinuity are trivially satisfied.)

Moreover, even assuming topological continuity of all spaces and maps considered, CDPIs are strongly not convex.
What makes them nonconvex is the possibility of introducing feedback interconnections.
To show this, we will give an example of a 1-dimensional problem with a continuous~\ftor for which the feasible set is disconnected (and in particular non-convex).

\begin{marginfigure}
    \centering
    %\subfloat[\label{fig:Simple-DP}]{\centering{}\includegraphics[scale=0.43]{gmcdptro_nonconvex1b}}
    \subfloat[\label{fig:Simple-DP}]{\centering{}\includesag{simple-dp-nonconvex}} \\
    \subfloat[\label{fig:nonconvex3}]{\centering{}\includegraphics[scale=0.43]{gmcdptro_nonconvex3}}
    \caption{One feedback connection and a topologically continuous~\ftor are sufficient to induce a disconnected feasible set.}
    \label{fig:ceil-1}
\end{marginfigure}

\begin{example}[Non-convexity]
    \label{exa:one}
    Consider the CDPI in \cref{fig:Simple-DP}.
    The \uline{m}inimal resources~$M\setsubseteq$ are the objectives of this optimization problem:
    \begin{equation}
        M\definedas
        \begin{cases}
            \with          & \fun,\res\setin\funsp=\ressp, \\
            \Min_{\posleq} & \res,                         \\
                           & \res\setin\ftor(\fun),        \\
                           & \res\posleq\fun.
        \end{cases}
    \end{equation}
    The feasible set~$\feasibleset{}\setsubseteq\funsp\cartprod\ressp$ is the set of functionality and resources that satisfy the constraints~$\res\setin\ftor(\fun)$ and~$\res\posleq\fun$:
    % 
    \begin{equation}
        \feasibleset{}=\makesett{ \tup{\fun,\res}\setin\funsp\cartprod\ressp\colon (\res\setin\ftor(\fun))\wedge(\res\posleq\fun)} .
        \label{eq:feasible}
    \end{equation}
    % 
    The \uline{p}rojection~$\feasiblesetprojfun$ of~$\feasibleset{}$ to the functionality space is:
    % 
    \begin{equation}
        \feasiblesetprojfun=\makesett{ \fun\mid\tup{\fun,\res} \setin\feasibleset{}}.
    \end{equation}
    In the scalar case ($\funsp=\ressp=\tupp{\nonNegRealsComp,\leq}$), the map~$\ftor\colon\funsp\toinPos\uppersets \ressp$ is simply a map~$\ftor\colon\F{\nonNegRealsComp}\to \uppersets\R{\nonNegRealsComp}$.
    The set~$\feasiblesetprojfun$ of feasible functionality is described by
    \begin{equation}
        \feasiblesetprojfun=\makeset{\fun\setin\nonNegRealsComp\colon \ftor(\fun)\leq\fun}.
        \label{eq:Pfeasible}
    \end{equation}
    \cref{fig:nonconvex3} shows an example of a continuous map~\ftor that gives a disconnected feasible set~$\feasiblesetprojfun$.
    Moreover,~$\feasiblesetprojfun$ is disconnected under any order-preserving nonlinear re-parametrization.

\end{example}
\todotext{@AC: redo example with implementation space.}

\FloatBarrier\vfill\clearpage % keep for floats

\subsection{Recursive constraints}

\begin{example}
    \label{exa:chassis_plus_motor}
    Consider the co-design of chassis (\cref{exa:chassis}) plus motor (\cref{exa:motor}).
    The design problem for a motor has \F{speed} and \F{torque} as the provided functionality (what the motor must provide), and \R{cost}, \R{mass}, \R{voltage}, and \R{current} as the required resources~(\cref{fig:motor}).

    \begin{figure}[h!]
        \centering
        \includesag{520_motor_dp}
        \caption{}
        \label{fig:motor}
    \end{figure}

    For the chassis (\cref{fig:gmcdp_chassis}), the provided functionality is parameterized by the \F{mass} of the payload and the \R{cost}, \R{total mass}, and what the chassis needs from its motor(s), such as \R{speed} and \R{torque}.

    \begin{figure}[h!]
        \centering
        \includesag{520_dp_chassis}
        \caption{}
        \label{fig:gmcdp_chassis}
    \end{figure}

    The two design problem can be connected at the edges for torque and speed, as in \cref{fig:gmcdp_chassis_plus_motor_series}.
    The semantics is that the motor needs to have \emph{at least} the given torque and speed.

    %\begin{figure}[h]
    %  \centering
    %  \includegraphics[scale=0.33]{gmcdp_chassis_plus_motor_series}
    %  \caption{}
    % \label{fig:gmcdp_chassis_plus_motor_series}
    %\end{figure}

    \begin{figure*}[h!]
        \centering
        \includesag{dp_chassis_motor}
        \caption{}
        \label{fig:gmcdp_chassis_plus_motor_series}
    \end{figure*}
    %\captionsideleft{\label{fig:gmcdp_chassis_plus_motor_series}}{\includegraphics[scale=0.33]{gmcdp_chassis_plus_motor_series.pdf}}

    Resources can be summed together using a trivial DP corresponding to the map $\ftor:\tup{\fun_{1},\fun_{2}} \mapsto\makeset{\fun_{1}+\fun_{2}}$~(\cref{fig:total_cost}).

    \begin{figure}[h!]
        \centering
        \includesag{520_dp_sum_costs}
        \caption{}
        \label{fig:total_cost}
    \end{figure}

    %\captionsideleft{\label{fig:total_cost}}{\includegraphics[scale=0.33]{gmcdp_weightsum.pdf}}

    A co-design problem might contain recursive co-design constraints.
    For example, if we set the payload to be transported to be the sum of the motor mass plus some extra payload, a cycle appears in the graph~(\cref{fig:gmcdp_chassis_plus_motor}).

    \begin{figure*}[h!]
        \centering
        %\includegraphics[scale=0.33]{gmcdp_chassis_plus_motor}
        \includesag{dp_chassis_motor_loop}
        \caption{}
        \label{fig:gmcdp_chassis_plus_motor}
    \end{figure*}

    \FloatBarrier \vfill\clearpage

    \subsection{Abstraction}
    This formalism makes it easy to abstract away the details in which we are not interested.
    Once a diagram like~\cref{fig:gmcdp_chassis_plus_motor} is obtained, we can draw a box around it and consider the abstracted problem~(\cref{fig:gmcdp_chassis_plus_motor-1}).

    \begin{figure}[h!]
        \centering
        \includesag{520_dp_chassis_plus_motor}
        \caption{}
        \label{fig:gmcdp_chassis_plus_motor-1}
    \end{figure}

    %\captionsideleft{\label{fig:gmcdp_chassis_plus_motor-1}}{\includegraphics[scale=0.33]{gmcdp_chassis_plus_motor2.pdf}}

    \label{exa:finish}
    Let us finish assembling our robot.
    A motor needs a motor control board.
    The functional requirements are the (peak)
    \F{output current} and the \F{output voltage range}~(\cref{fig:mcb}).

    \begin{figure}[h!]
        \centering
        \includesag{520_dp_board}
        \caption{}
        \label{fig:mcb}
    \end{figure}

    %\captionsideleft{\label{fig:mcb}}{\includegraphics[scale=0.33]{gmcdp_mcb.pdf}}

    The functionality for a power supply could be parameterized by the \F{output current}, the \F{output voltages}, and the \F{capacity}.
    The resources could include \R{cost} and \R{mass} (\cref{fig:example-ba}).

    \begin{figure}[h!]
        \centering
        \includesag{520_dp_power_supply}
        \caption{}
        \label{fig:example-ba}
    \end{figure}

    %\captionsideleft{\label{fig:example-ba}}{\includegraphics[scale=0.33]{gmcdp_battery.pdf}}

    Relations such as ${\colF\mbox{current}}\cartprod{\colF\mbox{voltage}}\posleq{\colR\mbox{power required}}$ and ${\colF\mbox{power}}\cartprod{\colF\mbox{endurance}}\posleq{\colR\mbox{energy required}}$ can be modeled by a trivial ``multiplication'' DPI (\cref{fig:current_times_voltage}).

    \begin{figure}[h!]
        \centering
        \includesag{520_dp_current_times_voltage}
        \caption{}
        \label{fig:current_times_voltage}
    \end{figure}

    %\captionsideleft{\label{fig:current_times_voltage}}{\includegraphics[scale=0.33]{gmcdp_voltage_current.pdf}}

    We can connect these DPs to obtain a co-design problem with functionality \F{voltage}, \F{current}, \F{endurance} and resources \R{mass} and \R{cost}~(\cref{fig:connect}).

    \begin{figure}[h!]
        \centering
        \includegraphics[scale=0.29]{gmcdp_MCB_PSU_2}
        \caption{}
        \label{fig:connect}
    \end{figure}

    %\captionsideleft{\label{fig:connect}}{\includegraphics[scale=0.29]{gmcdp_MCB_PSU_2.pdf}}

    Draw a box around the diagram, and call it ``MCB+PSU''; then interconnect it with the ``chassis+motor'' diagram in~\cref{fig:another}.

    \begin{figure}[h!]
        \centering
        \includegraphics[scale=0.33]{gmcdp_mobility_power}
        \caption{}
        \label{fig:another}
    \end{figure}

    We can further abstract away the diagram in~\cref{fig:another} as a ``mobility+power'' CDPI, as in \cref{fig:shipping}.
    The formalism allows considering \R{mass} and \R{cost} as independent resources, meaning that we wish to obtain the Pareto frontier for the minimal resources.
    Of course, one can always reduce everything to a scalar objective.
    For example, a conversion from mass to cost exists, and it is called ``shipping''.
    Depending on the destination, the conversion factor is between~$\$0.5/\mbox{lbs}$, using USPS, to~$\$10\mbox{k}/\mbox{lbs}$ for sending your robot to low Earth orbit.

    \begin{figure}[h!]
        \centering{}
        \includegraphics[scale=0.33]{gmcdp_shipping}
        \caption{}
        \label{fig:shipping}
    \end{figure}

\end{example}
