% !TEX root = chapter-standalone.tex

\section{Moore machines,~\SetL version}
We can now slightly rework the definition of Moore machines using morphisms in \SetL rather than \Set.
\begin{definition}[Moore machine, \SetL version]
    \label{def:moore_machine_3rd}
    A Moore machine is a tuple
    \begin{equation}
        \label{eq:moore-tuple-improved-again}
        \tup{\prinL,\prstL,\proutL,\prdyn,\prreadout,\prstart},
    \end{equation}
    where~$\prinL$,~$\prstL$, and~$\proutL$ are objects of~$\SetL$,
    \begin{equation}
        \prdyn \colon \prinL \cprod \prstL \mto \prstL,
    \end{equation}
    and
    \begin{equation}
        \prreadout \colon \prstL \mto \proutL,
    \end{equation}
    are morphisms in $\SetL$ (so they are functions),
    and~$\prstart \setin \prstL$.
\end{definition}

\subsection{Composition}
\label{sec:composition-of-Moore-machines}

Consider two Moore machines
\begin{equation}
    \label{eq:moore-mora-3rd}
    \mora = \tupp{\prinL_{\mora},\prstL_{\mora},\proutL_{\mora},\prdyn_{\mora},\prreadout_{\mora},\prstart_{\mora}}
\end{equation}
\begin{equation}
    \label{eq:moore-morb-3rd}
    \morb = \tupp{\prinL_{\morb},\prstL_{\morb},\proutL_{\morb},\prdyn_{\morb},\prreadout_{\morb},\prstart_{\morb}},
\end{equation}
that are compatible for composition, in the sense that $\proutL_{\mora} = \prinL_{\morb}$.
Their composition is given by
\begin{equation}
    \morab = \tupp{\prinL_{\morab},\prstL_{\morab},\proutL_{\morab},\prdyn_{\morab},\prreadout_{\morab},\prstart_{\morab}},
\end{equation}
where
%
\begin{equation}
    \label{eq:moore-comp-3rd-1}
    \begin{aligned}
        \prinL_{\morab}   & \definedas \prinL_{\mora}, \\
        \prstL_{\morab}   & \definedas \prstL_{\mora} \cprod  \prstL_{\morb}, \\
        \proutL_{\morab}  & \definedas \proutL_{\morb}, \\
        \prstart_{\morab} & \definedas \prstart_{\mora} \tupconcat \prstart_{\morb},
    \end{aligned}
\end{equation}
and~$\prdyn_{\morab}$ and~$\prreadout_{\morab}$ are defined as
%
\begin{equation}
    \label{eq:moore-comp-3rd-2}
    \defmapcommaset{
        \prdyn_{\morab}
    }{
        \prinL_{\mora} \cprod \prstL_{\mora} \cprod \prstL_{\morb}
    }{
        \prstL_{\mora} \cprod \prstL_{\morb}
    }{
        \prinel \tupconcat \prstel_{\mora} \tupconcat \prstel_{\morb}
    }{
        \prdyn_{\mora} (\prinel \tupconcat \prstel_{\mora}) \tupconcat \prdyn_{\morb}(\prreadout_{\mora}(\prstel_{\mora}) \tupconcat \prstel_{\morb})
    }
\end{equation}
and
\begin{equation}
    \label{eq:moore-comp-3rd-3}
    \defmapperiodset{
        \prreadout_{\morab}
    }{
        \prstL_{\mora} \cprod \prstL_{\morb}
    }{
        \proutL_{\morb}
    }{
        \prstel_{\mora} \tupconcat \prstel_{\morb}
    }{
        \prreadout_{\morb}(\prstel_{\morb})
    }
\end{equation}

\subsection{Composition is associative}

Let three composable Moore machines~$\mora$,~$\morb$, and~$\morc$ be given.
We check that each of the six entries in the definition \cref{def:moore_machine_3rd} coincide for~$(\morab) \mthen \morc$ and~$\mora \mthen (\morb \mthen \morc)$.

Clearly,
\begin{equation}
    \prinL_{(\morab)\mthen \morc}  = \prinL_{\mora} =\prinL_{\mora \mthen (\morb \mthen \morc)}
\end{equation}
and
\begin{equation}
    \proutL_{(\morab)\mthen \morc}  =\proutL_\morc = \proutL_{\mora \mthen (\morb \mthen \morc)}.
\end{equation}
Furthermore,
\begin{equation}
    \prstL_{(\morab)\mthen \morc} =  (\prstL_{\mora} \cprod \prstL_{\morb}) \cprod  \prstL_{\morc}  =  \prstL_{\mora} \cprod (\prstL_{\morb} \cprod  \prstL_{\morc}) =\prstL_{\mora \mthen (\morb \mthen \morc)}
\end{equation}
since concatenation of lists is associative.
Similarly,
\begin{equation}
    \begin{aligned}
        \prstart_{(\morab)\mthen \morc} & = \prstart_{\morab} \tupconcat \prstart_{\morc} \\
                                        & =  (\prstart_{\mora } \tupconcat \prstart_{\morb}) \tupconcat \prstart_{\morc} \\
                                        & = \prstart_{\mora } \tupconcat (\prstart_{\morb} \tupconcat \prstart_{\morc}) \\
                                        & = \prstart_{\mora } \tupconcat \prstart_{ \morb \mthen\morc} \\
                                        & = \prstart_{\mora \mthen (\morb \mthen \morc)}.
    \end{aligned}
\end{equation}
Next we show that~$\prdyn_{\morab, \morc} = \prdyn_{\mora, \morb \mthen \morc}$.

On the one hand,
\begin{widepar}
    \begin{equation}
        \label{eq:assoc_moore_3rd_1}
        \begin{aligned}
            \prdyn_{(\morab)\mthen \morc}\colon \prinL_{\mora} \cprod \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc} & \to \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc} \\
            \prinel \tupconcat \prstel_{\mora} \tupconcat \prstel_{\morb} \tupconcat \prstel_\morc                               & \mapsto \prdyn_{\morab}(\prinel \tupconcat \prstel_\mora \tupconcat \prstel_\morb) \tupconcat \prdyn_{\morc}(\prreadout_{\morab}(\prstel_\mora \tupconcat \prstel_\morb) \tupconcat \prstel_\morc) \\
                                                                                                                                 & =  \prdyn_\mora(\prinel \tupconcat \prstel_\mora) \tupconcat \prdyn_\morb(\prreadout_\mora(\prstel_\mora) \tupconcat \prstel_\morb) \tupconcat \prdyn_\morc(\prreadout_\morb(\prstel_\morb) \tupconcat \prstel_\morc),
        \end{aligned}
    \end{equation}
\end{widepar}
while on the other hand
\begin{widepar}
    \begin{equation}
        \label{eq:assoc_moore_3rd_2}
        \begin{aligned}
            \prdyn_{\mora \mthen (\morb \mthen \morc)} \colon \prinL_{\mora} \cprod \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc} & \to \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc} \\
            \prinel \tupconcat \prstel_{\mora} \tupconcat \prstel_{\morb} \tupconcat \prstel_\morc                                             & \mapsto \prdyn_{\mora }(\prinel \tupconcat \prstel_\mora) \tupconcat \prdyn_{\morb \mthen \morc}(\prreadout_{\mora }(\prstel_\mora) \tupconcat \prstel_\morb \tupconcat  \prstel_\morc) \\
                                                                                                                                               & =  \prdyn_\mora(\prinel \tupconcat \prstel_\mora) \tupconcat \prdyn_\morb(\prreadout_\mora(\prstel_\mora) \tupconcat \prstel_\morb) \tupconcat \prdyn_\morc(\prreadout_\morb(\prstel_\morb) \tupconcat \prstel_\morc).
        \end{aligned}
    \end{equation}
\end{widepar}
So, these two functions are indeed the same.

Finally, we verify that~$\prreadout_{(\morab) \mthen \morc} = \prreadout_{\mora\mthen (\morb \mthen \morc)}$:
\begin{equation}
    \label{eq:assoc_moore_3rd_3}
    \defmapset{
        \prreadout_{(\morab) \mthen \morc}
    }{
        \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc}
    }{
        \proutL_{\morc}
    }{
        \prstel_{\mora} \tupconcat \prstel_{\morb} \tupconcat \prstel_{\morc}
    }{
        \prreadout_{\morc}(\prstel_{\morc})
    }
\end{equation}
while
\begin{equation}
    \label{eq:assoc_moore_3rd_4}
    \defmapperiodset{
        \prreadout_{\mora \mthen (\morb \mthen \morc)}
    }{
        \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc}
    }{
        \proutL_{\morc}
    }{
        \prstel_{\mora} \tupconcat \prstel_{\morb} \tupconcat \prstel_{\morc}
    }{
        \prreadout_{\morb \mthen \morc}(\prstel_{\morb} \tupconcat \prstel_{\morc}) = \prreadout_{\morc}(\prstel_{\morc})
    }
\end{equation}

\subsection{The semicategory of Moore machines}

Now that we have shown that composition of Moore machines is associative (with our new definition), we can organize Moore machines as a semicategory.

\begin{definition}[\Moore]
    \label{def:Moore-semicat-new}
    The \emph{semicategory of Moore machines} \Moore is given by:
    \begin{enumerate}
        \item \emph{Objects:} objects of~\SetL.
        \item \emph{Morphisms:}
              A morphism from~$\prinL$ to $\proutL$ is a Moore machine
              \begin{equation}
                  \tup{\prinL,\prstL,\proutL,\prdyn,\prreadout,\prstart},
              \end{equation}
              where
              \begin{itemize}
                  \item $\prinL,\prstL,\proutL$ are objects of \SetL;
                  \item $\prdyn \colon \prinL \cprod \prstL \mto \prstL$ and $\prreadout \colon \prstL \mto \proutL$ are morphisms in $\SetL$;
                  \item $\prstart \setin \prstL$.
              \end{itemize}
        \item \emph{Composition:}
              as defined above in this section.
    \end{enumerate}
\end{definition}

\todotext{\alphubel: Add a remark showing that Moore machines do not have identities, and are hence do not form a category.}
