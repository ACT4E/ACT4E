% !TEX root = chapter-standalone.tex

\section{Moore machines, $\cCat{\Set}$ version}

\begin{definition}[Moore machine, 3rd definition]
    \label{def:moore_machine_3rd}
    A Moore machine is a tuple
    \begin{equation}
        \label{eq:moore-tuple-improved-again}
        \tup{\prinL,\prstL,\proutL,\prdyn,\prreadout,\prstart},
    \end{equation}
    where $\prinL$, $\prstL$, and $\proutL$ are now objects of $\cCat{\Set}$, $\prdyn$ is a function of the type
    \begin{equation}
        \prdyn \colon \prinL \cprod \prstL \mto \prstL,
    \end{equation}
    $\prreadout$ is a function
    \begin{equation}
        \prreadout \colon \prstL \mto \proutL,
    \end{equation}
    and $\prstart \setin \prstL$.
\end{definition}

\subsection{Composition}

Let
\begin{equation}
    \label{eq:moore-mora-3rd}
    \mora = \tupp{\prinL_{\mora},\prstL_{\mora},\proutL_{\mora},\prdyn_{\mora},\prreadout_{\mora},\prstart_{\mora}}
\end{equation}
%
and
%
\begin{equation}
    \label{eq:moore-morb-3rd}
    \morb = \tupp{\prinL_{\morb},\prstL_{\morb},\proutL_{\morb},\prdyn_{\morb},\prreadout_{\morb},\prstart_{\morb}},
\end{equation}
be Moore machines with $\proutL_{\mora} = \prinL_{\morb}$.
Their composition now is given by
\begin{equation}
    \mora \mthen \morb = \tupp{\prinL_{\mora \mthen \morb},\prstL_{\mora \mthen \morb},\proutL_{\mora \mthen \morb},\prdyn_{\mora \mthen \morb},\prreadout_{\mora \mthen \morb},\prstart_{\mora \mthen \morb}}
\end{equation}
where
%
\begin{equation}
    \label{eq:moore-comp-3rd-1}
    \begin{aligned}
        \prinL_{\mora\mthen\morb}   & \definedas \prinL_{\mora}, \\
        \prstL_{\mora\mthen\morb}   & \definedas \prstL_{\mora} \cprod  \prstL_{\morb}, \\
        \proutL_{\mora\mthen\morb}  & \definedas \proutL_{\morb}, \\
        \prstart_{\mora\mthen\morb} & \definedas \prstart_{\mora} \tupconcat \prstart_{\morb},
    \end{aligned}
\end{equation}
and $\prdyn_{\mora \mthen \morb}$ and $\prreadout_{\mora \mthen \morb}$ are defined as

\begin{equation}
    \label{eq:moore-comp-3rd-2}
    \defmapset{
        \prdyn_{\mora\mthen\morb}
    }{
        \prinL_{\mora} \cprod \prstL_{\mora} \cprod \prstL_{\morb}
    }{
        \prstL_{\mora} \cprod \prstL_{\morb}
    }{
       u \listconcat x_{\mora} \listconcat x_{\morb}
    }{
        \prdyn_{\mora} (u \tupconcat x_{\mora}) \tupconcat \prdyn_{\morb}(\prreadout_{\mora}(x_{\mora}) \tupconcat x_{\morb})
    }
\end{equation}
and
\begin{equation}
    \label{eq:moore-comp-3rd-3}
    \defmapperiodset{
        \prreadout_{\mora\mthen\morb}
    }{
        \prstL_{\mora} \cprod \prstL_{\morb}
    }{
        \proutL_{\morb}
    }{
        x_{\mora} \tupconcat x_{\morb}
    }{
        \prreadout_{\morb}(x_{\morb})
    }
\end{equation}

\subsection{Composition is associative}

Let three composable Moore machines~$\mora$,~$\morb$, and~$\morc$ be given.
We check that each of the six entries in the definition \cref{def:moore_machine_3rd} coincide for~$(\mora \mthen \morb) \mthen \morc$ and~$\mora \mthen (\morb \mthen \morc)$.

Clearly,
\begin{equation*}
    \prinL_{(\mora \mthen \morb)\mthen \morc}  = \prinL_{\mora} =\prinL_{\mora \mthen (\morb \mthen \morc)}
\end{equation*}
and
\begin{equation*}
    \proutL_{(\mora \mthen \morb)\mthen \morc}  =\proutL_\morc = \proutL_{\mora \mthen (\morb \mthen \morc)}.
\end{equation*}
Furthermore,
\begin{equation*}
    \prstL_{(\mora \mthen \morb)\mthen \morc} =  (\prstL_{\mora} \cprod \prstL_{\morb}) \cprod  \prstL_{\morc}  =  \prstL_{\mora} \cprod (\prstL_{\morb} \cprod  \prstL_{\morc}) =\prstL_{\mora \mthen (\morb \mthen \morc)}
\end{equation*}
since concatenation of lists is associative.

Similarly,
\begin{align*}
    \prstart_{(\mora \mthen \morb)\mthen \morc} & = \prstart_{\mora \mthen \morb} \tupconcat \prstart_{\morc} \\
                                                & =  (\prstart_{\mora } \tupconcat \prstart_{\morb}) \tupconcat \prstart_{\morc} \\
                                                & = \prstart_{\mora } \tupconcat (\prstart_{\morb} \tupconcat \prstart_{\morc}) \\
                                                & = \prstart_{\mora } \tupconcat \prstart_{ \morb \mthen\morc} \\
                                                & = \prstart_{\mora \mthen (\morb \mthen \morc)}.
\end{align*}

Next we show that~$\prdyn_{\mora \mthen \morb, \morc} = \prdyn_{\mora, \morb \mthen \morc}$.

On the one hand,
\begin{widepar}
    \begin{equation*}
        \label{eq:assoc_moore_3rd_1}
        \begin{aligned}
            \prdyn_{(\mora\mthen\morb)\mthen \morc}\colon \prinL_{\mora} \cprod \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc} & \to \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc} \\
            u \listconcat x_{\mora} \listconcat x_{\morb} \listconcat x_\morc                                                                                 & \mapsto \prdyn_{\mora \mthen \morb}(u \tupconcat x_\mora \tupconcat x_\morb) \tupconcat \prdyn_{\morc}(\prreadout_{\mora \mthen \morb}(x_\mora \tupconcat x_\morb) \tupconcat x_\morc) \\                                                                                                                                                                & =  \prdyn_\mora(u \tupconcat x_\mora) \tupconcat \prdyn_\morb(\prreadout_\mora(x_\mora) \tupconcat x_\morb) \tupconcat \prdyn_\morc(\prreadout_\morb(x_\morb) \tupconcat x_\morc),
        \end{aligned}
    \end{equation*}
\end{widepar}
while on the other hand
\begin{widepar}
    \begin{equation*}
        \label{eq:assoc_moore_3rd_2}
        \begin{aligned}
            \prdyn_{\mora \mthen (\morb \mthen \morc)} \colon \prinL_{\mora} \cprod \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc} & \to \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc} \\
            u \listconcat x_{\mora} \listconcat x_{\morb} \listconcat x_\morc                                                                                     & \mapsto \prdyn_{\mora }(u \tupconcat x_\mora) \tupconcat \prdyn_{\morb \mthen \morc}(\prreadout_{\mora }(x_\mora) \tupconcat x_\morb \tupconcat  x_\morc) \\                                                                                                                                                                & =  \prdyn_\mora(u \listconcat x_\mora) \tupconcat \prdyn_\morb(\prreadout_\mora(x_\mora) \tupconcat x_\morb) \tupconcat \prdyn_\morc(\prreadout_\morb(x_\morb) \tupconcat x_\morc).
        \end{aligned}
    \end{equation*}
\end{widepar}
So, these two functions are indeed the same.

Finally, we verify that $\prreadout_{(\mora\mthen\morb) \then \morc} = \prreadout_{\mora\mthen (\morb \mthen \morc)}$:
\begin{equation}
    \label{eq:assoc_moore_3rd_3}
    \defmapset{
        \prreadout_{(\mora\mthen\morb) \mthen \morc}
    }{
        \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc}
    }{
        \proutL_{\morc}
    }{
        x_{\mora} \tupconcat x_{\morb} \tupconcat x_{\morc}
    }{
        \prreadout_{\morc}(x_{\morc})
    }
\end{equation}
while
\begin{equation}
    \label{eq:assoc_moore_3rd_4}
    \defmapperiodset{
        \prreadout_{\mora \mthen (\morb \mthen \morc)}
    }{
        \prstL_{\mora} \cprod \prstL_{\morb} \cprod \prstL_{\morc}
    }{
        \proutL_{\morc}
    }{
        x_{\mora} \tupconcat x_{\morb} \tupconcat x_{\morc}
    }{
        \prreadout_{\morb \mthen \morc}(x_{\morb} \tupconcat x_{\morc}) = \prreadout_{\morc}(x_{\morc})
    }
\end{equation}

