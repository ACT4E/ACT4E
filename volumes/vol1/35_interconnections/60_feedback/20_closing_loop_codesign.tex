% !TEX root = chapter-standalone.tex

\section{Trace in co-design}
\todotextjira{201}{\alphubel: @Gioele: Change example}
\devel{
    \begin{example}
        Consider a vehicle motor that weighs a certain amount but can also carry some weight (\cref{fig:examplefeedback}).
        \begin{figure}[h!]
            \centering
            \includesag{50_motor1}
            \caption{Example of feedback in \SY{design problems}.}
            \label{fig:examplefeedback}
        \end{figure}
        In the diagram, we haven't added anything to the weight of the motor, so currently the only thing the motor is carrying is itself.
        Also, note that we are considering~$\text{CO}_2\op$ since we want to optimize toward \emph{less} CO$_2$.
        Fix a given amount of CO$_2$ and fuel.
        In that case, closing the loop corresponds to drawing a line~$(c^\ast = c)$ in the graph of~$\text{weight}\op \cartprod \text{weight}$ and taking only solutions under the line in \cref{fig:weightcarrier}.

    \end{example}
    \begin{figure}[h!]
        \centering
        \includesag{50_carrier}
        \caption{The shaded area marks a portion of the feasibility set of a traced design problem, ``motor''.
            Note that it is not an \SY{upper set} in the subspace ``weight $\cartprod$ weight'' of ``motor''.
        }

        \label{fig:weightcarrier}

    \end{figure}

    Note that the shaded area is \emph{not} an \SY{upper set}.
    This is admissible, since the actual feasible set of ``motor'' is a subset of CO$_2 \cartprod$ fuel, and there, it is an \SY{upper set}.
}
Suppose that we are given a \SY{design problem} with a resource and a functionality of the same type~$\posgenC$ (\cref{fig:extrace_1}).

\begin{figure}[h!]
    \centering
    \includesag{50_trace}
    \caption{Design problem with a resource and a functionality of the same type.
    }
    \label{fig:extrace_1}
\end{figure}

Can we ``close the loop'', as in the diagram reported in~\cref{fig:extrace_2}?
\begin{figure}[h!]
    \centering
    \includesag{50_trace2}
    \caption{Closing the loop in the design problem.
    }
    \label{fig:extrace_2}
\end{figure}

It turns out that we can give a well-defined semantics to this loop-closing operation, which coincides with the notion of a \emph{trace} in category theory.

The following is the formal definition of the trace operation for \SY{design problems}.

\linkvideo{spring2021-functorial-comp-b:solving-queries:solving-loop} % Loop composition
\begin{definition}[Trace of a design problem]
    \label{def:dp-trace}
    Given a \SY{design problem}~$\adpa\colon  \funposA \mtimescatob \funposC \profto \resposB \mtimescatob \resposC$, its \emph{trace}
    \begin{equation}
        \Tr_{\funposA,\resposB}^\posC(\adpa) \colon \funposA \profto \resposB
    \end{equation}
    is defined as follows:
    %
    \begin{equation}
        \label{eq:tracedef}
        \begin{aligned}
            \Tr_{\funposA,\resposB}^\posC(\adpa) \colon  \funposA\posop \Ptimes \resposB & \toinPos \Bool, \\
            \tup{\funposAopel, \RposgenBel}                                           & \mapsto \bigvee_{\posgenCel \setin \posgenC}
            \adpa(\tup{\FposgenAel, \F{\posgenCel}}\Fop,
            \tup{\RposgenBel, \R{\posgenCel}}).
        \end{aligned}
    \end{equation}
\end{definition}

Think of drawing a loop as a way of writing down the following requirement:
Something that produces~\posC should not use up more of~\posC than it produces.

\devel{
    \todotextjira{164}{\alphubel: @Gioele: The following section/paragraph on trace axioms needs attention: we don't use quite the same axioms in our definition of \SY{traced monoidal category} as are used below in the context of DP.
        I suggest we keep the definition of \SY{traced monoidal category} that we currently have and change/add diagrams below for DP and/or add a remark.
    }

    \paragraph{Trace axioms}
    We will show that the loop operation~$\Tr_{\funposA,\resposB}^\posC$ corresponds to the \emph{trace} in~\DP.
    Intuitively, forming a loop models the idea of feedback in a control-theoretic setting--the output of a process influences the choice of input--
    while the idea of ``trace'' of a \SY{monoidal category} comes from the trace of a square matrix~$(\Tr\mat{A} = \sum_i a_{ii})$, which defines the categorical trace in the (monoidal) category of \SY{vector spaces}, as previously shown.
    The connection between the two is more apparent if one decomposes the trace of a square matrix as a set of properties that any linear map from a space to itself should satisfy.
    One can find the trace axioms in  \cite{mac2013categories};
    these are equivalent to certain diagrammatic conditions \cite{joyal96}, as in \cref{tab:traceaxioms}.

    \begin{table}[h!]
        \begin{center}
            \adjustbox{max width=\textwidth}{
                \begin{tabular}{cc}
                    Vanishing I                     & Vanishing II \\
                    \includesag{50_vanishing_1a_1b} & \includesag{50_vanishing_2a_2b} \\
                    Superposing                     & Yanking \\
                    \includesag{50_superposing_1_2} & \includesag{50_yanking}
                \end{tabular}
            }
        \end{center}
        \caption{The trace axioms in diagrammatic form from \cite{joyal96} in \DP.
            \label{tab:traceaxioms}}
    \end{table}

    \begin{lemma}\label{lem:dp-trace-is-trace}
        Trace as in~\cref{def:dp-trace} satisfies the trace axioms.
        In other words,~$\tupp{\DP, \otimes, \singleton, \sigma}$ is a \SY{traced monoidal category}, with trace as in~\cref{eq:tracedef}.
    \end{lemma}
    \begin{proof}
        We have already shown that~$\tup{\DP,\otimes,\singleton,\sigma}$ is a \SY{symmetric monoidal category} (\cref{lem:symmetricmonoidaldp}).
        We prove the trace axioms one by one, starting from vanishing (\cref{eq:vanishing_1}, \cref{eq:vanishing_2}).
        Given any~$\posgenA,\posgenB\setin \Obof\DP$ and~$\adpa\colon \F{\posgenA}\Ptimes \F{\singleton}\profto \R{\posgenB}\Ptimes \R{\singleton}$ in~\DP, we have
        \begin{equation}
            \begin{aligned}
                 & = \Tr_{\F{\posgenA},\R{\posgenB}}^{\singleton}(\adpa)(\FposgenAelop,\RposgenBel) \\
                 & =\bigvee_{\posCel\setin \singleton}\adpa(\tup{\FposgenAel,\F{\posgenCel}}\Fop,\tup{\RposgenBel,\R{\posgenCel}}) \\
                 & =\adpa(\tup{\FposgenAel,\F{\singletonel}}\Fop,\tup{\RposgenBel,\R{\singletonel}}) \\
                 & =\adpa(\FposgenAelop,\RposgenBel).
            \end{aligned}
        \end{equation}
        Furthermore, for any morphism~$\adpa\colon \F{\posgenA}\cartprod \F{\posgenX}\cartprod \F{\posgenY} \profto \R{\posgenB}\Ptimes \R{\posgenX} \Ptimes \R{\posgenY}$ in \DP, we have
        \begin{equation}
            \begin{aligned}
                ~ & \Tr_{\F{\posgenA},\R{\posgenB}}^{\posX\Ptimes\posY}(\adpa)(\FposgenAelop,\RposgenBel) \\
                  & = \bigvee_{\tup{\posXel,\posYel} \setin \posX\Ptimes \posY} \adpa(\tup{\FposgenAel,\F{\posgenXel},\F{\posgenYel}}\Fop,\tup{\RposgenBel,\R{\posgenXel},\R{\posgenYel}}) \\
                  & =\bigvee_{\posXel \setin \posX}\pars{\bigvee_{\posYel \setin \posY} \adpa(\tup{\FposgenAel,\F{\posgenXel},\F{\posgenYel}}\Fop,\tup{\RposgenBel,\R{\posgenXel},\R{\posgenYel}})} \\
                  & =\Tr_{\F{\posgenA},\R{\posgenB}}^\posX\pars{
                    \Tr_{\F{\posgenA}\cartprod \F{\posgenX},\R{\posgenB}\Ptimes \R{\posgenX}}^\posY(\adpa)(\tup{\FposgenAel,\F{\posgenXel}}\Fop,\tup{\RposgenBel,\R{\posgenXel}})}.
            \end{aligned}
        \end{equation}
        For the superposing axiom (\cref{eq:superposing}), consider~$\adpa\colon \F{\posgenA}\cartprod \F{\posgenX}\profto \R{\posgenB}\Ptimes \R{\posgenX}$ in \DP.
        We have
        \begin{equation}
            \begin{aligned}
                {}
                 & \Tr_{\R{\posgenC}\cartprod \F{\posgenA},\R{\posgenC}\Ptimes \R{\posgenB}}^{\posX}(\dpidat\posC\mtimescat \adpa)(\tup{\F{\posgenCel_1},\FposgenAel}\Fop,\tup{\R{\posgenCel_2},\RposgenBel}) \\
                 & = \bigvee_{\posXel \setin \posX} \dpidat\posC(\F{\posgenCel_1^*},\R{\posgenCel_2})\booland \adpa(\tup{\FposgenAel,\F{\posgenXel}}\Fop,\tup{\RposgenBel,\R{\posgenXel}}) \\
                 & =\dpidat\posC(\F{\posgenCel_1^*},\R{\posgenCel_2}) \booland \bigvee_{\posXel\setin \posX} \adpa(\tup{\FposgenAel,\F{\posgenXel}}\Fop,\tup{\RposgenBel,\R{\posgenXel}}) \\
                 & =(\dpidat\posC \mtimescat \Tr_{\F{\posgenA},\R{\posgenB}}^\posX(\adpa))(\tup{\F{\posgenCel_1},\FposgenAel}\Fop,\tup{\R{\posgenCel_2},\RposgenBel}).
            \end{aligned}
        \end{equation}
        Finally, for yanking~\cref{eq:yanking} consider~$\sigma_{\posX,\posX}$.
        We have
        \begin{equation}
            \begin{aligned}
                ~ & \Tr_{\posA,\posA}^{\posA}(\sigma_{\posA,\posA})(\F{\posgenAel_1^*},\R{\posgenAel_2}) \\
                  & = \bigvee_{\posAel\setin \posA} \sigma_{\posA,\posA}(\tup{\F{\posgenAel_1},\FposgenAel}\Fop,\tup{\R{\posgenAel},\R{\posgenAel_2}}) \\
                  & =\bigvee_{\posAel\setin \posA} \F{\posgenAel_1} \posleq \R{\posgenAel_2} \booland \FposgenAel\posleq \R{\posgenAel} \\
                  & =\bigvee_{\posAel\setin \posA} \F{\posgenAel_1} \posleq \R{\posgenAel_2} \\
                  & =\dpidat\posA(\F{\posgenAel_1^*},\R{\posgenAel_2}).
            \end{aligned}
        \end{equation}
    \end{proof}
}
