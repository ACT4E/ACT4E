% !TEX root = chapter-standalone.tex

\section{Feedback for symmetric strict monoidal semicategories}
\todo{fill this section}
\begin{widepar}
    \begin{ctdefinition}[Traced symmetric strict monoidal semicategory]
        \label{def:traced-fun-stack-scat}
        We say that a symmetric strict monoidal \SY{semicategory}~$\tup{\CatC, \mtimescat, \idmoncat, \sourceperm{\sigma}, \targetperm{\sigma} }$ is \emph{traced} if it is equipped with a family of functions
        \begin{equation}
            \Tr_{\Obja,\Objb}^\Objc\colon \HomSet{\CatC}{\Obja \mtimescatob \Objc}{\Objb\mtimescatob \Objc}\to \HomSet{\CatC}{\Obja}{\Objb},
        \end{equation}
        satisfying the following axioms:
        \begin{enumerate}

            \item \emph{Naturality in $\Obja$:} For any morphisms $\mora\colon \Obja\mtimescatob \Objc \mto \Objb\mtimescatob \Objc$ and $\morb \colon \Obja' \mto \Obja$, if $\Objc$ has an identity $\catidat\Objc$, then
                  \begin{equation}
                      \Tr_{\Obja', \Objb}^\Objc ( (\morb \mtimescatmor \catidat\Objc) \mthen \mora) = \morb \mthen \Tr_{\Obja, \Objb}^\Objc (\mora).
                  \end{equation}

            \item \emph{Naturality in $\Objb$:}
                  For any morphisms $\mora\colon \Obja\mtimescatob \Objc \mto \Objb\mtimescatob \Objc$ and $\morb \colon \Objb \mto \Objb'$, if $\Objc$ has an identity $\catidat\Objc$, then
                  \begin{equation}
                      \Tr_{\Obja, \Objb'}^\Objc ( \mora \mthen (\morb \mtimescatmor \catidat\Objc) ) = \Tr_{\Obja, \Objb}^\Objc (\mora) \mthen \morb.
                  \end{equation}

            \item \emph{Dinaturality in $\Objc$:}
                  For any morphisms $\mora \colon \Obja \mtimescatob \Objc \mto \Objb \mtimescatob \Objc'$ and $\morb \colon \Objc' \mto \Objc$, if $\catidat\Obja$ and $\catidat\Objb$ exist, then
                  \begin{equation}
                      \Tr_{\Obja, \Objb}^{\Objc} (\mora \mthen (\catidat\Objb \mtimescatmor \morb)) = \Tr_{\Obja, \Objb}^{\Objc'}((\catidat\Obja \mtimescatmor \morb) \mthen \mora).
                  \end{equation}

            \item \emph{Vanishing I:}
                  For any morphism~$\mora \colon \Obja\mto \Objb$ in \CatC,
                  \begin{equation}
                      \label{eq:semicat-trace-vanishing_1}
                      \Tr_{\Obja,\Objb}^\idmoncat (\mora)=\mora.
                  \end{equation}

            \item \emph{Vanishing II:}
                  For any morphism~$\mora \colon \Obja\mtimescatob \Objc \mtimescatob \Objd \mto \Objb\mtimescatob \Objc \mtimescatob \Objd$ in \CatC,
                  \begin{equation}
                      \label{eq:semicat-trace-vanishing_2}
                      \Tr_{\Obja,\Objb}^{\Objc\mtimescatob \Objd}(\mora)=\Tr_{\Obja,\Objb}^\Objc\pars{
                          \Tr_{\Obja \mtimescatob \Objc, \Objb \mtimescatob \Objc}^\Objd(\mora)}.
                  \end{equation}

            \item \emph{Superposing:}
                  For any morphisms~$\mora\colon \Obja\mtimescatob \Objc \mto \Objb\mtimescatob \Objc$ and $\morb \colon \Obje \mto \Objf$ in \CatC,
                  \begin{equation}
                      \label{eq:semicat-trace-superposing}
                      \Tr_{\Obje\mtimescatob \Obja,\Objf\mtimescatob \Objb}^{\Objc}(\morb \mtimescatmor \mora)=\morb \mtimescatmor \Tr_{\Obja,\Objb}^\Objc(\mora).
                  \end{equation}

            \item \emph{Yanking:}
                  For any object $\Objc$, if $\catidat\Objc$ exists, then
                  \begin{equation}
                      \label{eq:semicat-trace-yanking-I}
                      (\sourceperm{\pi} \mthen \Tr_{\Objc,\Objc}^\Objc)\pars{\catidat\Objc \mtimescatmor \catidat\Objc }=\catidat\Objc
                  \end{equation}
                  and
                  \begin{equation}
                      \label{eq:semicat-trace-yanking-II}
                      (\targetperm{\pi} \mthen \Tr_{\Objc,\Objc}^\Objc)\pars{\catidat\Objc \mtimescatmor \catidat\Objc }=\catidat\Objc,
                  \end{equation}
                  where $\pi \setin S_2$ is the odd permutation corresponding to swapping the two copies of $\Objc$.
        \end{enumerate}
    \end{ctdefinition}
\end{widepar}

\todotext{J: the above defines what might more precisely be called a \emph{right} trace... in a \SY{symmetric monoidal category} this will, I think, automatically also give a left trace, because the axioms work nicely with the symmetric braiding... in the above I'm not sure if this works out still all nicely... perhaps or perhaps not... }

\devel{
\begin{lemma}
Consider the subsemicategory of \LTI only allowing propert \LTI systems as morphisms with the trace defined in \cref{def:trace-lti-prop}.
The trace axioms are satified.
\end{lemma}

\begin{proof}
We prove the statements not involving identities one by one.
\paragraph*{Vanishing I}
Consider a proper LTI system $\mora\colon i\mto j$, given by $\genericplti{\mora}$ with state dimension $s\setin \natnumbers$.
We need to check
\begin{equation*}
\Tr_{i,j}^0 (\mora)=\mora.
\end{equation*}
Using the trace definition, we can write:
\begin{equation*}
\Tr_{i,j}^0 (\mora)=\tup{\prstart{\mora}, \mat{A}_\mora+\rowscols{\mat{B}_{\mora}}{:}{i+1:i+k}\rowscols{\mat{C}_{\mora}}{j+1:j+k}{:}, \rowscols{\mat{B}_{\mora}}{:}{1:i}, \rowscols{\mat{C}_{\mora}}{1:j}{:}}.
\end{equation*}
However, we have:
\begin{equation*}
\mat{B}_\mora=\begin{bmatrix}
\rowscols{\mat{B}_{\mora}}{:}{1:i}&\mat{0}^{s\times 0}
\end{bmatrix},\quad 
\mat{C}_\mora=\begin{bmatrix}
\rowscols{\mat{C}_{\mora}}{1:j}{:}\\ \mat{0}^{0\times s}
\end{bmatrix},
\end{equation*}
and therefore 
\begin{equation*}
\Tr_{i,j}^0 (\mora)=\tup{\prstart{\mora}, \mat{A}_\mora, \mat{B}_\mora, \mat{C}_\mora}=\mora.
\end{equation*}

\paragraph*{Vanishing II}
Consider a proper LTI system $\mora\colon i+k+o\mto j+k+o$, given by $\genericplti{\mora}$ with state dimension $s\setin \natnumbers$.
We need to check
\begin{equation*}
\Tr_{i,j}^{k+o} (\mora)=\Tr_{i,j}^{k}\left(\Tr_{i+k,j+k}^o(\mora)\right).
\end{equation*}
Let's start with the left-hand side of the statement.
We have:
\begin{equation}
\label{eq:vanishing2-left}
\Tr_{i,j}^{k+o} (\mora)=\tup{\prstart, \mat{A}_\mora+\rowscols{\mat{B}_\mora}{:}{i+1:i+k+o}\rowscols{\mat{C}_\mora}{j+1:j+k+o}{:}, \rowscols{\mat{B}_\mora}{:}{1:i},\rowscols{\mat{C}_\mora}{1:j}{:}}.
\end{equation}
Let's look at the right-hand side.
We have:
\begin{widepar}
\begin{equation*}
\Tr_{i+k,j+k}^{o} (\mora)=\tup{\prstart, \mat{A}+\rowscols{\mat{B}_\mora}{:}{i+k+1:i+k+o} \rowscols{\mat{C}_\mora}{j+k+1:j+k+o}{:}, \underbrace{\rowscols{\mat{B}_\mora}{:}{1:i+k}}_{\mat{B}_{\mora,\star}},\underbrace{\rowscols{\mat{C}_\mora}{1:j+k}{:}}_{\mat{C}_{\mora,\star}}},
\end{equation*}
\end{widepar}
which we can leverage to express $\Tr_{i,j}^{k}\left(\Tr_{i+k,j+k}^o(\mora)\right)=\ast$.
Clearly, $\projA(\ast)=\prstart$.
Furthermore:
\begin{equation*}
\begin{aligned}
\projB(\ast)&=\mat{A}_\mora + \rowscols{\mat{B}_\mora}{:}{i+k+1:i+k+o}\rowscols{\mat{C}_\mora}{j+k+1:j+k+o}{:}+\rowscols{\mat{B}_{\mora,\star}}{:}{i+1:i+k}\rowscols{\mat{C}_{\mora,\star}}{:}{j+1:j+k}\\
&=\mat{A}_\mora + \rowscols{\mat{B}_\mora}{:}{i+k+1:i+k+o}\rowscols{\mat{C}_\mora}{j+k+1:j+k+o}{:}+\rowscols{\mat{B}_{\mora}}{:}{i+1:i+k}\rowscols{\mat{C}_{\mora}}{:}{j+1:j+k}\\
&=\mat{A}_\mora + \begin{bmatrix} 
    \rowscols{\mat{B}_{\mora}}{:}{i+1:i+k} & \rowscols{\mat{B}_\mora}{:}{i+k+1:i+k+o} 
\end{bmatrix} \begin{bmatrix}
    \rowscols{\mat{C}_{\mora}}{:}{j+1:j+k}\\
    \rowscols{\mat{C}_\mora}{j+k+1:j+k+o}{:}
\end{bmatrix}\\
&=\mat{A}+\rowscols{\mat{B}_\mora}{:}{i+1:i+k+o}\rowscols{\mat{C}_\mora}{j+1:j+k+o}{:}.
\end{aligned}
\end{equation*}
Furthermore, $\projC(\ast) = \rowscols{\mat{B}_\mora}{:}{1:i}$ and $\projD(\ast) = \rowscols{\mat{C}_\mora}{1:j}{:}$.
Clearly, the found results correspond to \cref{eq:vanishing2-left}.

\paragraph*{Superposing}
Consider the proper LTI systems $\mora\colon i+k\mto j+k$, given by $\genericplti{\mora}$, and $\morb\colon l\mto m$, given by $\genericplti{\morb}$.
We need to check:
\begin{equation*}
\Tr_{l+i,m+j}^k(\morb \mtimescatmor \mora)=\morb \mtimescatmor \Tr_{i,j}^k(\mora).
\end{equation*}
Let's start with the left-hand side.
We have:
\begin{equation*}
\morb \mtimescatmor \mora=\tup{\begin{bmatrix}\prstart_\morb\\ \prstart_\mora \end{bmatrix}, \begin{bmatrix} \mat{A}_\morb&\mat{0}\\ \mat{0}&\mat{A}_\mora\end{bmatrix},
\begin{bmatrix} \mat{B}_\morb&\mat{0}\\ \mat{0}&\mat{B}_\mora\end{bmatrix},\begin{bmatrix} \mat{C}_\morb&\mat{0}\\ \mat{0}&\mat{C}_\mora\end{bmatrix}}
\end{equation*}
Now observe that $\mat{B}_\morb$ has $l$ columns, $\mat{B}_\mora$ has $i+k$ columns, $\mat{C}_\morb$ has $m$ rows, and $\mat{C}_\mora$ has $j+k$ rows.
Let's denote $\Tr_{l+i,m+j}^k(\morb \mtimescatmor \mora)$ by $\ast$.
Clearly:
\begin{equation*}
\projA(\ast)=\begin{bmatrix}\prstart_\morb &\prstart_\mora\end{bmatrix}.
\end{equation*}
We have:
\begin{equation*}
\begin{aligned}
\projB(\ast)&=\begin{bmatrix} \mat{A}_\morb&\mat{0}\\ \mat{0}&\mat{A}_\mora\end{bmatrix}+\rowscols{\begin{bmatrix} \mat{B}_\morb&\mat{0}\\ \mat{0}&\mat{B}_\mora\end{bmatrix}}{:}{l+i+1:l+i+k}\rowscols{\begin{bmatrix} \mat{C}_\morb&\mat{0}\\ \mat{0}&\mat{C}_\mora\end{bmatrix}}{m+j+1:m+j+k}{:}\\
&=\begin{bmatrix} \mat{A}_\morb&\mat{0}\\ \mat{0}&\mat{A}_\mora\end{bmatrix}+\begin{bmatrix} \mat{0}\\ \rowscols{\mat{B}_\mora}{:}{i+1:i+k}\end{bmatrix}
\begin{bmatrix}
\mat{0}&\rowscols{\mat{C}_\mora}{j+1:j+k}{:}
\end{bmatrix}\\
&=\begin{bmatrix} \mat{A}_\morb&\mat{0}\\ \mat{0}&\mat{A}_\mora\end{bmatrix}
\begin{bmatrix}
\mat{0}&\mat{0}\\
\mat{0}&\rowscols{\mat{B}_\mora}{:}{i+1:i+k}\rowscols{\mat{C}_\mora}{j+1:j+k}{:}
\end{bmatrix}
\end{aligned}
\end{equation*}
Furthermore, we have
\begin{equation*}
\projC(\ast)=\begin{bmatrix}
\mat{B}_\morb&\mat{0}\\
\mat{0}&\rowscols{\mat{B}_\mora}{:}{1:i}
\end{bmatrix}
\end{equation*}
and
\begin{equation*}
\projD(\ast)=\begin{bmatrix}
\mat{C}_\morb&\mat{0}\\
\mat{0}&\rowscols{\mat{C}_\mora}{1:j}{:}
\end{bmatrix}
\end{equation*}
We can now look at the right-hand side.
First:
\begin{equation*}
\Tr_{i,j}^{k} (\mora)=\tup{\prstart, \mat{A}_\mora+\rowscols{\mat{B}_\mora}{:}{i+1:i+k} \rowscols{\mat{C}_\mora}{j+1:j+k}{:}, \rowscols{\mat{B}_\mora}{:}{1:i},\rowscols{\mat{C}_\mora}{1:j}{:}},
\end{equation*}
Therefore, we have:
\begin{equation*}
\projA(\morb \mtimescatmor \Tr_{i,j}^k(\mora))=\begin{bmatrix}\prstart_\morb &\prstart_\mora\end{bmatrix},
\end{equation*}
\begin{equation*}
\projB(\morb \mtimescatmor \Tr_{i,j}^k(\mora))=\begin{bmatrix}
\mat{A}_\morb&\mat{0}\\
\mat{0}&\mat{A}_\mora + \rowscols{\mat{B}_\mora}{:}{i+1:i+k} \rowscols{\mat{C}_\mora}{j+1:j+k}{:},
\end{bmatrix}
\end{equation*}
%
\begin{equation*}
\projC(\morb \mtimescatmor \Tr_{i,j}^k(\mora))=\begin{bmatrix}
\mat{B}_\morb&\mat{0}\\
\mat{0}&\rowscols{\mat{B}_\mora}{:}{1:i}
\end{bmatrix},
\end{equation*}
and 
\begin{equation*}
\projD(\morb \mtimescatmor \Tr_{i,j}^k(\mora))=
\begin{bmatrix}
\mat{C}_\morb&\mat{0}\\
\mat{0}&\rowscols{\mat{C}_\mora}{1:j}{:}
\end{bmatrix},
\end{equation*}
which clearly correspond to the left-hand side.
\end{proof}
}



\begin{lemma}
\LTI with the trace as in \cref{def:trace-lti} satifies the trace axioms.
\end{lemma}

\begin{proof}
We prove the statements one by one.

\paragraph*{Naturality in $\Obja$}
Consider the LTI systems $\mora\colon i+k\mto j+k$ and $\morb\colon m\mto i$.
We need to check:
\begin{equation*}
\underbrace{\Tr_{m,j}^k((\morb \mtimescatmor \catid_k)\mthen \mora)}_{(1)}=\morb \mthen \Tr_{i,j}^k(\mora).
\end{equation*}

We start developing the left-hand side of the equation, referred to as (1). 
To do so, we first write $\morb \mtimescatmor \catid_k\colon m+k\mto i+k$.
\begin{equation*}
\morb \mtimescatmor \catid_k=\tupp{\prstart_\morb, \mat{A}_\morb, \begin{bmatrix} \mat{B}_\morb & \mat{0}\end{bmatrix},\begin{bmatrix} \mat{C}_\morb \\ \mat{0}\end{bmatrix}, \begin{bmatrix} \mat{D}_\morb & \mat{0}\\ \mat{0}&\idmat^{k\times k}\end{bmatrix}}.
\end{equation*}

Furthermore, we have:
\begin{widepar}
\begin{equation*}
(\morb \mtimescatmor \catid_k)\mthen \mora =\tupp{\begin{bmatrix}\prstart_\morb\\ \prstart_\mora \end{bmatrix}, 
\begin{bmatrix} \mat{A}_\morb&\mat{0}\\ \mat{B}_\mora \begin{bmatrix} \mat{C}_\morb \\ \mat{0}\end{bmatrix}&\mat{A}_\mora \end{bmatrix}, 
\begin{bmatrix}\mat{B}_\morb & \mat{0}\\\rowscols{\mat{B}_\mora}{:}{1:i}\mat{D}_\morb &\rowscols{\mat{B}_\mora}{:}{i+1:i+k} \end{bmatrix},
\begin{bmatrix}\rowscols{\mat{D}_\mora}{:}{1:i}\mat{C}_\morb&\mat{C}_\mora\end{bmatrix}, 
\begin{bmatrix} \rowscols{\mat{D}_\mora}{:}{1:i}\mat{D}_\morb & \rowscols{\mat{D}_\mora}{:}{i+1:i+k}\end{bmatrix}}.
\end{equation*}
\end{widepar}

With these intermediate calculations, we can start looking at (1) using the trace formula, component by component.
Clearly, we have
\begin{equation*}
\projA ((1))=\begin{bmatrix}\prstart_\morb\\ \prstart_\mora \end{bmatrix}.
\end{equation*}
Furthermore, we have 
\begin{widepar}
\begin{equation}
\label{eq:lti-nat-1}
\begin{aligned}
\projB ((1))&=\begin{bmatrix} \mat{A}_\morb&\mat{0}\\ \mat{B}_\mora \begin{bmatrix} \mat{C}_\morb \\ \mat{0}\end{bmatrix}&\mat{A}_\mora \end{bmatrix}
+\rowscols{\begin{bmatrix}\mat{B}_\morb & \mat{0}\\\rowscols{\mat{B}_\mora}{:}{1:i}\mat{D}_\morb &\rowscols{\mat{B}_\mora}{:}{i+1:i+k} \end{bmatrix}}{:}{m+1:m+k}
\mat{F}
\rowscols{\begin{bmatrix}\rowscols{\mat{D}_\mora}{:}{1:i}\mat{C}_\morb&\mat{C}_\mora\end{bmatrix}}{j+1:j+k}{:},
\end{aligned}
\end{equation}
\end{widepar}
where we parametrize
\begin{equation*}
\mat{F} = \left(\idmat-\rowscols{\begin{bmatrix} \rowscols{\mat{D}_\mora}{:}{1:i}\mat{D}_\morb & \rowscols{\mat{D}_\mora}{:}{i+1:i+k}\end{bmatrix}}{j+1:j+k}{m+1:m+k}\right)^{-1},
\end{equation*}
for brevity.
We can simplify \cref{eq:lti-nat-1} by observing that $\mat{B}_\morb$ has $m$ columns, $\mat{B}_\mora$ has $i+k$ columns, $\mat{D}_\mora$ has $j+k$ roes and $i+k$ columns, and $\mat{C}_\morb$ has $i$ rows.
We get:
%\begin{widepar}
\begin{equation}
\label{eq:lti-nat-2}
\begin{aligned}
&\projB ((1))\\
&=\begin{bmatrix} \mat{A}_\morb&\mat{0}\\ \mat{B}_\mora \begin{bmatrix} \mat{C}_\morb \\ \mat{0}\end{bmatrix}&\mat{A}_\mora \end{bmatrix}
+\begin{bmatrix}\mat{0}\\ \rowscols{\mat{B}_\mora}{:}{i+1:i+k} \end{bmatrix}
\mat{F}
\rowscols{\begin{bmatrix}\rowscols{\mat{D}_\mora}{:}{1:i}\mat{C}_\morb&\mat{C}_\mora\end{bmatrix}}{j+1:j+k}{:}\\
&=\begin{bmatrix} \mat{A}_\morb&\mat{0}\\ \rowscols{\mat{B}_\mora}{:}{1:i}\mat{C}_\morb &\mat{A}_\mora \end{bmatrix}
+\begin{bmatrix}\mat{0}\\ \rowscols{\mat{B}_\mora}{:}{i+1:i+k} \end{bmatrix}
\mat{F}
\rowscols{\begin{bmatrix}\rowscols{\mat{D}_\mora}{:}{1:i}\mat{C}_\morb&\mat{C}_\mora\end{bmatrix}}{j+1:j+k}{:}\\
&=\begin{bmatrix} \mat{A}_\morb&\mat{0}\\ 
\rowscols{\mat{B}_\mora}{:}{1:i}\mat{C}_\morb &\mat{A}_\mora \end{bmatrix}
+\begin{bmatrix}\mat{0}\\ \rowscols{\mat{B}_\mora}{:}{i+1:i+k} \end{bmatrix}
\mat{F'}
\begin{bmatrix}\rowscols{\mat{D}_\mora}{j+1:j+k}{1:i}\mat{C}_\morb&\rowscols{\mat{C}_\mora}{j+1:j+k}{:}\end{bmatrix}\\
&=\begin{bmatrix}
\mat{A}_\mora&\mat{0}\\
\rowscols{\mat{B}_\mora}{:}{1:i}\mat{C}_\morb+
\rowscols{\mat{B}_\mora}{:}{i+1:i+k}\mat{F'} \rowscols{\mat{D}_\mora}{j+1:j+k}{i:i}\mat{C}_\morb
&\mat{A}_\mora+\rowscols{\mat{B}_\mora}{:}{i+1:i+k}\mat{F'}\rowscols{\mat{C}_\mora}{j+1:j+k}{:}
\end{bmatrix},
\end{aligned}
\end{equation}
%\end{widepar}
with
\begin{equation*}
\mat{F} = \left(\idmat-\rowscols{\mat{D}_\mora}{j+1:j+k}{i+1:i+k}\right)^{-1}.
\end{equation*}
\end{proof}

\begin{figure}[h!]
    \centering
    \includegraphics[scale=0.35]{feedback_axiomatic-semicat-trace-nat-X}
    \caption{Naturality in $\Obja$.}
    \label{fig:axiomatic-semicat-trace-nat-X}
\end{figure}

\begin{figure}[h!]
    \centering
    \includegraphics[scale=0.15]{feedback_axiomatic-semicat-trace-vanishing-I}
    \caption{Vanishing I.}
    \label{fig:axiomatic-semicat-trace-vanishing-I}
\end{figure}

\begin{figure}[h!]
    \centering
    \includegraphics[scale=0.2]{feedback_axiomatic-semicat-trace-superposing}
    \caption{Superposing.}
    \label{fig:axiomatic-semicat-trace-superposing}
\end{figure}

