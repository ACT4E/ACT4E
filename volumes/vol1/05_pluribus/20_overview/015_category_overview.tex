% !TEX root = chapter-standalone.tex

 \setboolean{debugimages}{false}

\section{Stacking blocks}

%\linkvideo{spring2021-intro:why-cat-theory} % Why category theory?
\linkvideo{spring2021-intro:composition} % Composition

\begin{figure*}[p]
  \centering
%\includepdf[scale=0.8,pages={22-26},nup=1x3,frame,pagecommand={}]{ACT4E-09-design.pdf}
  \fbox{\includegraphics[trim=70 90 80 80,clip,height=0.9\textheight]{lego-patent-embed.pdf}}
  \caption{The 1961 Lego patent.}
\end{figure*}


The first encounter children have with composition is with toy blocks like Lego.
It is a coincidence that there is a \emph{lego} in \emph{intellego}; the \emph{lego} in Lego is a contraction from Danish \emph{leg godt}, which means \emph{to play well}.

Legos are compositional in this sense: when you put together two blocks, you can treat the ensemble as one block for the purpose of composing it with other blocks.

We are going to use the following graphical notation to talk about composition.
We draw a black bar, and we write the \emph{ingredients} at the top, and the \emph{results} at the bottom.

\begin{equation}
\prftree{
    \text{ingredient}
}{
    \text{ingredient}
}{
    \text{ingredient}
}{
    \text{result} \quad \quad \text{result}
}
\end{equation}

Note that the order of the ingredients matters.
For instance, we can have the following recipes for the composition of red and white bricks.
We scan the list of ingredients from left to right and then place the bricks on top of what is already on the table.
\Cref{eq:red-white} shows that composing red and white produces a red-white brick;
\cref{eq:white-red} shows that composing white and red produces a white-red brick.
\begin{equation}\label{eq:red-white}
\includesag{composing_lego_white_red}
\end{equation}
%
\begin{equation}
  \label{eq:white-red}
\includesag{composing_lego_red_white}
\end{equation}

We can compose more than one brick.
For example, red, white, blue, make a red-white-blue brick.
\begin{equation}
\includesag{composing_lego_red_white_blue}
\end{equation}

In Lego we can also de-compose. If we have a red-white-blue brick, we can also recover
the single bricks.

\begin{equation}
  \includesag{decompose_legos}
\end{equation}

If you have 3 bricks on a table, you can also permute them.

\begin{equation}
\includesag{permute_legos}
\end{equation}

Consequently, if you have a red-white-blue brick, you can disassemble, permute, reassemble to obtain a blue-white-red.

\begin{equation}
  \label{eq:recipe-full}
\includesag{compose_decompose_permute}
\end{equation}


The aforementioned recipe contains several concrete steps to go from the initial ingredient to the final result.
If we do not care about the detailed steps, we can summarize the recipe as follows, by eliding the intermediate steps and only remember the ingredient and the results.
\begin{equation}\label{eq:recipe-theorem}
\includesag{lego_recipe_theorem}
\end{equation}

Alternatively, you can think of \cref{eq:recipe-theorem} as the statement of a theorem, and of \cref{eq:recipe-full} as the proof of the theorem.

Sometimes we want to think about the transformations that are reversible.
For example, we can assemble 3 red bricks into a red-red-red brick:

\begin{equation}
\includesag{assemble_red_red_red}
\end{equation}

We can also do the opposite:

\begin{equation}
\includesag{dissemble_red_red_red}
\end{equation}

To describe the bi-directionality, we use a double line:

\begin{equation}
\includesag{ass_diss_red_red_red}
\end{equation}

The flat pieces of Lego we have looked are actually one third shorter than a ``regular'' piece.

\begin{equation}
  \includesag{lego_pieces}
\end{equation}

What is the relation between a red-red-red assembly and a full red brick?
One point of view that will be very useful is thinking in terms of ``substitution'': if I have one of those, can I use it as if I had the other?
Lego bricks are very strong when assembled: a red-red-red assembly can certainly substitute
a regular brick in terms of structural functionality.
Therefore, given a red-red-red we can treat it as a full block, but not vice versa.

\begin{equation}
\includesag{lego_melt}
\end{equation}

\section{Mixing colors}

Let's now look at how we can compose colors.
In Denmark there is a small group of \textbf{Lego purists}: they are only able to conceive of Lego assemblies where all bricks have the same color.
For them, a blue, red, white brick, make a block of a color they call \emph{horrible}.

\begin{equation}
\includesag{lego_purists_horrible}
\end{equation}

If you ask a color purist, they will tell you that red and red make red:
%
\begin{equation}
\includesag{red_red_makes_red}
\end{equation}
%
Furthermore, white and white make white:
%
\begin{equation}
\includesag{white_white_makes_white}
\end{equation}
%
However, white and red make \emph{horrible}.
%
\begin{equation}
\includesag{white_and_red_makes_horrible}
\end{equation}

% If we start with 2 colors + \emph{horrible}, there are in total 9 combinations,
% which can be written in a table.

% \begin{center}
% \includesag{colors-purist}
% \end{center}

We can think of many other ways to compose colors.
For example, we can think of formalizing what happens when you \textbf{mix paint}.
Red and white in equal measure give pink.
By mixing and mixing we can obtain all the shades that go from red to white.

\begin{center}
\includesag{colors-mixing}
\end{center}

\begin{marginfigure}
  \includegraphics[width=4cm]{additive}
  \caption{Additive composition}
\end{marginfigure}

Colors on a monitor mix in an \textbf{additive} way. Two dark reds give a brighter red.
Red and white remains white.

\begin{center}
\includesag{colors-additive}
\end{center}

Green, red, blue additively make white:

\includesag{colors-additive-rgb}

\begin{marginfigure}
  \includegraphics[width=4cm]{subtractive}
  \caption{Subtractive composition}
\end{marginfigure}

A different way to compose colors is by using the \textbf{subtractive} rules in the CMY (cyan, magenta, yellow) color space.
These rules formalize the physical process of offset printing: we produce colors by putting pigments that block the other colors.


\begin{center}
\includesag{colors-subtractive}
\end{center}

This is how you produce red, blue, gren from CMY:


\begin{center}
  \includesag{colors-subtractive-rgb}
\end{center}

Finally, we can think of a \textbf{paint-over-it} composition rule: the first color is replaced by the second.

\begin{center}
\includesag{colors-paint-over}
\end{center}


We can think at a higher level, by having recipes as ingredients.

For example, the following shows that if a red stain gives you a blue stain, and a blue stain gives you a green stain, you can produce a green stain from a red stain.


\begin{equation*}
\includesag{colors-quoting}
\end{equation*}


Note that to activate the meta-recipe above, no red stain was needed.
In fact, for the above to be valid, it is not even necessary to postulate that red stains exist.

We can do \textbf{abstraction} by replacing some ingredients with \emph{placeholders}.
When we write a recipe with placeholders, we mean that the recipe is valid whatever is put in the placeholders, with the constraint that if two placeholders are of a similar color should hold the same thing.

For example, if a red stain gives me an B, and B gives me a green stain, then a red stain gives me a green stain, not matter what B is.

\begin{equation*}
  \includesag{colors-abstraction}
\end{equation*}


We can abstract further by saying that: if A gives me B, and B gives me C, then A gives me C.

\begin{equation*}
  \includesag{colors-theorems1}
\end{equation*}


\section{Commutativity and associativity}

With the power of abstraction we can talk about properties of the rules themselves.

For example, we can define as \emph{commutativity} as follows: a composition is commutative if getting a C from an A and B holds if and only if A and B give me a C.

\begin{center}
  \includesag{colors-commutativity}
\end{center}

For associativity, we want to say that, given three things A, B, C, composing A with B and then the result with C is the same thing as composing A with the result of B and C.

\begin{equation*}
  \includesag{colors-associativity}
\end{equation*}
It is easy to see that this is valid for Lego composition.

\begin{equation*}
  \includesag{colors-assoc-lego_1}
\end{equation*}
\begin{equation*}
  \includesag{colors-assoc-lego_2}
\end{equation*}

\cref{tab:color-properties} shows the properties of the 4 composition rules for composing colors that we described earlier.


\begin{table*}
  \caption{Properties of color composition rules}
\includesag{colors-table}
  \label{tab:color-properties}
\end{table*}

The table also notes the presence of a \emph{neutral element} and an \emph{annihilating} element.
A neutral element, is an element which, when composed with another element, does not change the original color.
Using the additive composition rule, for instance, this element is \emph{black}.
On the other hand, when considering the lego purists composition rule no neutral element can be found (indeed, composing with any element will result in a color change).


\todotextjira{262}{Describe annihilating better.}

%
%Example from slide 12:
%%\prflinethickness=3pt by adding this between proofs you can increase thickness, but somehow I cannot find a way to increase the middle one
%\begin{equation*}
%\prftree{\prftree{\stain{staincola}}{\stainfilled}}{\prftree{\stainfilled}{\stain{staincolf}}}{\prftree{\stain{staincola}}{\stain{staincolf}}}
%\end{equation*}


\section{Composing recipes}

We can also compose recipes themselves.

For example, imagine that in our analysis of Lego composition we decompose its color from the shape.
Each element is now described by a color and a shape.

\begin{equation}
  \label{eq:color-and-shape}
\includesag{color_and_shape}
\end{equation}

We can now define composition of color-shape pairs by composing the Lego-purist rule for colors with a color-neutral shape composition rule.

For example, given two pairs
%
\begin{equation*}
\includesag{two_pairs_comma}
\end{equation*}

%
We can find what their composition is by looking at what happens when we compose the components.

\begin{equation*}
\includesag{comma_pairs_composition}
\end{equation*}

We can generalize this as follows
\begin{equation*}
\includesag{comma_pairs_composition_gen}
\end{equation*}

\section{Isomorphisms}

Do you know the game ``spot the 5 differences''? In this book we are going to play the opposite game, which is ``spot how different things are the same at some level of abstraction''.

Consider two Lego worlds in which all colors are red or all colors are white.

\begin{equation}
\includesag{lego_world_red}
\end{equation}
and
\begin{equation}
\includesag{lego_world_white}
\end{equation}

We could create Lego theories for each of the worlds. Although they would describe different worlds, the theories would be \emph{isomorphic}.

If we confine ourselves with composing Lego blocks with the same section, then all it counts is the height of the stacks.
The equations above are saying~$1+1=2$:

\begin{equation}
  \prftree{1}{1}{2}
\end{equation}

If we are dealing with addition, then there are many other things that follow the same rules.
For example, we might look at composing two pieces of rope. If we have a piece of rope of length~$a$ and one of length~$b$, you can tie them together to get a rope of length $a+b$.

\begin{equation*}\label{eq:rope-compose}
\includesag{rope_composition}
\end{equation*}

The algebra of ropes captures the algebra of bricks: the bricks are a special case because they have integer height, while ropes can be of any length.
\begin{marginfigure}
\includesag{knot_material}
  \caption{Keeping track of knot material}\label{fig:knot}
\end{marginfigure}


We want to show you a rope trick.
Suppose that we want to be more precise than~\cref{eq:rope-compose} to describe the process of composing ropes, by keeping track of the extra rope that is needed to make a knot (\cref{fig:knot}).


One first attempt would be to call~$k$ the extra rope for the knot, and have rules like \cref{eq:rope-k1}: from~$a + k$ and~$k + b$ we obtain a piece of rope of~$a+b$.
%
\begin{equation}\label{eq:rope-k1}
\includesag{rope_knot_2}
\end{equation}
%
This is fine but not elegant.
If you want to compose further, you need to introduce a notion of substraction.
%
\begin{equation}\label{eq:rope-k2}
\includesag{rope_knot_3}
\end{equation}
%
A more elegant way is the following: let's consider only ropes of the form~$k + a + k$, so that we can account for the rope needed for the knots at either ends:
%
\begin{equation}\label{eq:rope-kk}
\includesag{rope_knot_knot}
\end{equation}
%
Now when we compose, the 2~$k$s on the inside they elide, and we are left with 2~$k$s at either end, ready to be knotted with other pieces of rope.
Notice that all ropes so created have the 2 extra~$k$s.
We can just remove them from the notation. We obtain new rules for ropes that take into account the knots:
%
\begin{equation*}\label{eq:rope-blue}
\includesag{rope_blue}
  \end{equation*}
%
And here's the magic trick: if we don't take into account the knot materials we have the simple rule~\cref{eq:rope-compose}; if we do take into account the knot materials, \emph{for any arbitrary length $k$}, we obtain~\cref{eq:rope-blue} which is exactly the same as~\cref{eq:rope-compose}.

\begin{exercise}
  Explain the trick: Where did the extra material go?
\end{exercise}
\begin{solution}
  Note that~\cref{eq:rope-compose} describes composition for ropes of any arbitrary size, while \cref{eq:rope-blue} describes compositions for ropes whose length can be written as $k+a+k$, hence with a minimum size of~$2k$. Therefore, the rope $1$ in the first theory describes a physical rope of length $1$, while the rope $1$ in the second theory describes a rope of length $1+2k$. They are different theories that happen to have isomorphic rules.
  Note that the rope~$k+k$ acts just like the identity 0. If you connect $k + a + k$ to $k+k$, you obtain $k + a + k$, for all values of~$a$.
\end{solution}

\begin{comment}
\devel{
  \begin{tikzpicture}
    \brick{4}{2}{cred}{0}{0}{0}{1}
  \end{tikzpicture}
  \hfill

  \begin{tikzpicture}
%\brick{3}{1}{yellow}{6}{0}{0}
%\brick{4}{2}{blue}{2}{0}{0}
%\brick{2}{4}{cred}{0}{0}{0}
%\brick{2}{4}{cred}{0}{1}{1}
    \brickcustom{4}{2}{pink}{4}{2}{0}{1}
    \brickcustom{4}{2}{blue}{4}{0}{0}{1}
    \brickcustom{4}{2}{green}{0}{2}{0}{1}
    \brickcustom{4}{2}{cred}{0}{0}{0}{0.33}
    \brickcustom{4}{2}{cwhite}{0}{0}{1}{0.33} % should be 0.33 instead of 1
    \brickcustom{4}{2}{cred}{0}{0}{2}{0.33} % should be 0.66 instead of 2
% 1) there is a problem with the pins
% GZ: yes, the problem arises because being dynamic with the heights, you need to be dynamic also with the pin positions. Now ajusted sith \weight, but still not optimal
% 2) can we make #6 absolute and not relative, so that it's x,y,z?
% GZ: can look into it, you want 0.33 instead of 1, with the same meaning as 7 right? (0.33 * \brickheight)
    \brickcustom{2}{4}{cwhite}{6}{0}{1}{1}

%\brickcustom{2}{4}{cred}{2}{0}{0}{6mm}
  \end{tikzpicture}
}

Here is one formal property of Lego: given two blocks of the same shape, you can always make a block of twice the shape.

More generally, to compose blocks in this way, you would only care about the lateral dimensions.
You can compose an~$a \times b \times c$ block with an ~$a \times b \times d$ block to obtain an~$a \times b \times( c + d)$ block.
Note that, for now,~$a$ and~$b$ are treated as labels, not as numbers.

We like to put this in formula as follows. We put the ingredients to the top, and the results at the bottom.

\begin{equation}
  \prftree{\text{block } a \times b \times c}{\text{block } a \times b \times d }{%
    \text{block } a \times b \times (c+d)
  }
\end{equation}

%
%\paragraph{Lego with colors}
%
%If you have legos of different colors, it becomes a bit more complicated. The rule now becomes:
%\begin{center}
%  \prftree{\begin{tikzpicture} \brickcustom{4}{2}{cred}{0}{0}{0}{0.33}\end{tikzpicture}}{\begin{tikzpicture} \brickcustom{4}{2}{cwhite}{0}{0}{0}{0.33}\end{tikzpicture}}{\begin{tikzpicture} \brickcustom{4}{2}{cblue}{0}{0}{0}{0.33}\end{tikzpicture}}
%  {\begin{tikzpicture}\brickcustom{4}{2}{cred}{0}{0}{0}{0.33}
%        \brickcustom{4}{2}{cwhite}{0}{0}{1}{0.33}
%        \brickcustom{4}{2}{cblue}{0}{0}{2}{0.33}\end{tikzpicture}}
%\end{center}
%
%\paragraph{Lego operations}
%
%There are also other ways you could compose the 3 blocks. You could slightly translate them, to create stairs.
%
%todographics{lego figure here: the 3 blocks composed in different ways, by some offset}
%
%You can also rotate them before composing.
%
%\todographics{lego figure here: the 3 blocks composed using rotations}
%
%What are the rules of this composition? Let's define a block as a solidly connected set of parallelipipedes (malformed cubes with different dimensions of the 3 sides). There are 3 kinds of faces: the faces pointing up, which have the pins, the faces pointing down, which have the holes for the pins, and the lateral faces.
%
%Connecting two blocks means that there should be at least one pin face of the lower block touching one hole face of the upper block; and, that there are no intersections of the solid blocks. Then, the ``interface'' of the blocks
%
%
%You can also put decorations; but if you do, you remove the possibility of connecting to all of them.
%
%\todographics{lego block with some decoration on top}
%
%  \section{Examples for Andrea}
%
\end{comment}
