% !TEX root = chapter-standalone.tex

\section{Domain theory and fixed points}
\label{sec:Monotonicity-and-fixed}

In this section we recall some fundamentals of domain theory.
It is used in computer science for defining denotational semantics~(see \eg~\cite{manes86}).
It is used in embedded systems for defining the semantics of models of computation~(see, \eg~\cite{lee10}).
What we need from domain theory is the least necessary to define \emph{least fixed points} and to use Kleene's theorem.

Domain theory builds on order theory by defining ``directed'' and ``complete'' partial orders.
These attributes play the same role as compactness in analysis: they will be used to make sure that certain sequences can converge to a fixed point.

\subsection{Directed and complete partial orders}

\begin{definition}[Directed set]
    \label{def:directed-set}
    In a poset $\posA = \tupp{\posAset, \posAleq}$, we say that a set~$\subA\setsubseteq\posAset$ is \emph{directed} if each pair of elements in~$\subA$ has an upper bound: for all~$\posela,\poselb \setin \subA$, there exists~$\poselc\setin \subA$ such that~$\posela\posleq \poselc$ and~$\poselb\posleq \poselc$.
\end{definition}

\todotext{\alphubel: @Andrea: verify condition: must }

\begin{definition}[Completeness]
    \label{def:cpo}
    A poset is a \emph{directed complete partial order} (\DCPO) if each of its directed subsets has a supremum (least of upper bounds).
    It is a \emph{complete partial order} (\CPO) if it also has a bottom.
\end{definition}

\begin{example}
    [Completion of $\nonNegReals$ to~$\nonNegRealsComp$]
    \label{exa:Rcomp}
    The poset $\tupp{\reals, \Rleq}$ is not a \CPO, because it lacks a bottom.

    The non-negative reals~$\nonNegReals=\makeset{x\setin\reals \colon x\geq0}$ have a bottom~$\posbot=0$, however, they are not a \DCPO because some of their directed subsets do not have an upper bound.
    For example, take~$\nonNegReals$, which is a subset of~$\nonNegReals$.
    Then~$\nonNegReals$ is directed, because for each~$a,b\setin\nonNegReals$, there exists~$c=\max\makeset{a,b}\setin\nonNegReals$ for which~$a\Rleq c$ and~$b\Rleq c$.

    One way to make~$\tupp{ \nonNegReals,\Rleq} $ a \CPO is by adding an artificial top element~$\postop$ that we think as ``a point at infinitely''.
    We can define then the completion
    \begin{equation}
        \nonNegRealsComp\definedas\nonNegReals\setunion\makeset{\postop},
    \end{equation} and extending the partial order~$\Rleq$ so that~$a\Rleq\postop$ for all~$a\setin\nonNegReals$.
\end{example}

\begin{example}
    Any lattice is a DCPO.
\end{example}
\begin{example}
    For any poset $\posA$, $\uppersets \posA$ is a CPO, because it is a bounded lattice.
\end{example}

\subsection{\scottcontinuity}

\scottcontinuity is a property of maps on DCPOs that is slightly stronger than monotonicity.

\begin{definition}[\scottcontinuity]
    \label{def:scott}
    A map~$\mora\colon\posA\toinPos\posB$ between DCPOs is \emph{\scottcontinuous{}} iff for each directed subset~$\subA\setsubseteq\posA$, the image~$\mora(\subA)$ is directed, and
    \begin{equation}
        \label{eq:scott-continuity-cond}
        \mora(\Sup \subA)=\Sup \mora(\subA).
    \end{equation}
\end{definition}
\begin{lemma}
    \scottcontinuity implies monotonicity.
\end{lemma}
\begin{proof}
    Consider a map~$\mora\colon\posA\toinPos\posB$ that is \scottcontinuous.
    Take two elements~$\posela, \poselb \setin \posA$ such that~$\posela\posleq\poselb$.
    The set~$ \subA =  \makeset{\posela, \poselb}$ is directed.
    % It follows that $\mora(\subA) = \makeset{\mora(\posela), \mora(\poselb)}$ is directed, which means that at least one
    % of $\mora(\posela) \posleq \mora(\poselb)$ and $\mora(\poselb) \posleq \mora(\posela)$ are true.
    From \cref{eq:scott-continuity-cond}, we know that
    \begin{equation*}
        \mora(\Sup \subA) = \mora(\poselb) = \Sup \makeset{\mora(\posela), \mora(\poselb)},
    \end{equation*}
    which implies that $\mora(\posela) \posleq \mora(\poselb)$.
    Therefore,~$\mora$ is monotone.
\end{proof}

\begin{marginfigure}
    \includesag{ceil_bis}
    \caption{The ceiling function is \scottcontinuous.}
    \label{fig:gmcdp_ceil}
\end{marginfigure}

\begin{remark}
    \scottcontinuity is not the same as the notion of continuity as used in analysis you might be familiar with.
    A map from the CPO~$\tupp{\Rcomp,\Rleq}$ to itself is \scottcontinuous iff it is nondecreasing and left-continuous.
    For example, the ceiling function~$\ela \mapsto\left\lceil \ela\right\rceil $ is not continuous in the usual sense, but it is \scottcontinuous (\cref{fig:gmcdp_ceil}).

    However, the name ``continuity'' for this property is aptly chosen.
    In analysis, a function is continuous if it preserves limits, in the sense that
    \begin{equation*}
        \lim_{n\to\infty}\mapa(a_n) = \mapa(\lim_{n\to\infty}a_n),
    \end{equation*}
    which is, in spirit, the same as \cref{eq:scott-continuity-cond}.
\end{remark}

\subsection{Least fixed points}

\begin{definition}[Least fixed points]
    \label{def:least-fixed}
    A \emph{fixed point} of $\mora\colon\posA\toinPos\posA$ is a point~$\ela$ such that $\mora(\ela)=\ela$.
    A \emph{least fixed point} of~$\mora\colon\posA\toinPos\posA$ is the minimum (if it exists) of the set of fixed points of~$\mora$:
    \begin{equation}
        \label{eq:lfp-one}
        \lfp(\mora)\,\,\definedas\,\,\min_{\posleq}\,\makeset{\ela \setin\posAset \colon \mora(\ela)=\ela}.
    \end{equation}
\end{definition}

In general, a function need not have a fixed point.
It also might have multiple fixed points; and also it that case there are might not be a \emph{least} fixed point.

However, the conditions for a least fixed point to exist are quite weak.
%
% \todotextjira{423}{@Andrea: So if multiple minima exist, we say there is no least fixed point?
%     If yes, perhaps say this explicitly, for clarity?
% }
% The equality in \cref{eq:lfp-one} can be relaxed to ``$\posleq$''.
Monotonicity of the map~$\mora$ plus completeness is sufficient to ensure existence.

\begin{lemma}
    \label{lem:CPO-fix-point-2}
    If~$\posA$ is a \CPO and~$\mora\colon\posA\toinPos\posA$ is monotone, then $\lfp(\mora)$ exists and is unique.
\end{lemma}
This is given as CPO Fixpoint Theorem II, 8.22 in~\cite{davey02}.

With the additional assumption of \scottcontinuity, Kleene's algorithm is a systematic procedure to find the least fixed point.

\begin{lemma}[Kleene's fixed-point theorem]
    \label{lem:kleene-1}
    % note: do not use \colon\linebreak[0], it will give an error
    % https://comp.text.tex.narkive.com/DriGWGQc/optional-linebreak-in-in-line-math
    Assume $\posA$ is a \CPO, and~$\mora:\linebreak[0]\posA\toinPos\posA$ is \scottcontinuous.
    Then the least fixed point of~$\mora$ is the supremum of the Kleene ascent chain
    \begin{equation}
        \label{eq:kleene-iteration}
        \posbot\posleq \mora(\posbot)\posleq \mora(\mora(\posbot))\posleq\cdots\posleq \mora^{(n)}(\posbot)\leq\cdots.
    \end{equation}
\end{lemma}
This is given as CPO fixpoint theorem I, 8.15 in \cite{davey02}.

\subsection{Example: party invite}

Consider again the party scenario of \cref{exa:party}.

Consider the case where a subset~$\subA \setsubseteq \setA$ of people decide to throw a party.
They then proceed to call all their friends, who accept, and,
if they were not invited already, enthusiastically call \emph{their} friends to extend the invite.
We want to find out what is the final group of people that will show up at the party.
We call this map~$\stylemaps{\phi} \colon \powerset \setA \sto \powerset \setA$, so that if~$\subA$ is the initial group,~$\stylemaps{\phi}(\subA)$ is the complete set of invites.

Note that this is related to the transitive closure operation, but we are only interested in the transitive closure from a certain initial set~$\subA$.

\begin{marginfigure}
    \includesag{party_invite_rel}
    \caption{Party invite relation.}
    \label{fig:party_invite_dp}
\end{marginfigure}

For example, consider the case in which the relation is as in \cref{fig:party_invite_dp}.
In this case, we would have
\begin{equation*}
    \stylemaps{\phi}(\Emptyset) = \Emptyset,
\end{equation*}
which means that, if nobody starts a party, no party takes place.
Jonathan does not invite anybody, so we would have
\begin{equation*}
    \stylemaps{\phi}(\makeset{\text{Jonathan}}) = \makeset{\text{Jonathan}}
\end{equation*}
If Gioele and Alessandro start the party, everybody will get invited:
\begin{equation*}
    \stylemaps{\phi}(\makeset{\text{Alessandro}, \text{Gioele}}) = \text{everybody}.
\end{equation*}
%
We can show that
\begin{enumerate}
    \item The function~$\stylemaps{\phi}$ can be computed as a fixed point.
    \item The recursive invite strategy corresponds to Kleene's iteration.
\end{enumerate}

We summarize the properties that we want the function $\phi$ to have.
Given an initial subset~$\subA$, we would like to find the set of people~$\subB = \stylemaps{\phi}(\subA)$ such that:
\begin{enumerate}
    \item $\subB$ contains the initial set~$\subA$:
          \begin{equation*}
              \label{eq:contains}
              \subA \setsubseteq \subB
          \end{equation*}
    \item $\subB$ is closed with respect to a certain invite relation~$\relA \colon \setA \sto \setA$.
          If~$\inrel \ela \relA \elb$, then~$\ela$ invites~$\elb$ to the party.
          Define the function
          \begin{equation*}
              \defmapperiod{\stylemaps{m}}{\powerset \setA}{\to}{\powerset \setA
              }{
                  \subB
              }{
                  \subB \setunion \bigcup_{\ela \setin \subB} \makeset{ \elb \setin \setA \colon \inrel \ela \relA \elb}
              }
          \end{equation*}
          This represents one iteration of the invite process: given a set~$\subB$, we add to~$\subB$ all invitees of each of the elements of~$\subB$.

          We are looking for a set~$\subB$ such that it is a fixed point of the invite function:
          \begin{equation*}
              \subB = \stylemaps{m}(\subB).
          \end{equation*}

    \item $\stylemaps{\phi}(\subA)$ is the smallest among all such sets that satisfy the two conditions above.
\end{enumerate}

Let~$\posA$ be the upper principal set of~$\subA$: given \cref{eq:contains}, we know that we want sets that contain at least~$\subA$:
\begin{equation*}
    \posA = \upit \subA  = \makeset{ \subB \setin \powerset \setA \colon \subA \setsubseteq \subB }.
\end{equation*}
The poset~$\posA$ is a sublattice of~$\powerset \setA$.
Note also that the bottom of~$\posA$ is~$\subA$.

In summary, we are looking for the smallest point of~$\posA$ that is closed to~$\stylemaps{m}$:
%
\begin{equation*}
    \stylemaps{\phi}(\subA) = \min_{\setsubseteq}\, \makeset{ \subB \setin \posA \colon \subB = \stylemaps{m}(\subB) }
\end{equation*}
Comparing this with \cref{eq:lfp-one}, we see that~$\stylemaps{\phi}(\subA)$ is the least fixed point of~$\stylemaps{m}$:
\begin{equation*}
    \stylemaps{\phi}(\subA) = \lfp(\stylemaps{m}).
\end{equation*}
%
Take Kleene's iteration in \cref{eq:kleene-iteration}:
\begin{equation*}
    \posbot\posleq \mora(\posbot)\posleq \mora(\mora(\posbot))\posleq\cdots\posleq \mora^{(n)}(\posbot)\leq\cdots.
\end{equation*}
Because the bottom of $\posA = \upit \subA$ is $\subA$, we can rewrite it as:
\begin{equation*}
    \subA \setsubseteq  \stylemaps{m}(\subA ) \setsubseteq \stylemaps{m}(\stylemaps{m}(\subA)) \setsubseteq \stylemaps{m}(\stylemaps{m}(\stylemaps{m}(\subA))) \ldots .
\end{equation*}
Each element of the sequence corresponds to one iteration of the invite algorithm.
