\section{Queries are functors from problem statements to solutions}

In this and the following chapters we are going to build towards the solution of co-design problems.
We will consider an arbitrary graph of design problems, in which nodes are design problems and edges are arbitary interconnections between functionality and resources, obtained through the operations of a traced monoidal category (series, parallel, feedback) plus the lattice structure (and, or) of design problems. On this structure we want to solve the query \FixFunMinRes (\cref{pro:FixFunMinRes}) or, symmetrically, \FixResMaxFun (\cref{pro:FixResMaxFun})

\todographics{Draw diagram}

We look at this from a compositional point of view. We will assume that we know the solution to \FixFunMinRes for each of the components. We think of the components as primitive blocks, because they are given in a catalogue format as a DPI, or they are special cases ($+$, $\times$, etc.) which we will solve as special cases.  Given the solution for the primitive blocks, we want to know what is the solution for \FixFunMinRes for the entire diagram.

What is the form of the solution that we expect? Given a DP $\adp: \funsp \profto \ressp$ we expect the solution to \FixFunMinRes to be a function that, given a fixed functionality~$\fun\in\funsp$, returns the minimal resources, which form an upper set. We call this function~$\ftoR_\adp$.

\begin{definition}
  \label{def:ftoR-dp}
  Given a DP~$\adp:\funsp\profto\ressp$
  we denote by~$\ftoR_{\adp}\colon \funsp\toinPos\Uressp$ the map that associates
  to each functionality~\fun the set of minimal resources sufficient to realize~\fun:
  \begin{eqnarray*}
    \ftoR_{\adp}\colon \funsp & \toinPos & \tup{\Uressp, \supseteq},\\
    \fun& \mapsto & \{ \res \in \ressp : \adp(\fun, \res)\}
  \end{eqnarray*}
  If a certain functionality~\fun is infeasible, then~$\ftoR(\fun)=\emptyset$.
\end{definition}

\todo{show why monotone}

Symmetrically, the solution to \FixResMaxFun is given by a function that we call~$\rtoF_\adp$.

\begin{definition}
  \label{def:rtoF-dp}
  Given a DPI~$\tup{ \funsp,\ressp,\impsp,\prov,\req}$,
  define the map~$\rtoF_{\adp}\colon \ressp\toinPos \tup{\Lfunsp, \subseteq}$ that associates
  to each resource~\res the set of functionalities which can be realized with~$\res$:
  \begin{eqnarray*}
    \rtoF_{\adp}\colon \ressp & \toinPos & \tup{\Lfunsp, \subseteq},\\
    \res& \mapsto & \{ \fun \in \funsp : \adp(\fun, \res)\}.
  \end{eqnarray*}
  If a certain resource~\res only leads to infeasible functionalities, then~$\rtoF(\res)=\emptyset$.
\end{definition}

\todo{show why monotone}

A question that arises naturally is whether the map~$\ftoR_\adp$ is sufficient to reconstruct the original DP.
The answer is yes.
We will prove that~$\ftoR_\adp$ is a morphism in a category called \UPos, and that this category is equivalent (\cref(\cref{def:cat-equivalence}) to \DP, therefore being traced monoidal with a lattice structure.
In fact, \FixFunMinRes can be seen as a functor from \DP to \UPos.
Symmetrically,~$\rtoF_\adp$ is a morphism in a category \LPos equivalent to \DP and \FixResMaxFun can be seen as the functor from \DP to \LPos.

  \todographics{@Gioele: put here }



\subsection{$\UPos$ and $\LPos$ categories}

\begin{definition}[Category \UPos]
\label{def:upos_cat}
The category \UPos consists of:
\begin{compactenum}
    \item \emph{Objects}: objects are posets;
    \item \emph{Morphisms}: given objects~$\Obja,\Objb\in \Ob_\UPos$, morphisms from~$\Obja$ to~$\Objb$ are monotone maps of the form~$\mora \colon \Obja \to \Up{\Objb}$.
    \item \emph{Composition of morphisms}: Given morphisms $\mora\colon \Obja \to \Up{\Objb}$,~$\morb\colon \Objb\to \Up{\Objc}$, their composition is given as
    \begin{equation}
    \begin{aligned}
        \mora \mthen \morb \colon \Obja&\to \Up{\Objc}\\
        \Objael&\mapsto \bigcup_{\Objbel\in \mora(\Objael)}\morb(\Objbel);
    \end{aligned}
    \end{equation}
    \item \emph{Identity morphism}: given an object~$\Obja\in \Ob_\UPos$, the identity morphism is given by the application of the upper closure operator:~$\catid_\Obja(\Objael)\definedas \upit\{\Objael\}$.
\end{compactenum}
\end{definition}

\todo{J: maybe we could name this category using the standard notation for Kleisli categories? i.e. $\Pos_{\Up{} } $.}

\begin{remark}
Note that the composition of morphisms in this category corresponds to the generalization of the series operator for boolean profunctors.
\end{remark}

Analogously, we can define the \LPos category.
\begin{definition}[Category \LPos]
\label{def:lpos_cat}
The category \LPos consists of:
\begin{compactenum}
    \item \emph{Objects}: objects are posets;
    \item \emph{Morphisms}: given objects~$\Obja,\Objb\in \Ob_\LPos$, morphisms from~$\Obja$ to~$\Objb$ are monotone maps of the form~$\mora \colon \Obja \to \Lo{\Objb}$.
    \item \emph{Composition of morphisms}: Given morphisms~$\mora \colon \Obja \mto \Lo{\Objb}$,~$\morb \colon \Objb\mto \Lo{\Objc}$, their composition is given by
    \begin{equation}
    \begin{aligned}
        \mora \mthen \morb \colon \Obja &\mto \Lo{\Objc}\\
        \Objael&\mapsto \bigcup_{\Objbel\in \mora (\Objael)}\morb(\Objbel);
    \end{aligned}
    \end{equation}
    \item \emph{Identity morphism}: given an object $\Obja\in \Ob_\LPos$, the identity morphism is given by the application of the lower closure operator:~$\catid_\Obja(\Objael)\definedas \downit\{\Objael\}$.
\end{compactenum}
\end{definition}

We now show that \UPos and \LPos are indeed categories.

\begin{lemma}
\label{lem:upos_lpos_cats}
\UPos and \LPos are categories.
\end{lemma}

\begin{proof}
We prove that \UPos is a category. The proof for \LPos is analogous. In the following, we show unitality and associativity.
\paragraph*{Unitality} Given~$\mora\colon \Obja \mto \Up{\Objb}$, we have:
\begin{equation*}
    \begin{aligned}
    \left( \mora \mthen \catid_\Objb\right)(\Objael)&=\bigcup_{\Objbel\in \mora(\Objael)}\catid_\Objb(\Objbel)\\
    &=\bigcup_{\Objbel\in \mora(\Objael)}\upit\{\Objbel\}\\
    &=\bigcup_{\Objbel\in \mora(\Objael)}\{\Objbel'\in \Objb \colon \Objbel\posleq_\Objb \Objbel' \}
    \end{aligned}
\end{equation*}
We know that~$\mora(\Objael)$ is an upperset:
\begin{equation*}
    \begin{aligned}
    \mora(\Objael)&=\bigcup_{\Objbel\in \mora(\Objael)}\{\Objbel\}\\
    &=\bigcup_{\Objbel\in \mora(\Objael)}\{ \Objbel'\in \Objb \colon \Objbel\posleq_\Objb \Objbel'\}.
    \end{aligned}
\end{equation*}
Therefore,~$\left( \mora \mthen \catid_\Objb\right)(\Objael)=\mora(\Objael)$ for all~$\Objael\in \Obja$. Similarly, we have:
\begin{equation*}
    \begin{aligned}
    (\catid_\Obja \mthen \mora)(\Objael)&=\bigcup_{\Objael'\in \catid_\Obja(\Objael)}\mora(\Objael')\\
    &=\bigcup_{\Objael'\in \upit \{\Objael\}}\mora(\Objael')\\
    &=\mora(\Objael),
    \end{aligned}
\end{equation*}
where the last equality holds since~$\mora$ is a monotone function and~$\mora(\Objael')\subseteq \mora(\Objael)$ for all~$\Objael'\in \upit \{\Objael\}$.
\paragraph*{Associativity} Let's consider three morphisms~$\mora\colon \Obja \mto \Up{\Objb}$,~$\morb\colon \Objb\mto \Up{\Objc}$, and~$\morc\colon \Objc\mto \Up{\Objd}$. We have:
\begin{equation*}
    \begin{aligned}
    \left( \left( \mora \mthen \morb\right)\mthen\morc\right)(\Objael)&=\bigcup_{\Objcel \in \left( \bigcup_{\Objbel \in \mora(\Objael)}\morb(\Objbel)\right)}\morc(\Objcel)\\
    &=\bigcup_{\Objbel\in \mora(\Objael)}\bigcup_{\Objcel\in \morb(\Objbel)}\morc(\Objcel)\\
    &=\left( \mora \mthen \left( \morb\then \morc\right)\right)(\Objael).
    \end{aligned}
\end{equation*}
Therefore, \UPos is a category.
\end{proof}

%\begin{definition}[Equivalence of categories]
%\label{def:equivalence_cat}
%An \emph{equivalence} between two categories \CatC and \CatD is given by:
%\begin{compactenum}
%\item A pair of functors~$\funa,\funb$ of the form:
%    \begin{equation}
%    \includesag{cat_equiv}
%    \end{equation}
%\item natural isomorphisms~$\funa\then \funb\cong \catid_\CatC$ and~$\funb\then \funa\cong \catid_\CatD$.
%\end{compactenum}
%\end{definition}
%\todo{This definition should be moved to the chapter on adjunctions (and is perhaps already there?).}


We can show that \UPos and \LPos are equivalent categories (\cref{def:cat-equivalence}).

\begin{lemma}
\label{lem:ulposequiv}
\UPos and \LPos are equivalent: there exists a pair of functors
\begin{equation}
    \begin{aligned}
    \funeqa\colon \UPos&\fto \LPos,\\
    \funeqb\colon \LPos&\fto \UPos,
    \end{aligned}
\end{equation}
such that~$\funeqa \then \funeqb=\funid_{\UPos}$ and~$\funeqb \then \funeqa=\funid_{\LPos}$, where~$\funid_{\UPos}$ and~$\funid_{\LPos}$ are the identity functors on $\UPos$ and~$\LPos$, respectively.
\end{lemma}

\begin{proof}
To prove this, we need to define the needed functors and to show that they satisfy the listed properties.
We choose the functors to be the ones that map a poset~$\posA$ in a category to its opposite version~$\posA\op$ in another category.
Given a morphism~$\mora\colon \Obja \mto \Up{\Objb}$ in \UPos, we have:
\begin{equation*}
    \begin{aligned}
    \funeqa(\mora)\colon \Obja\op &\mto \Lo(\Objb \op)\\
    \Objael&\mapsto \mora(\Objael).
    \end{aligned}
\end{equation*}
Given a morphism~$\morb\colon \Obja \mto \Lo{\Objb}$ in \LPos, we have:
\begin{equation*}
    \begin{aligned}
    \funeqb(\morb)\colon \Obja\op &\mto \Up(\Objb \op)\\
    \Objael&\mapsto \morb(\Objael).
    \end{aligned}
\end{equation*}
\paragraph*{$\funeqa$ and~$\funeqb$ are functors}
\begin{itemize}
    \item \emph{Preservation of identites}: Given~$\Obja\in \Ob_\UPos$, we have:
    \begin{equation*}
        \begin{aligned}
            \funeqa(\catid_\Obja)&=\upit_\Obja\{\Objael\}\\
            &=\downit_{\Obja\op}\{\Objael\}\\
            &=\catid_{\Obja\op},
        \end{aligned}
    \end{equation*}
where~$\catid_\Obja$ is an identity morphism in \UPos, and~$\catid_{\Obja\op}$ is an identity morphism in \LPos. Similarly, given~$\Obja\in \Ob_\LPos$ we have:
\begin{equation*}
    \begin{aligned}
    \funeqb(\catid_\Obja)&=\downit_\Obja\{\Objael\}\\
    &=\upit_{\Obja\op}\{\Objael\}\\
    &=\catid_{\Obja\op}.
    \end{aligned}
\end{equation*}
\item \emph{Preservation of composition}: This can be easily seen as follows. Given any~$\mora\in \HomSet{\UPos}{\Obja}{\Objb}$,~$\morb\in \HomSet{\UPos}{\Objb}{\Objc}$:
\begin{equation*}
    \begin{aligned}
    \funeqa(\mora \mthen \morb)&=\mora \mthen \morb\\
    &=\funeqa(\mora)\mthen \funeqa(\morb).
    \end{aligned}
\end{equation*}
Similarly, given any~$\mora\in \HomSet{\LPos}{\Obja}{\Objb}$,~$\morb\in \HomSet{\LPos}{\Objb}{\Objc}$:
\begin{equation*}
    \begin{aligned}
    \funeqb(\mora \mthen \morb)&=\mora \mthen \morb\\
    &=\funeqb(\mora)\mthen \funeqb(\morb).
    \end{aligned}
\end{equation*}
\end{itemize}
\paragraph*{Compositions return identity functors}
We want to show that by composing the two functors we obtain the identity functors in \UPos and \LPos, respectively. Clearly, comosing the two functors returns the identity on the objects, since for any poset~$\posA$, one has~$(\posA\op)\op=\posA$. The functors act on morphisms by ``flipping the context'', and ``flipping'' twice is the ``same'' as not flipping.
\end{proof}

We can show that~$\UPos$ and~$\LPos$ are monoidal categories.


\begin{lemma}
\label{lem:upos_moncat}
\UPos is a monoidal category with the following additional structure:
\begin{enumerate}
    \item \emph{Tensor product~$\mtimescat$}: On objects, the tensor product corresponds to the product of posets. Given two morphisms~$\mora\colon \Obja\mto \Up{\Objb}$ and~$\morb\colon \Objc\mto \Up{\Objd}$, we have:
    \begin{equation}
    \begin{aligned}
        \mora \mtimescat \morb\colon \Obja \times \Objc &\mto \Up(\Objb\times \Objd)\\
        \tup{\Objael,\Objcel}&\mapsto \mora(\Objael)\times \morb(\Objcel).
    \end{aligned}
    \end{equation}
    Note that the Cartesian product of upper sets is an upper set.
    \item \emph{Unit}: The unit is the identity poset: the poset with a singleton carrier set and only the identity relation.
    We denote this by~$\singleton$.
    \item \emph{Left unitor}: The left unitor is given by the pair of morphisms
    \begin{equation}
        \begin{aligned}
            \leftunitor_\posA\colon \styleobj{\singleton}\mtimescat \Obja &\mto \Up{\Obja}\\
            \tup{\styleobj{\singletonel},\Objael}&\mapsto \upit\{\Objael\},
        \end{aligned}
    \end{equation}
    and
    \begin{equation}
        \begin{aligned}
            \leftunitor_\posA^{-1}\colon \Obja &\mto \Up(\styleobj{\singleton}\mtimescat \Obja) \\
            \Objael&\mapsto \{\styleobj{\singletonel}\} \times \upit \{\Objael\}.
        \end{aligned}
    \end{equation}
    \item \emph{Right unitor}: The right unitor is given by the pair of morphisms
    \begin{equation}
        \begin{aligned}
            \rightunitor_\posA\colon \Obja\mtimescat \styleobj{\singleton}  &\mto \Up{\Obja}\\
            \tup{\Objael,\styleobj{\singletonel}}&\mapsto \upit\{\Objael\},
        \end{aligned}
    \end{equation}
    and
    \begin{equation}
        \begin{aligned}
            \rightunitor_\posA^{-1}\colon \Obja &\mto \Up( \Obja \mtimescat \styleobj{\singleton}) \\
            \Objael&\mapsto \upit \{\Objael\} \times \{\styleobj{\singletonel}\}.
        \end{aligned}
    \end{equation}
    \item \emph{Associator}: The associator is given by the pair of morphisms:
    \begin{equation}
        \begin{aligned}
            \associator_{\Obja\Objb,\Objc}\colon (\Obja\mtimescat \Objb)\mtimescat \Objc &\mto \Up \Obja\times (\Up \Objb \times \Up \Objc)\\
            \tup{\tup{\Objael,\Objbel},\Objcel}&\mapsto \upit\{\Objael\}\times (\upit\{\Objbel\}\times \upit\{\Objcel\}),
        \end{aligned}
    \end{equation}
    and
    \begin{equation}
        \begin{aligned}
            \associator_{\Obja,\Objb\Objc}\colon \Obja\mtimescat (\Objb\mtimescat \Objc) &\mto (\Up \Obja\times \Up \Objb) \times \Up \Objc\\
            \tup{\Objael,\tup{\Objbel,\Objcel}}&\mapsto (\upit\{\Objael\}\times \upit\{\Objbel\})\times \upit\{\Objcel\}.
        \end{aligned}
    \end{equation}
\end{enumerate}
\end{lemma}
\begin{proof}
    \todojira{238}{type proof}
\end{proof}

We now want to show that \UPos can be equipped to become a symmetric monoidal category.
To do so, we first need the following two facts.

\begin{lemma}
  \label{lem:unpack_u_functor}
  Given posets~$\posA,\posB$, a monotone map~$\mora \colon \posA \to \posB$, and a family of singleton sets~$\{S_i\}_{i\in I}$, with~$S_i=\{s_i\}$,~$s_i\in \posA$, the following equality holds:
  \begin{equation}
    \label{eq:lemma_unpack}
    \upit \left( \bigcup_{\posAel \in \upit \bigcup_{i\in I}S_i}\{\mora(\posAel)\}\right)= \upit \left( \bigcup_{i\in I} \{\mora(s_i)\}\right).
  \end{equation}
\end{lemma}

\todotextjira{241}{the phrasing here seems unnecessarily complicated... maybe we phrase the lemma as something like ``$\upit  f( \upit S) = \upit f(S) $" for any set $S$ and any monotone map $f$ ??}

\begin{proof}
  We first want to show that:
  \begin{equation}
    \label{eq:unpack_1}
    \underbrace{\upit \left(\bigcup_{\posAel \in \upit \bigcup_{i\in I}S_i}\{\mora(\posAel)\} \right)}_{\star}\subseteq \upit \underbrace{\left( \bigcup_{i\in I}\{\mora(s_i)\}\right)}_{\diamond}.
  \end{equation}
  Let's take a
  \begin{equation}
    \posBel \in \upit\left( \bigcup_{\posAel \in \upit \bigcup_{i\in I}S_i}\{\mora(\posAel)\}\right).
  \end{equation}
  If we have such a~$\posBel$, it means that there exists a
  \begin{equation}
    \posBel'\in \bigcup_{\posAel\in \upit\bigcup_{i\in I}S_i}\{\mora(\posAel)\}
  \end{equation}
  such that~$\posBel'\posleq_\posB \posBel$, and hence there is a~$\posAel'\in \upit \bigcup_{i\in I} S_i$ such that~$\posBel'=\mora(\posAel')$.
  Consequently, there must exist an~$i'\in I$ such that~$s_{i'}\posleq_\posA \posAel'$. The monotonicity of~$\mapa$ implies:
  \begin{equation}
    \mora(s_{i'})\posleq_\posA \mora(\posAel')=\posBel'\posleq_\posB \posBel.
  \end{equation}
  We know that~$s_{i'}\in \diamond$ and any~$\posBel^*\in \posB$ satisfying~$\mora(s_{i'})\posleq_\posB \posBel^*$ belongs to~$\upit \diamond$.
  Therefore,~$\star\subseteq \upit \diamond$, which proves the validity of \cref{eq:unpack_1}.

  We now want to show that:
  \begin{equation}
    \label{eq:unpack_2}
    \upit \left(\bigcup_{\posAel \in \upit \bigcup_{i\in I}S_i}\{\mora(\posAel)\} \right)\supseteq \upit \left( \bigcup_{i\in I}\{\mora(s_i)\}\right).
  \end{equation}
  By now taking a
  \begin{equation}
    \posBel\in \upit \left( \bigcup_{i\in I}\{\mora(s_i)\}\right),
  \end{equation}
  we know that there is a~$i'\in I$ such that~$\mora(s_{i'})\posleq_\posB \posBel$.
  Furthermore, we know that~$\mora(s_{i'})\in \diamond$.
  Therefore, any~$\posBel^*\posleq_\posB \mora(s_{i'})$ must be in~$\upit \diamond$, meaning that~$\posBel\in \star$, and proving the validity of \cref{eq:unpack_2}.

  The validity of \cref{eq:unpack_1} and \cref{eq:unpack_2} implies \cref{eq:lemma_unpack}.
\end{proof}

\begin{lemma}
  \label{lem:unpack_part_2}
  Given posets~$\posA,\posB$ and a monotone map~$\mora\colon \posA\to \posB$, we have:
  \begin{equation}
    \upit \left( \bigcup_{\posAel'\in \upit \{\posAel\}} \{\mora(\posAel')\}\right)=\upit \{\mora(\posAel)\}.
  \end{equation}
\end{lemma}
\begin{proof}
  The proof follows from \cref{lem:unpack_u_functor}, by considering a family of singleton sets consisting solely of the set~$\{\posAel\}$.
\end{proof}
\todotextjira{243}{I wouldn't make the above its own lemma, that seems a bit silly/overkill.}
We can now show that the~$\Uendo$ endofunctor is indeed a functor.

\begin{lemma}
    \label{lem:UPos-is-sym-mon}
    $\tup{\UPos,\mtimescat,\idmoncat}$ from \cref{lem:upos_moncat} equipped with the braiding isomorphism
    \begin{equation}
        \label{eq:Upos-braiding}
        \begin{aligned}
        \braiding_{\Obja,\Objb}\colon \Obja \mtimescat \Objb &\mtoiso \Objb \mtimescat \Obja\\
            \tup{\Objael,\Objbel}&\mapsto \upit\{\Objbel\} \times \upit\{\Objael\},
        \end{aligned}
    \end{equation}
    defined for all~$\Obja,\Objb\in \Ob_{\UPos}$, forms a symmetric monoidal category.
\end{lemma}
\begin{proof}
We first show that the braiding defines an isomorphism.
In other words, we want to show
\begin{equation*}
    \braiding_{\Obja,\Objb}\mthen \braiding_{\Objb,\Obja}=\catid_{\Obja \mtimescat \Objb}.
\end{equation*}
One has
    \begin{equation*}
        \begin{aligned}
            (\braiding_{\Obja,\Objb}\mthen \braiding_{\Objb,\Obja})(\Objael,\Objbel)&=\braiding_{\Objb,\Obja}(\upit\{\Objbel\} \times \upit\{\Objael\})\\
            &=\upit\{\Objael\} \times \upit\{\Objbel\}\\
            &=\catid_{\Obja\mtimescat \Objb}(\Objael,\Objbel).
        \end{aligned}
    \end{equation*}
Note that this comes from the fact that~$\braiding$ is an involute.
We now show naturality. Consider~$\mora \colon \Obja \mto \uppersets \Objb$,~$\morb\colon \Objc \mto \uppersets \Objd$.
One has
    \begin{equation}
        \label{eq:braid-upos-natural-a}
    \begin{aligned}
        \left(\left( \mora \mtimescat \morb\right)\mthen \braiding_{\uppersets \Objb, \uppersets \Objd}\right)(\Objael,\Objcel)&=
        \tup{\mora(\Objael),\morb(\Objcel)}\mthen \braiding_{\uppersets \Objb, \uppersets \Objd}\\
        &=\tup{\bigcup_{\Objcel'\in \morb(\Objcel)}\upit \Objcel',\bigcup_{\Objael'\in \mora(\Objael)}\upit \Objael'}.
    \end{aligned}
    \end{equation}
    On the other hand:
    \begin{equation}
        \label{eq:braid-upos-natural-b}
    \begin{aligned}
        \left(\braiding_{\uppersets \Objd, \uppersets \Objb}\mthen \left( \mora \mtimescat \morb\right)\right)(\Objael,\Objcel)&=
        \tup{\upit\{\Objcel\},\upit\{\Objael\}}\mthen \left( \mora \mtimescat \morb\right)\\
        &=\tup{\bigcup_{\Objcel'\in \upit\{\Objcel\}} \morb(\Objcel'),\bigcup_{\Objael'\in \upit\{\Objael\}}\mora(\Objael')}.
    \end{aligned}
    \end{equation}
    Clearly, from \cref{lem:unpack_u_functor} and \cref{lem:unpack_part_2} we know that \cref{eq:braid-upos-natural-a} and \cref{eq:braid-upos-natural-b} are equivalent, proving naturality.
    We now just need to show hexagon identities.
    \todo{Discuss with johnny whether we need to actually write it down.}
\end{proof}

\begin{definition}[Trace in \UPos]
    \label{def:trace-UPos}
    Given a morphism~$\mora\colon \Obja \mtimescat \Objc \mto \uppersets(\Objb\mtimescat \Objc)$ in \UPos, its trace in is defined as:
    \begin{equation}
        \begin{aligned}
            \Tr_{\Obja,\Objb}^{\Objc}(\mora)\colon \Obja &\mto \uppersets \Objb\\
            \Objael & \mapsto \{\Objbel \in \Objb \mid \bigvee_{\Objcel \in \Objc}\tup{\Objbel, \Objcel}\in \mora(\Objael,\Objcel)\}.
        \end{aligned}
    \end{equation}
\end{definition}
\begin{lemma}\label{lem:UPos-is-traced}
  $\tup{\UPos,\mtimescat, \idmoncat,\braiding}$ equipped with the trace operation defined in \cref{def:trace-UPos} is a traced monoidal category.
\end{lemma}
\begin{proof}
    We have already checked that~$\tup{\UPos,\mtimescat, \idmoncat,\braiding}$ forms a symmetric monoidal category.
    We check the trace axioms one by one.
    \paragraph*{Naturality I}
    \paragraph*{Naturality II}
    \paragraph*{Vanishing}
    Given any~$\Obja,\Objb\in \Ob_\UPos$ and~$\mora\colon \Obja \mto \uppersets \Objb$ in \UPos, one has
    \begin{equation*}
        \begin{aligned}
            \Tr_{\Obja,\Objb}^{\singleton}(\mora)(\Objael)&=\{\Objbel \in \Objb \mid \tup{\Objbel,\singletonel}\in (\mora\times \catid_{\singleton})(\Objael,\singletonel)\}\\
            &=\mora(\Objael).
        \end{aligned}
    \end{equation*}
    Furthermore, given any~$\Obja,\Objb,\Objc,\Objd \in \Ob_\UPos$ and~$\mora\colon \Obja \times \Objc \times \Objd\mto \Objb \times \Objc \times \Objd$, one has
    \begin{equation}
        \label{eq:vanish-upos-a}
    \begin{aligned}
        \Tr_{\Obja,\Objb}^{\Objc\times \Objd}(\mora)(\Objael)&=\left\{\Objbel \in \Objb \mid \bigvee_{\tup{\Objcel,\Objdel}\in \Objc\times \Objd} \tup{\Objbel,\Objcel,\Objdel}\in \mora(\Objael,\Objcel,\Objdel) \right\}
    \end{aligned}
    \end{equation}
    To check the second vanishing axiom, we also write:
    \begin{equation*}
    \begin{aligned}
        \Tr_{\Obja\times \Objc,\Objb\times \Objc}^{\Objd}(\mora)(\Objael,\Objcel)&=\left\{\tup{\Objbel,\Objcel}\in \Objb\times \Objc \mid \bigvee_{\Objdel\in \Objd} \tup{\Objbel,\Objcel,\Objdel} \in \mora(\Objael,\Objcel,\Objdel) \right\}.
    \end{aligned}
    \end{equation*}
    Therefore, we can write:
    \begin{equation}
        \label{eq:vanish-upos-b}
    \begin{aligned}
        \Tr_{\Obja,\Objb}^{\Objc}\left(\Tr_{\Obja\times \Objc,\Objb\times \Objc}^{\Objd}(\mora)\right)(\Objael)&=
        \left\{\Objbel \in \Objb\mid \bigvee_{\Objcel \in \Objc}\tup{\Objbel, \Objcel}\in \Tr_{\Obja\times \Objc,\Objb\times \Objc}^{\Objd}(\mora)(\Objael,\Objcel)\right\}\\
        &=\left\{ \Objbel \in \Objb\mid \bigvee_{\Objcel \in \Objc}\tup{\Objbel, \Objcel}\in \left\{ \tup{\Objbel',\Objcel'}\in \Objb\times \Objc \mid \bigvee_{\Objdel\in \Objd}\tup{\Objbel',\Objcel',\Objd}\in \mora(\Objael,\Objcel',\Objdel)\right\}\right\}\\
        &=\left\{ \Objbel \in \Objb\mid \bigvee{\Objcel\in \Objc}\left(\bigvee_{\Objdel \in \Objd} \tup{\Objbel,\Objcel,\Objdel}\in \mora(\Objael,\Objcel,\Objdel) \right)\right\}\\
        &=\left\{\Objbel \in \Objb \mid \bigvee_{\tup{\Objcel,\Objdel}\in \Objc\times \Objd} \tup{\Objbel,\Objcel,\Objdel}\in \mora(\Objael,\Objcel,\Objdel) \right\}.
    \end{aligned}
    \end{equation}
    Clearly, \cref{eq:vanish-upos-a} and \cref{eq:vanish-upos-b} are equivalent, proving the second vanishing axiom.
    \paragraph*{Superposing}
    Given any~$\Obja,\Objb,\Objc\in \Ob_\UPos$ and~$\mora\colon \Obja\times \Objc \mto \Objb \times \Objc$, one has:
    \begin{equation}
        \label{eq:superposing-upos-b}
        \begin{aligned}
        \Tr_{\Objd\times \Obja, \Objd\times \Objb}^{\Objc}(\catid_\Objd \times \mora)(\Objdel,\Objael)&=
        \left\{ \tup{\Objdel, \Objbel}\in \Objd \times \Objb \mid \bigvee_{\Objcel \in \Objc}\tup{\Objdel,\Objbel, \Objcel}\in (\catid_\Objd \times \mora)(\Objdel,\Objael, \Objcel)\right\}\\
            &=\left\{ \tup{\Objdel, \Objbel}\in \Objd \times \Objb \mid \bigvee_{\Objcel \in \Objc} (\Objdel \in \catid_\Objd(\Objdel))\wedge (\tup{\Objbel, \Objcel}\in \mora(\Objael, \Objcel))\right\}\\
            &=\left\{ \tup{\Objdel, \Objbel}\in \Objd \times \Objb \mid \bigvee_{\Objcel \in \Objc} (\Objdel \in \upit \{\Objdel\})\wedge (\tup{\Objbel, \Objcel}\in \mora(\Objael, \Objcel))\right\}\\
            &=\left\{ \tup{\Objdel, \Objbel}\in \upit\{\Objdel\} \times \Objb \mid \bigvee_{\Objcel \in \Objc}  \tup{\Objbel, \Objcel}\in \mora(\Objael, \Objcel)\right\}\\
            &=\tup{\upit\{\Objdel\}, \left\{\Objbel \in \Objb \mid \bigvee_{\Objcel \in \Objc}  \tup{\Objbel, \Objcel}\in \mora(\Objael, \Objcel)\right\}}\\
        \end{aligned}
    \end{equation}
    On the other hand, one has:
    \begin{equation}
        \label{eq:superposing-upos-b}
    \begin{aligned}
        \catid_\Objd \times \Tr_{\Obja,\Objb}^{\Objc}(\mora)(\Objdel,\Objael)&=
        \tup{\upit\{\Objdel\},\left\{ \Objbel \in \Objb \mid \bigvee_{\Objcel\in \Objc}\tup{\Objbel,\Objcel}\in \mora(\Objael,\Objcel)\right\}}.
    \end{aligned}
    \end{equation}
    Clearly, \cref{eq:superposing-upos-a} and \cref{eq:superposing-upos-b} are equivalent, proving the superposing axiom.
    \paragraph*{Yanking}
    Consider~$\Obja\in \Ob_\UPos$. One has
    \begin{equation*}
    \begin{aligned}
        \Tr_{\Obja,\Obja}^{\Obja}(\braiding_{\Obja,\Obja})(\Objael)&=\{ \Objael'\in \Obja \mid \bigvee_{\Objael''\in \Obja}\tup{\Objael',\Objael''}\in \braiding_{\Obja,\Obja}(\Objael,\Objael'')\}\\
        &=\{ \Objael'\in \Obja \mid \bigvee_{\Objael''\in \Obja}\tup{\Objael',\Objael''}\in \upit\{\Objael''\}\times \upit\{ \Objael\}\}\\
        &=\{ \Objael'\in \Obja \mid \bigvee_{\Objael''\in \Obja} (\Objael'\in \upit\{\Objael''\}) \wedge(\Objael'' \in \upit\{ \Objael\})\}\\
        &=\{ \Objael'\in \Obja \mid \Objael'\in \upit\{\Objael\}\}\\
        &=\upit \{\Objael\}\\
        &=\catid_\Obja(\Objael),
    \end{aligned}
    \end{equation*}
    proving the yanking axiom.
  \todotextjira{339}{@Gioele: S how UPos traced}
\end{proof}

\begin{lemma}\label{lem:UPos-is-traced}
    The homsets of \UPos are bounded lattices.
  \end{lemma}
  \begin{proof}
    \todotextjira{339}{@Gioele: Show UPos has lattice structure}
  \end{proof}
  
  

\section{From~$\DP$ to~$\UPos$ and~$\LPos$}
\begin{lemma}
\label{lem:covfunctor}
There is a \emph{functor}~$\cofun\colon \DP \fto \UPos$ which maps:
\begin{compactenum}
\item An object (poset) in \DP to the same object (poset) in \UPos.
\item A morphism~$\stylemorph{d}\in \HomSet{\DP}{\funsp}{\ressp}$ to the morphism~$\stylemorph{h_d}\in \HomSet{\UPos}{\funsp}{\ressp}$, where:
\begin{equation}
\begin{aligned}
    \stylemorph{h_d}\colon \funsp\op &\toinPos \tup{\Up{\ressp},\subseteq}\\
    \fun^*&\mapsto \{\res \in \ressp\mid d(\fun^*,\res)=\true\}.
\end{aligned}
\end{equation}
\end{compactenum}
\end{lemma}

\begin{lemma}
\label{lem:confunctor}
There is a \emph{contravariant functor} $\confun\colon \DP \fto \LPos$ which maps:
\begin{compactenum}
\item An object (poset) of \DP to the same object (poset) in \LPos.
\item A morphism $\dprob \in \HomSet{\DP}{\funsp}{\ressp}$ to the morphism~$\morb\in \HomSet{\LPos}{\ressp}{\funsp}$, where:
\begin{equation*}
    \begin{aligned}
    \morb\colon \ressp &\to \Lo{\funsp}\\
    \res&\mapsto \{ \fun \in \funsp \mid \dprob(\fun,\res)=\true\}.
    \end{aligned}
\end{equation*}
\end{compactenum}
\end{lemma}

\todojira{240}{I have proofs for this and for many other things handwritten. Will type them once we decide we want this to be in the book. There is a nice interpretation with an endofunctor Dual, which commutes with the aforementioned ones, meaning that you can solve and then convert to lowersets, or dualize , solve, and then convert to upper sets.}

\todotext{@Gioele: we need to show that they are equivalent, that the functor preserves traces, and meet/join}