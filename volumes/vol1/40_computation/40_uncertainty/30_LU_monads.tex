% !TEX root = chapter-standalone.tex

%
%\section{Using monads to understand uncertainty}
%
%\AC{is this a thing?? }
%Take the $\mathsf{Unc}$ functor $\mathsf{Unc}\colon \DP\to \DP$ which
%\begin{enumerate}
%  \item Maps an object $P$ in \DP (poset) to its twisted arrow category $\twisted{P}$, representing a \SY{poset} interval.
%  \item Maps a morphism in \DP $d\colon \funsp \profto \ressp$ to $\tup{\low d,\upp d}$, where
%  \begin{equation}
%    \begin{aligned}
%      \low d\colon \F{F_{\low}}&\profto \R{R_{\low}},\\
%      \upp d\colon \F{F_{\upp}}&\profto \R{R_{\upp}},
%    \end{aligned}
%  \end{equation}
%  and $\tup{\low d,\upp d}$ is a boolean profunctor of the form
%  \begin{equation}
%    \begin{aligned}
%      &\tup{\low d,\upp d}\colon \left(\F{F_{\low}}\times \F{F_{\upp}} \right)\op \times \left(\R{R_{\low}}\times \R{R_{\upp}} \right)\toinPos \Bool\\
%      &\tup{\tup{\F{f_{\low}},\F{f_{\upp}}}^*, \tup{\R{r_{\low}},\R{r_{\upp}}}}\mapsto \low d(\F{f_{\low}}^*,\R{r_{\low}})\wedge \upp d(\F{f_{\upp}}^*,\R{r_{\upp}})
%    \end{aligned}
%  \end{equation}
%\end{enumerate}
%
%Is this a functor?
%
%\begin{proof}
%  Consider two \SY{design problems} $f\colon \F{A}\profto \R{B}$ and $g\colon \F{B}\profto \R{C}$.
%
%  We know that
%  \begin{equation}
%    \begin{aligned}
%      \unc(f)&\colon \left( \F{A_{\low}}\times \F{A_{\upp}}\right)\op \times \left( \R{B_{\low}}\times \R{B_{\upp}}\right)\toinPos \Bool\\
%      \unc(g)&\colon \left( \F{B_{\low}}\times \F{B_{\upp}}\right)\op \times \left( \R{C_{\low}}\times \R{C_{\upp}}\right)\toinPos \Bool.
%    \end{aligned}
%  \end{equation}
%
%  We have
%  \begin{equation}
%    \begin{aligned}
%      &\left(\unc(f)\then \unc(g)\right) (\tup{\ubar{a},\bar{a}}^*, \tup{\ubar{c},\bar{c}})\\
%      &=\bigvee_{\tup{\ubar{b},\bar{b}}\setin B_{\low}\times B_{\upp}} \unc(f)(\tup{\ubar{a},\bar{a}}^*, \tup{\ubar{b},\bar{b}})\wedge \unc(g)(\tup{\ubar{b},\bar{b}}^*, \tup{\ubar{c},\bar{c}})\\
%      &= \bigvee_{\tup{\ubar{b},\bar{b}}\setin B_{\low}\times B_{\upp}} \low f(\ubar{a}^*,\ubar{b})\wedge \upp f(\bar{a}^*,\bar{b})\wedge \low g(\ubar{b}^*,\ubar{c})\wedge \upp g(\bar{b}^*,\bar{c})\\
%      &=(\low f\then \low g)(\ubar{a}^*,\ubar{c})\wedge (\upp f\then \upp g)(\bar{a}^*,\bar{c})\\
%      &=\low f\then g (\ubar{a}^*,\ubar{c})\wedge \upp f\then g(\bar{a}^*,\bar{c})\\
%      &=\unc(f\then g)(\tup{\ubar{a},\bar{a}}^*, \tup{\ubar{c},\bar{c}}).
%    \end{aligned}
%  \end{equation}
%\end{proof}
%

\section{$\Lmon$ and~$\Umon$ monads}
In this section, we propose another example of \SY{monads} related to \SY{posets} and upper/lower sets.
We start by defining the \emph{$\Uendo$ endofunctor}.
\begin{definition}[$\Uendo$ endofunctor]
    \label{def:Uendo}
    The \emph{$\Uendo$ endofunctor} has the form~$\Uendo \colon \Pos \fto \Pos$ and acts on objects and morphisms as follows:
    \begin{enumerate}
        \item \emph{On objects}: Given a poset~$\posA \setin \Obof\Pos$,~$\Uendo$ maps~\posA to its upper set\footnote{Recall that in \cref{lem:u_bounded_lat} we proved that the \SY{upper set} is itself an object of \Pos.
              }.
        \item \emph{On morphisms}: Given \SY{posets}~$\posA,\posB$, and a \SY{monotone maps}~$\mora \colon \posA\mto \posB$, the~$\Uendo$ \SY{endofunctor} acts as:
              \begin{equation}
                  \begin{aligned}
                      \Uendo(\mora)\colon \Up \posA & \to \Up \posB \\
                      \posA'                        & \mapsto \upit \pars{ \bigsetunion_{\posAel\setin \posA'} \makeset{\mapa(\posAel)}}.
                  \end{aligned}
              \end{equation}
    \end{enumerate}
\end{definition}

We now want to prove that the~$\Uendo$ \SY{endofunctor} is an \SY{endofunctor}.

\begin{lemma}
    \label{lem:Uendo-is-functor}
    The~$\Uendo$ \SY{endofunctor} is indeed a \SY{functor}.
\end{lemma}

\begin{proof}
    $\Uendo$ has a valid form and given a poset~\posA, maps~$\catidat\posA$ to~$\catidat{\Up \posA}$.
    \todotextjira{244}{.
        I think the compatibility with identities is non-trivial and should be shown here.
        I think there is a mistake: the source and target should be UP and UR respectively, not ``Pos''.
        Not clear to me what ``valid form'' means}
    We now need to show that~$\Uendo$ is compatible with morphism composition.
    Consider maps~$\mora\colon \posA \to \posB$ and~$\morb\colon \posB \to \posC$.
    We have:
    \begin{equation}
        \label{eq:ufunctor_1}
        \begin{aligned}
            \Uendo(\morab)\colon \Pos & \to \Pos \\
            \posA'                    & \mapsto \upit \pars{ \bigsetunion_{\posAel\setin \posA'} \makeset{\morb(\mora(\posAel))}}.
        \end{aligned}
    \end{equation}
    %
    On the other hand, we have:
    %
    \begin{equation}
        \begin{aligned}
            \Uendo(\mora)\colon \Pos & \to \Pos \\
            \posA'                   & \mapsto \upit \pars{ \bigsetunion_{\posAel\setin \posA'}\makeset{\mora(\posAel)}},
        \end{aligned}
    \end{equation}
    %
    and
    %
    \begin{equation}
        \begin{aligned}
            \Uendo(\morb)\colon \Pos & \to \Pos \\
            \posB'                   & \mapsto \upit \pars{ \bigsetunion_{\posBel\setin \posB'}\makeset{\morb(\posBel)}},
        \end{aligned}
    \end{equation}
    leading to
    \begin{equation}
        \label{eq:ufunctor_2}
        \begin{aligned}
            \Uendo(\mora)\mthen \Uendo(\morb)\colon \Pos & \to \Pos \\
            \posB'                                       & \mapsto \upit \pars{\bigsetunion_{\posBel\setin \upit \bigsetunion_{\posAel\setin \posB'}\makeset{\mora(\posAel)}}\makeset{\morb(\posBel)}} \\
                                                         & \mapsto \upit \pars{\bigsetunion_{\posAel\setin \posA'} \makeset{ \morb(\mora(\posAel))}}.
            \qquad \qquad (\cref{lem:unpack_u_functor})
        \end{aligned}
    \end{equation}
    Since \cref{eq:ufunctor_1} and \cref{eq:ufunctor_2} are equivalent, $\Uendo$ is a \SY{functor}.
\end{proof}
Having proven that~$\Uendo$ is a valid \SY{functor}, we are now ready to define the~$\Umon$ monad.
\begin{definition}[$\Umon$ monad]
    \label{def:Umon}
    The \emph{$\Umon$ monad} on \Pos consists of:
    \begin{enumerate}
        \item The~$\Uendo$ \SY{endofunctor} (\cref{def:Uendo}).
        \item The unit \SY{natural transformation}~$\monunit_{\Umon} \colon \funid_{\Pos}\nto \Uendo$, which associates to every object~$\posA \setin \Obof\Pos$ a morphisms in \Pos given by:
              \begin{equation}
                  \begin{aligned}
                      \monunit_{\Umon}^\posA\colon \posA & \to \Up \posA \\
                      \posAel                            & \mapsto \upit \makeset{\posAel}.
                  \end{aligned}
              \end{equation}
        \item The compositional \SY{natural transformation}~$\moncomp_{\Umon}\colon \Uendo\fthen \Uendo\nto \Uendo$, which associates to every~$\posA\setin \Obof\Pos$ the morphism in \Pos given by:
              \begin{equation}
                  \begin{aligned}
                      \moncomp_{\Umon}^\posA\colon \Up{(\Up{\posA})} & \to \Up \posA \\
                      \posA''                                        & \mapsto \bigsetunion_{\posA'\setin \posA''}\posA'.
                  \end{aligned}
              \end{equation}
    \end{enumerate}
\end{definition}

Before showing that this indeed defines a monad, we list some results which will be instrumental later.
\begin{lemma}
    \label{lem:upperunionupper}
    Given a poset~\posA and a family of \SY{upper sets} of~\posA, denoted~$\makeset{\posA_i}_{i\setin \stylesets{I}}$ (with index set~$\stylesets{I}$), their union is also an \SY{upper set}.
\end{lemma}

\begin{lemma}
    \label{lem:setunionset}
    Given a set~\setA and a family of subsets of~\setA, denoted~$\makeset{\setA_i}_{i\setin \stylesets{I}}$ (with index set~$\stylesets{I}$), we have:
    \begin{equation}
        \bigsetunion \bigsetunion_{i\setin \stylesets{I}}\makeset{\setA_i} = \bigsetunion_{i\setin \stylesets{I}}\makeset{\setA_i}.
    \end{equation}
\end{lemma}

\begin{lemma}
    The~$\Umon$ monad is indeed a monad.
\end{lemma}
\begin{proof}
    To show that~$\Umon$ is indeed a monad, we need to show the following:
    \begin{enumerate}
        \item $\monunit_{\Umon}$ is a \SY{natural transformation};
        \item $\moncomp_{\Umon}$ is a \SY{natural transformation};
        \item left unitality holds;
        \item right unitality holds;
        \item associativity holds;
    \end{enumerate}
    We prove them in order.

    \emph{1)~$\monunit_{\Umon}$ is a natural transformation}:
    We need to show that for any morphism $\mora\setin \HomSet{\Pos}{\posA}{\posB}$, we have:
    %
    \begin{equation}
        \funid_{\Pos}(\mora)\mthen \monunit_{\Umon}^\posB=\monunit_{\Umon}^\posA\mthen \Uendo(\mora).
    \end{equation}
    %
    By expanding the left-hand side, we obtain:
    %
    \begin{equation}
        \left[\funid_{\Pos}(\mora)\mthen \monunit_{\Umon}^\posB\right](\posAel)=\upit \makeset{\mora(\posAel)}.
    \end{equation}
    %
    By expanding the right-hand side, we get:
    \todotext{@Gioele: dead reference \str{unpack_part_2}}
    %
    \begin{equation}
        \begin{aligned}
            \monunit_{\Umon}^\posA\colon \Pos & \to \Pos \\
            \posAel                           & \mapsto \upit \makeset{\posAel}.
            \qquad \qquad (\XXX)
        \end{aligned}
    \end{equation}
    %
    and
    %
    \begin{equation}
        \begin{aligned}
            \Uendo(\mora)\colon \Pos & \to \Pos \\
            \posA'                   & \mapsto \upit \bigsetunion_{\posAel'\setin \posA'}\makeset{\mora(\posAel')},
        \end{aligned}
    \end{equation}
    and hence
    \begin{equation}
        \begin{aligned}
            \left[\monunit_{\Umon}^\posA\mthen \Uendo(\mora)\right](\posAel) & =\upit \pars{ \bigsetunion_{\posAel'\setin \upit \makeset{\posAel}} \makeset{\mora(\posAel')}} \\
                                                                             & =\upit \makeset{\mora(\posAel)}.
        \end{aligned}
    \end{equation}
    %
    \emph{2)~$\moncomp_{\Umon}$ is a natural transformation}:
    We want to show that for every~$\mora\setin \HomSet{\Pos}{\posA}{\posB}$, we have:
    \begin{equation}
        \Uendo(\Uendo(\mora))\mthen \moncomp_{\Umon}^{\posB}=\moncomp_{\Umon}^\posA \mthen \Uendo(\mora).
    \end{equation}
    We start with the left-hand side.
    We first look at~$\Uendo(\Uendo(\mora))$:
    \begin{equation}
        \begin{aligned}
            (\Uendo(\Uendo(\mora)))
            \colon \Pos & \to \Pos \\
            \posA''     & \mapsto \upit \pars{ \bigsetunion_{\posA' \setin \posA''}
                \makesett{
                    \upit \pars{ \bigsetunion_{\posAel \setin \posA'} \makesett{ \mora(\posAel)}}}
            }.
        \end{aligned}
    \end{equation}
    Furthermore, we have:
    \begin{equation}
        \begin{aligned}
            \Uendo(\Uendo(\mora))\mthen \moncomp_{\Umon}^{\posB}\colon \Pos & \to \Pos \\
            \posA''                                                         & \mapsto \bigsetunion_{\posB'\setin \upit \pars{ \bigsetunion_{\posA'\setin \posA''} \makesett{ \upit \pars{ \bigsetunion_{\posAel \setin \posA'} \makeset{ \mora(\posAel)}}} }} \posB' \\
                                                                            & \mapsto \bigsetunion \upit \pars{ \bigsetunion_{\posA'\setin \posA''} \makesett{ \upit \pars{ \bigsetunion_{\posAel \setin \posA'} \makeset{ \mora(\posAel)}}} } \\
                                                                            & \mapsto \bigsetunion  \pars{ \bigsetunion_{\posA'\setin \posA''} \makesett{ \upit \pars{ \bigsetunion_{\posAel \setin \posA'} \makeset{ \mora(\posAel)}}} } \quad \quad (\text{\cref{lem:upperunionupper}}) \\
                                                                            & \mapsto   \bigsetunion_{\posA'\setin \posA''} \makesett{ \upit \pars{ \bigsetunion_{\posAel \setin \posA'} \makeset{ \mora(\posAel)}}} \quad \quad (\text{\cref{lem:setunionset}}) \\
                                                                            & \mapsto   \upit \pars{\bigsetunion_{\posA'\setin \posA''}  \bigsetunion_{\posAel \setin \posA'} \makeset{ \mora(\posAel)}},
        \end{aligned}
    \end{equation}
    where we used the fact that the union of \SY{upper sets} is the \SY{upper closure} of the \SY{union of sets}.
    By looking at the right-hand side, we have:
    \begin{equation}
        \begin{aligned}
            (\moncomp_{\Umon}^\posA \mthen \Uendo(\mora))
            \colon \Pos & \to \Pos \\
            \posA''     & \mapsto \upit \pars{ \bigsetunion_{\posAel \setin \bigsetunion_{\posA'\setin \posA''}\posA'} \makeset{ \mora(\posAel)}} \\
                        & \mapsto \upit \pars{ \bigsetunion_{\posA'\setin \posA''}\bigsetunion_{\posAel \setin \posA'}\makeset{\mora(\posAel)}},
        \end{aligned}
    \end{equation}
    proving that~$\moncomp_{\Umon}$ is a valid \SY{natural transformation}.

    \emph{Left unitality holds}: We want to show that given a poset~$\posA\setin \Obof\Pos$, we have:
    \begin{equation}
        \monunit_{\Umon}^{\Uendo(\posA)}\mthen \moncomp_{\Umon}^{\posA}=\catidat{\Pos}^{\Uendo(\posA)}.
    \end{equation}
    We have:
    \begin{equation}
        \begin{aligned}
            \monunit_{\Umon}^{\Uendo(\posA)}\mthen \moncomp_{\Umon}^{\posA}\colon \Up \Uendo & \to \Up \Uendo \\
            \posA'                                                                           & \mapsto \bigsetunion_{\posA''\setin \upit \makeset{ \posA'}} \posA'' \\
                                                                                             & \mapsto \posA',
        \end{aligned}
    \end{equation}
    because the \SY{upper sets} of an \SY{upper set}~$\posA'$ are subsets of~$\posA'$ (and hence their union is~$\posA'$).

    \emph{Right unitality holds}: We want to show that given a poset~$\posA\setin \Obof\Pos$, we have:
    \begin{equation}
        \Uendo(\monunit_{\Umon}^{\Uendo})\mthen \moncomp_{\Umon}^{\posA}=\catidat{\UPos}^{\Uendo(\posA)}.
    \end{equation}
    We have:
    \begin{equation}
        \begin{aligned}
            \Uendo(\monunit_{\Umon}^{\Uendo})\mthen \moncomp_{\Umon}^{\posA}\colon \Up \posA & \to \Up \posA \\
            \posA'                                                                           & \mapsto \bigsetunion_{\posA''\setin \upit \pars{ \bigsetunion_{\posAel \setin \posA'}\makeset{ \upit \makeset{\posAel}}}}\posA'' \\
                                                                                             & \mapsto \bigsetunion \upit \pars{ \bigsetunion_{\posAel \setin \posA'}\makeset{\upit \makeset{ \posAel} }} \\
                                                                                             & \mapsto \upit \bigsetunion   \bigsetunion_{\posAel \setin \posA'}\makeset{\upit \makeset{ \posAel} } \\
                                                                                             & \mapsto \upit \bigsetunion_{\posAel \setin \posA'}\upit \makeset{ \posAel} \\
                                                                                             & \mapsto \upit \posA' \\
                                                                                             & \mapsto \posA',
        \end{aligned}
    \end{equation}
    where we use the facts that the union of \SY{upper sets} is an \SY{upper set}, the union of an \SY{upper sets} is the \SY{upper closure} of the \SY{union of sets}, and that the \SY{upper closure} of an \SY{upper set} returns the \SY{upper set}.

    \emph{Associativity holds}: We want to show that given a poset~$\posA\setin \Obof\Pos$, we have:
    \begin{equation}
        \Uendo(\moncomp_{\Umon}^{\posA})\mthen \moncomp_{\Umon}^{\posA}= \moncomp_{\Umon}^{\Uendo(\posA)}\mthen \moncomp_{\Umon}^{\posA}.
    \end{equation}
    We start by exploding the left-hand side of the equation.
    First, we have:
    \begin{equation}
        \begin{aligned}
            \Uendo(\moncomp_{\Umon}^{\posA})(\posC) & =\upit \pars{ \bigsetunion_{\posB\setin \posC}\bigsetunion_{\posA'\setin \posB} \posA'}.
        \end{aligned}
    \end{equation}
    Therefore, we have:
    \begin{equation}
        \begin{aligned}
            (\Uendo(\moncomp_{\Umon}^{\posA})\mthen \moncomp_{\Umon}^{\posA})(\posC)
             & =\bigsetunion_{\posD \setin \upit \pars{ \bigsetunion_{\posB\setin \posC}\bigsetunion_{\posA'\setin \posB} \posA}} \posD \\
             & =\bigsetunion \upit \pars{ \bigsetunion_{\posB\setin \posC}\bigsetunion_{\posA'\setin \posB} \posA'} \\
             & =\upit \bigsetunion \bigsetunion_{\posB\setin \posC}\bigsetunion_{\posA'\setin \posB} \posA' \\
             & =\upit  \bigsetunion_{\posB\setin \posC}\bigsetunion_{\posA'\setin \posB} \posA' \\
             & = \bigsetunion_{\posB\setin \posC}\bigsetunion_{\posA'\setin \posB} \posA'
        \end{aligned}
    \end{equation}
    Starting from right-hand side, instead, we have:
    \begin{equation}
        \begin{aligned}
            (\moncomp_{\Umon}^{\Uendo(\posA)}\mthen \moncomp_{\Umon}^{\posA})(\posC)
             & =\bigsetunion_{\posA'\setin \bigsetunion_{\posB\setin \posC}\posB}\posA' \\
             & =\bigsetunion_{\posB\setin \posC}\bigsetunion_{\posA'\setin \posB} \posA'.
        \end{aligned}
    \end{equation}
\end{proof}

\begin{lemma}
    \label{lem:uposkleisli}
    \UPos is the \SY{Kleisli category} of~$\Umon$.
\end{lemma}
