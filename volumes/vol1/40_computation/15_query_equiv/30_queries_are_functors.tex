\section[Queries as functors]{\DP queries are functors from problem statements to solutions}

\todographicsjira{436}{@Gioele: Here we use CT colors, but we should use DP colors when DPs are there, to help contextualizing?}
\begin{lemma}
    \label{lem:covfunctor}
    There is a functor
    \begin{equation}
        \FixFunMinRes\colon \DP \fto \UPos
    \end{equation}
    that maps:
    \begin{enumerate}
        \item An object (poset) in \DP to the same object (poset) in \UPos.
        \item A morphism~$\adpb\setin \HomSet{\DP}{\funsp}{\ressp}$ to the morphism~$\ftoR_{\adpb}\setin \HomSet{\UPos}{\funsp}{\ressp}$, where:
              \begin{equation}
                  \begin{aligned}
                      \ulposmap{\ftoR}_{\adpb}\colon \funsp & \toinPos \uppersets{\ressp} \\
                      \fun                                  & \mapsto \makeset{\res \setin \ressp\mid \adpb(\fun\Fop,\res)}.
                  \end{aligned}
              \end{equation}
    \end{enumerate}
\end{lemma}

\begin{proof}
    We prove the two conditions.

    \textbf{Preservation of identities}:
    We have
    \begin{equation}
        \begin{aligned}
            \ulposmap{\FixFunMinRes(\catidat\Obja^{\DP})}(\Objael) & =\makeset{ \Objbel\setin \Objb\mid \catidat\Obja^{\DP}(\F{\Objael^*},\R{\Objbel})} \\
                                                                   & =\makeset{ \Objbel \setin \Objb\mid \F{\Objael}\posleq\R{\Objbel}} \\
                                                                   & =\upit \makeset{ \Objael} \\
                                                                   & =\ulposmap{\catidat\Obja^{\UPos}}(\Objael).
        \end{aligned}
    \end{equation}

    \textbf{Preservation of composition}:
    On one hand, we have
    \begin{equation}
        \label{eq:fixfunminres_a}
        \begin{aligned}
            ~ & \ulposmap{\FixFunMinRes(\adpa\dpthen_\DP \adpb)}(\Objael) \\
              & =\makeset{ \Objbel\setin \Objb\mid (\adpa\dpthen \adpb)(\F{\Objael^*},\R{\Objcel})} \\
              & =\makeset{ \Objbel\setin \Objb\mid \bigvee_{\Objbel \setin \Objb}\adpa(\F{\Objael^*},\R{\Objbel})\booland \adpb(\F{\Objbel^*},\R{\Objcel})}.
        \end{aligned}
    \end{equation}
    On the other hand:
    \begin{equation}
        \label{eq:fixfunminres_b}
        \begin{aligned}
             & \ulposmap{(\FixFunMinRes(\adpa)\mthenof\UPos \FixFunMinRes(\adpb))}(\Objael) \\
             & =\bigsetunion_{\Objbel \setin \ulposmap{\FixFunMinRes(\adpa)}(\Objael)}\ulposmap{\FixFunMinRes(\adpb)}(\Objbel) \\
             & =\bigsetunion_{\Objbel \setin \makeset{ \Objbel \setin \Objb \mid \adpa(\F{\Objael}^*,\R{\Objbel})}} \makeset{\Objcel \setin \Objc \mid \adpb(\F{\Objbel}^*,\R{\Objcel})} \\
             & =\makeset{\Objcel\setin \Objc \mid (\Objbel \setin \Objb)\booland \adpa(\F{\Objael}^*,\R{\Objbel})\booland \adpb(\F{\Objbel}^*,\R{\Objcel})} \\
             & =\makeset{ \Objbel\setin \Objb\mid \bigvee_{\Objbel \setin \Objb}\adpa(\F{\Objael}^*,\R{\Objbel})\booland \adpb(\F{\Objbel}^*,\R{\Objcel})}.
        \end{aligned}
    \end{equation}
    Clearly, \cref{eq:fixfunminres_a} and \cref{eq:fixfunminres_b} coincide.
\end{proof}

\begin{lemma}
    \label{lem:confunctor}
    There is a functor
    \begin{equation}
        \FixResMaxFun\colon \DP \fto \LPos
    \end{equation}
    which maps:
    \begin{enumerate}
        \item An object (poset) of \DP to the same object (poset) in \LPos.
        \item A morphism $\adpb \setin \HomSet{\DP}{\funsp}{\ressp}$ to the morphism~$\rtoF_\adpb\setin \HomSet{\LPos}{\ressp}{\funsp}$, where:
              \begin{equation}
                  \begin{aligned}
                      \ulposmap{\rtoF}_\adpb\colon \ressp & \toinPos \lowersets{\funsp} \\
                      \res                                & \mapsto \makeset{ \fun \setin \funsp \mid \adpb(\fun^*,\res)}.
                  \end{aligned}
              \end{equation}
    \end{enumerate}
\end{lemma}

\begin{proof}
    The proof is analogous to the one of \cref{lem:covfunctor}.
\end{proof}

\begin{lemma}
    \label{lem:covfunctorback}
    There is a \SY{functor}~$\FixFunMinResBack\colon \UPos \fto \DP$ which maps:
    \begin{enumerate}
        \item An object (poset) in \UPos to the same object (poset) in \DP.
        \item A morphism~$\morb\setin \HomSet{\UPos}{\funsp}{\ressp}$ to the morphism~$\adp_\morb \setin \HomSet{\DP}{\funsp}{\ressp}$, where:
              \begin{equation}
                  \begin{aligned}
                      \adp_\morb\colon \funspop \Ptimes \ressp & \toinPos \Bool \\
                      \tup{\fun^*,\res}                        & \mapsto \res \setin \ulposmap{\morb}(\fun).
                  \end{aligned}
              \end{equation}
    \end{enumerate}
\end{lemma}

\begin{proof}
    We prove the two conditions.

    \textbf{Preservation of identities}:
    We have
    \begin{equation}
        \begin{aligned}
            \FixFunMinResBack(\catidat\Obja^{\UPos})(\F{\Objael}^*,\R{\Objbel}) \\
             & =
            \Objbel \setin \ulposmap{\catidat\Objb^{\UPos}} \\
             & =\Objbel \setin \upit \makeset{ \Objael} \\
             & =\catidat\Obja^{\DP}(\Objael^*,\Objbel).
        \end{aligned}
    \end{equation}

    \textbf{Preservation of composition}:
    On one hand, we have
    \begin{equation}
        \label{eq:fixfunminresback_a}
        \begin{aligned}
            \FixFunMinResBack(\mora\mthenof\UPos \morb)(\Objael^*,\Objcel) & =
            \Objcel \setin \ulposmap{(\mora \mthenof\UPos \morb)}(\Objael) \\
                                                                           & =\Objcel \setin \bigsetunion_{\Objbel\setin \ulposmap{\mora}(\Objael)}\ulposmap{\morb}(\Objbel).
        \end{aligned}
    \end{equation}
    On the other hand:
    \begin{equation}
        \label{eq:fixfunminresback_b}
        \begin{aligned}
             & (\FixFunMinResBack(\mora)\mthenof\DP \FixFunMinResBack(\morb))(\Objael^*,\Objcel) \\
             & =
            \bigvee_{\Objbel \setin \Objb}(\Objbel \setin \ulposmap{\mora}(\Objael))\wedge (\Objcel\setin \ulposmap{\morb}(\Objbel)) \\
             & =\Objcel \setin \bigsetunion_{\Objbel\setin \ulposmap{\mora}(\Objael)}\ulposmap{\morb}(\Objbel).
        \end{aligned}
    \end{equation}
    Clearly, \cref{eq:fixfunminresback_a} and \cref{eq:fixfunminresback_b} coincide.
\end{proof}

\begin{lemma}
    \label{lem:cofunctorback}
    There is a \SY{functor}~$\FixResMaxFunBack\colon \LPos \fto \DP$ which maps:
    \begin{enumerate}
        \item An object (poset) in \UPos to the same object (poset) in \DP.
        \item A morphism~$\morb\setin \HomSet{\LPos}{\funsp}{\ressp}$ to the morphism~$\adp_\morb \setin \HomSet{\DP}{\funsp}{\ressp}$, where:
              \begin{equation}
                  \begin{aligned}
                      \adp_\morb\colon \funspop \Ptimes \ressp & \toinPos \Bool \\
                      \tup{\fun^*,\res}                        & \mapsto \fun \setin \ulposmap{\morb}(\res).
                  \end{aligned}
              \end{equation}
    \end{enumerate}
\end{lemma}

\begin{proof}
    The proof is analogous to the one of \cref{lem:covfunctorback}.
\end{proof}

\begin{figure}[tbh]
    \centering
    \includesag{upos_lpos_dp}
    \caption{From \DP to \UPos and \LPos, and back.}
\end{figure}

\todojira{240}{@Gioele: we need to show that they are equivalent, that the \SY{functor} preserves traces, and meet/join}

\begin{lemma}
    The pair of \SY{functors}\FixFunMinRes and \FixFunMinResBack together with the natural isomorphisms
    \begin{equation}
        \FixFunMinRes \fthen \FixFunMinResBack \cong \funid_\DP,
    \end{equation}
    and
    \begin{equation}
        \FixFunMinResBack \fthen \FixFunMinRes \cong \funid_\UPos,
    \end{equation}
    form an equivalence for \DP and \UPos.
\end{lemma}

\begin{proof}
    First, consider any morphism in~$\HomSet{\DP}{\Obja}{\Objb}$.
    We have
    \begin{equation}
        \begin{aligned}
             & (\FixFunMinRes \fthen \FixFunMinResBack)(\adpa)(\F{\Objael}^*,\R{\Objbel}) \\
             & = \Objbel \setin \ulposmap{\FixFunMinRes(\adpa)}(\Objael) \\
             & =\Objbel \setin \makeset{ \Objbel' \setin \Objb \mid \adpa(\F{\Objael^*,\Objbel})} \\
             & =\adpa(\F{\Objael^*,\Objbel}) \\
             & =\funid_\DP(\adpa)(\F{\Objael^*,\Objbel}).
        \end{aligned}
    \end{equation}
    Now consider any morphism~$\ftoR_\adpa \setin \HomSet{\UPos}{\Obja}{\Objb}$.
    We have
    \begin{equation}
        \begin{aligned}
             & (\FixFunMinResBack \fthen \FixFunMinRes)(\ftoR_\adpa)(\Objael) \\
             & =\makeset{ \Objbel \setin \Objb\mid \Objbel \setin \ulposmap{\ftoR_\adpa}(\Objael)} \\
             & =\makeset{ \Objbel \setin \Objb\mid \adpa(\Objael^*,\Objbel)} \\
             & =\funid_\UPos(\ftoR_\adpa)(\Objael).
        \end{aligned}
    \end{equation}
    \todotext{Finish with naturality.}

\end{proof}
\begin{lemma}
    \FixFunMinRes preserves the \SY{bounded lattice} structure.
    \todotext{Actually, preserves the complete one?}
\end{lemma}
\begin{proof}
    Given~$\Obja,\Objb \setin \Obof\DP$ and~$\adpa,\adpb \setin \HomSet{\DP}{\Obja}{\Objb}$, we want to check the following properties.

    \textbf{Order reversing}:
    We want to check
    \begin{equation}
        \prfperiod{\adpa \posleqof\DP \adpb}{\FixFunMinRes(\adpa) \posgeqof\UPos \FixFunMinRes(\adpb)}
    \end{equation}
    We have:
    \begin{equation}
        \begin{aligned}
            \ulposmap{\FixFunMinRes(\adpa)}(\Objael) & =\makeset{\F{\Objbel} \setin \F{\Objb} \mid \adpa(\F{\Objael}^*, \R{\Objbel})} \\
                                                     & \setsubseteq \makeset{\F{\Objbel} \setin \F{\Objb} \mid \adpb(\F{\Objael}^*, \R{\Objbel})} \\
                                                     & = \ulposmap{\FixFunMinRes(\adpb)}(\Objael),
        \end{aligned}
    \end{equation}
    implying~$\FixFunMinRes(\adpa) \posgeqof\UPos \FixFunMinRes(\adpb)$.

    \textbf{Meet and \SY{join} preservation}:
    We want to check
    \begin{equation}
        \FixFunMinRes(\adpa \dpmeet \adpb)=\FixFunMinRes(\adpa) \meetof\UPos \FixFunMinRes(\adpb),
    \end{equation}
    and
    \begin{equation}
        \FixFunMinRes(\adpa \dpjoin \adpb)=\FixFunMinRes(\adpa) \joinof\UPos \FixFunMinRes(\adpb).
    \end{equation}
    We have
    \begin{equation}
        \begin{aligned}
            ~ &
            \ulposmap{\FixFunMinRes(\adpa \dpmeet \adpb)}(\Objael) \\
              & =\makeset{ \R{\Objbel} \setin \R{\Objb} \mid (\adpa \dpmeet \adpb)(\F{\Objael}^*,\R{\Objbel})} \\
              & =\makeset{ \R{\Objbel} \setin \R{\Objb} \mid (\adpa(\F{\Objael}^*,\R{\Objbel})\meetof\DP \adpb(\F{\Objael}^*,\R{\Objbel}))} \\
              & =\makeset{ \R{\Objbel} \setin \R{\Objb} \mid \adpa(\F{\Objael}^*,\R{\Objbel})} \setintersection \makeset{ \R{\Objbel} \setin \R{\Objb} \mid  \adpb(\F{\Objael}^*,\R{\Objbel})} \\
              & =\ulposmap{\FixFunMinRes(\adpa)}(\Objael) \meetof\UPos \ulposmap{\FixFunMinRes(\adpb)}(\Objael).
        \end{aligned}
    \end{equation}
    Similarly:
    \begin{equation}
        \begin{aligned}
            ~ & \ulposmap{\FixFunMinRes(\adpa \dpjoin\DP \adpb)}(\Objael) \\
              & =\makeset{ \R{\Objbel} \setin \R{\Objb} \mid (\adpa \dpjoin \adpb)(\F{\Objael}^*,\R{\Objbel})} \\
              & =\makeset{ \R{\Objbel} \setin \R{\Objb} \mid (\adpa(\F{\Objael}^*,\R{\Objbel})\joinof\DP \adpb(\F{\Objael}^*,\R{\Objbel}))} \\
              & =\makeset{ \R{\Objbel} \setin \R{\Objb} \mid \adpa(\F{\Objael}^*,\R{\Objbel})} \setunion \makeset{ \R{\Objbel} \setin \R{\Objb} \mid  \adpb(\F{\Objael}^*,\R{\Objbel})} \\
              & =\ulposmap{\FixFunMinRes(\adpa)}(\Objael) \joinof\UPos \ulposmap{\FixFunMinRes(\adpb)}(\Objael).
        \end{aligned}
    \end{equation}

    \textbf{Top and bottom preservation}:
    We want to check
    \begin{equation}
        \FixFunMinRes(\posbot_{\HomSet{\DP}{\Obja}{\Objb}})=\posbot_{\HomSet{\UPos}{\Obja}{\Objb}},
    \end{equation}
    and
    \begin{equation}
        \FixFunMinRes(\postop_{\HomSet{\DP}{\Obja}{\Objb}})=\postop_{\HomSet{\UPos}{\Obja}{\Objb}}.
    \end{equation}
    We have
    \begin{equation}
        \begin{aligned}
            \ulposmap{\FixFunMinRes(\posbot_{\HomSet{\DP}{\Obja}{\Objb}})}(\Objael) & =\Emptyset \\
                                                                                    & =\ulposmap{\posbot_{\HomSet{\UPos}{\Obja}{\Objb}}}(\Objael)
        \end{aligned}
    \end{equation}
    Similarly
    \begin{equation}
        \begin{aligned}
            \ulposmap{\FixFunMinRes(\postop_{\HomSet{\DP}{\Obja}{\Objb}})}(\Objael) & =\Objb \\
                                                                                    & =\ulposmap{\postop_{\HomSet{\UPos}{\Obja}{\Objb}}}(\Objael).
        \end{aligned}
    \end{equation}
\end{proof}

\begin{lemma}
    \FixFunMinRes preserves traces.
    In other words:
\end{lemma}
\begin{proof}
    We want to show that
    \begin{equation}
        \FixFunMinRes(\Tr_{\Obja,\Objb}^{\Objc}(\adpa))=\Tr_{\Obja,\Objb}^{\Objc}(\FixFunMinRes(\adpa)),
    \end{equation}
    for all~$\adpa\setin \HomSet{\DP}{\Obja\cartprod \Objc}{\Objb\cartprod \Objc}$, and~$\Obja,\Objb,\Objc\setin \Obof\DP$.
    On one hand, we have
    \begin{equation}
        \begin{aligned}
            \ulposmap{\FixFunMinRes(\Tr_{\Obja,\Objb}^{\Objc}(\adpa))}(\Objael) & =\makeset{\Objbel \setin \Objb \mid \Tr_{\Obja,\Objb}^{\Objc}(\adpa)(\F{\Objael}^*,\R{\Objbel}) } \\
                                                                                & =\makeset{\Objbel \setin \Objb \mid \bigvee_{\Objcel \setin \Objc} \adpa(\tup{\F{\Objael},\F{\Objcel}}^*, \tup{\R{\Objbel},\R{\Objcel}}) }
        \end{aligned}
    \end{equation}
    On the other hand, we have
    \begin{equation}
        \begin{aligned}
             & \ulposmap{\Tr_{\Obja,\Objb}^{\Objc}(\FixFunMinRes(\adpa))}(\Objael) \\
             & =\makeset{ \Objbel \setin \Objb \mid \bigvee_{\Objcel \setin \Objc} \tup{\Objbel,\Objcel}\setin \ulposmap{\FixFunMinRes(\adpa)}(\Objael,\Objcel)} \\
             & =\makeset{ \Objbel \setin \Objb \mid \bigvee_{\Objcel \setin \Objc} \tup{\Objbel,\Objcel}\setin \makeset{ \tup{\Objbel,\Objcel}\setin \Objb\cartprod \Objc \mid \adpa(\tup{\F{\Objael},\F{\Objcel}}^*, \tup{\R{\Objbel},\R{\Objcel}}}} \\
             & =\makeset{\Objbel \setin \Objb \mid \bigvee_{\Objcel \setin \Objc} \adpa(\tup{\F{\Objael},\F{\Objcel}}^*, \tup{\R{\Objbel},\R{\Objcel}}) }.
        \end{aligned}
    \end{equation}
\end{proof}

\devel{

    \begin{lemma}
        \FixFunMinRes and \FixResMaxFun are strong monoidal \SY{functors}.
    \end{lemma}

    \todojira{240}{To transcribe, but note we have no ``monoidal \SY{functors}'' at this point.}
}
