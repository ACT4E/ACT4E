version: 2
workflows:
  version: 2
  build:
    jobs:
      - build-vol1:
          context: z7-stage
      - build-vol1-final:
          context: z7-stage
      - build-vol1-instructors:
          context: z7-stage
      - docs-deploy:
          requires:
            - build-vol1
            - build-vol1-final
            - build-vol1-instructors
          filters:
            branches:
              only: kaobook
jobs:
  build-vol1:
    docker:
      - image: ${DOCKER_REGISTRY}/act4e/act4e-build:z7
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - run:
          name: Build stats (1)
          command: |
            mkdir -p build-stats
            env | tee  build-stats/env.txt
      - store_artifacts:
          path: build-stats
          destination: build-stats
      - run:
          name: instructors
          command: |
            git clone -b spring2021 git@github.com:ACT4E/ACT4E-solutions.git
      - run:
          name: install deps
          command: |
            apt-get update
            apt-get install -y pdftk

      - run:
          name: Latex
          command: |
            mkdir _build
            make ACT4E-vol1.pdf

      - run:
          name: encrypt
          command: |
            pdftk ACT4E-vol1.pdf output _build/ACT4E-vol1.pdf owner_pw ${OWNER_PWD} user_pw ${USER_PWD}
            cp *.pdf _build
      - store_artifacts:
          path: _build
          destination: _build
      - persist_to_workspace:
          root: .
          paths:
            - _build
  build-vol1-instructors:
    docker:
      - image: ${DOCKER_REGISTRY}/act4e/act4e-build:z7
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - run:
          name: Build stats (1)
          command: |
            mkdir -p build-stats
            env | tee  build-stats/env.txt
      - store_artifacts:
          path: build-stats
          destination: build-stats
      - run:
          name: instructors
          command: |
            git clone -b spring2021 git@github.com:ACT4E/ACT4E-solutions.git
      - run:
          name: install deps
          command: |
            apt-get update
            apt-get install -y pdftk

      - run:
          name: Latex
          command: |
            mkdir _build
            make ACT4E-vol1-instructors.pdf

      - run:
          name: encrypt
          command: |
            pdftk ACT4E-vol1-instructors.pdf output _build/ACT4E-vol1-instructors.pdf owner_pw ${OWNER_PWD} user_pw ${USER_PWD}
            cp *.pdf _build
      - store_artifacts:
          path: _build
          destination: _build
      - persist_to_workspace:
          root: .
          paths:
            - _build

  build-vol1-final:
    docker:
      - image: ${DOCKER_REGISTRY}/act4e/act4e-build:z7
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - run:
          name: Build stats (1)
          command: |
            mkdir -p build-stats
            env | tee  build-stats/env.txt
      - store_artifacts:
          path: build-stats
          destination: build-stats
      - run:
          name: Latex
          command: |
            mkdir _build

            make ACT4E-vol1-final.pdf
            cp ACT4E-vol1-final.pdf _build
      - store_artifacts:
          path: _build
          destination: _build
      - persist_to_workspace:
          root: .
          paths:
            - _build

  docs-deploy:
    docker:
      - image: node:8.10.0
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Install and configure dependencies
          command: |
            npm install -g --silent gh-pages@2.0.1
            git config user.email "acensi@ethz.ch"
            git config user.name "ci-build"
      - run:
          name: Deploy docs to gh-pages branch
          command: gh-pages --dist /tmp/workspace/_build
