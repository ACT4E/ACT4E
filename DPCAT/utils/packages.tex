% !TEX root = ../CategoricalCoDesign.tex
% \usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage[T1]{fontenc}
\usepackage{hyperref}
\usepackage{lipsum}
\usepackage{xspace}
\usepackage{amsmath}
\usepackage{amsthm}
% \usepackage{amssymb}
\usepackage{mathtools}
% \usepackage{mathrsfs}
\usepackage{comment}
\usepackage{accents}
\usepackage{stmaryrd} 
\usepackage{ifthen}
\usepackage{iftex}
% \usepackage{bussproofs}
\usepackage{ebproof}
\usepackage{units}
\usepackage{paralist}
\usepackage[svgnames]{xcolor}
\usepackage{framed}
\definecolor{shadecolor}{named}{LightBlue}
\usepackage[capitalize]{cleveref}
\usepackage{pgfplots}
\pgfplotsset{compat=1.16}
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{graphicx}
\usepackage{pifont}
\usepackage{skull}
\usepackage{adjustbox}
% \usepackage{breqn}
 
% \usepackage{txfonts}
\usepackage[shortlabels]{enumitem}
\setitemize{noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt}
\setenumerate{noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt}

\usepackage[utopia]{mathdesign}

\surroundwithmdframed[
   topline=false,
   rightline=false,
   bottomline=false,
   %leftmargin=\parindent,
   %skipabove=\medskipamount,
   %skipbelow=\medskipamount
]{proof}
\theoremstyle{definition}
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem*{theorem*}{Theorem}



\newtheorem{proposition}[theorem]{Proposition}
\newtheorem*{proposition*}{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem*{lemma*}{Lemma}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{construction}[theorem]{Construction}

\theoremstyle{remark}
\newtheorem{example}[theorem]{Example}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{warning}[theorem]{Warning}
\newtheorem{exercise}[theorem]{Exercise}


\usepackage{chngcntr}
% \counterwithout{lemma}{section}
% \counterwithout{theorem}{section}
% \counterwithout{example}{section}
% \counterwithout{exercise}{section}


\usepackage{tikz}
\definecolor{darkgreen}{rgb}{0.0, 0.5, 0.0}
\definecolor{darkred}{rgb}{0.5, 0.0, 0.0}

\usetikzlibrary{positioning,intersections,hobby,patterns,calc,decorations.pathmorphing,decorations.markings, shadows,shapes}

\usetikzlibrary{
	cd,
	decorations.markings,
	positioning,
	arrows.meta,
	shapes,
	calc,
	fit,
	quotes}



\def\preceqSize{10pt}
\def\dpgreen{darkgreen}
\def\dpred{darkred}

\tikzset{fcname/.store in =\fcname, fcname={}}
\tikzset{funame/.store in =\funame, funame={}}
\tikzset{rcname/.store in =\rcname, rcname={}}
\tikzset{runame/.store in =\runame, runame={}}
\tikzset{whereres/.store in =\whereres, whereres=0.5}
\tikzset{wherefun/.store in =\wherefun, wherefun=0.5}
\tikzset{relres/.store in =\relres, relres={above}}
\tikzset{relfun/.store in =\relfun, relfun={above}}
\tikzset{posres/.store in =\posres, posres=0.25}
\tikzset{posfun/.store in =\posfun, posfun=0.25}
\tikzset{loos/.store in =\loos, loos=2}
\tikzset{feedback/.store in =\feedback, feedback=0}
\tikzset{
   DP/.style={%everything after equals replaces "DP" in key.
      %every to/.style={out=0,in=180,draw},
      label/.style={
         font=\everymath\expandafter{\the\everymath\scriptstyle},
         inner sep=5pt,
         node distance=2pt and -2pt},
      semithick,
      node distance=1 and 1,
      rconn/.style={color=white,opacity=0.0,postaction={decorate}, shorten <=3.2pt, shorten >= 0.8,
      decoration={markings, 
      mark= at position 0 with {
               \coordinate (a);
      },
      mark=at position .5 with
      {
              \ifthenelse{\equal{\feedback}{1}}{\def\angleOut{90}\def\angleIn{90}}{\def\angleOut{0}\def\angleIn{180}}    
              \coordinate (b);
              \draw[dashed,\dpred,opacity=1.0] (a) to[out=\angleOut,in=\angleIn,looseness=\loos] 
              node[pos=\posres,\relres=\whereres mm,\dpred,opacity=1,fill=white,inner sep=1pt,outer sep=1pt]{\footnotesize{\rcname}} (b);
      },
      mark= at position 1 with 
      {
             \ifthenelse{\equal{\feedback}{1}}{\def\angleOut{0}\def\angleIn{0}}{\def\angleOut{180}\def\angleIn{0}} 
              \ifthenelse{\equal{\feedback}{1}}{\def\symbol{\succeq}}{\def\symbol{\preceq}} 
              \coordinate (c);
              \draw[\dpgreen,opacity=1.0] (c) to[out=\angleOut,in=\angleIn,looseness=\loos]
              node[pos=\posfun,\relfun=\wherefun mm,\dpgreen,opacity=1,fill=white,inner sep=1pt,outer sep=1pt]{\footnotesize{\fcname}} (b){}; %bend right
              \node[draw,circle,inner sep=0.5pt,color=black,fill=white,opacity=1.0] at (b) (nodepreceq) {$\symbol$}; 
      }
      }},
      runconn/.style={color=\dpred,dashed,postaction={decorate},
      decoration={markings,
      mark= at position 1 with {
              \coordinate (a);
              \draw[\dpred,opacity=1.0,dashed] ($(a)+(0.05,0)$) --++ (0.5,0) node[right,pos=0.95]{\footnotesize{\runame}};}
      }
      },
      funconn/.style={color=white,postaction={decorate},
      decoration={markings,
      mark= at position 0 with {
      \coordinate (a);
      \draw[\dpgreen] ($(a)+(-0.05,0)$) -- ($(a)+(-0.5,0)$) node[left]{\footnotesize{\funame}};}
      }
      },
      execute at begin picture={\tikzset{
         x=\dpx, y=\dpy,
         every fit/.style={inner xsep=\dpx, inner ysep=\dpy}}}
      },
   dpx/.store in=\dpx,
   dpx = 1.5cm,
   dpy/.store in=\dpy,
   dpy = 1.5ex,
   dp port sep/.store in=\dpportsep,
   dp port sep=2,
   dp port length/.store in=\dpportlen,
   dp port length=4pt,
   dp min width/.store in=\dpminwidth,
   dp min width=0.5cm,
   dp rounded corners/.store in=\dpcorners,
   dp rounded corners=2pt,
   dp small/.style={dp port sep=1, dp port length=2.5pt, dpx=.4cm, dp min width=.4cm, dpy=.7ex},
   dp/.code 2 args={%When you see this key, run the code below:
    % put padding rather than minimum height
    % the font size should be the same as the text
      \pgfmathsetlengthmacro{\dpheight}{\dpportsep * (max(#1,#2)) * \dpy}
      \pgfkeysalso{draw,%
        minimum width=\dpminwidth,%
        minimum height=\dpheight,%
        font=\bfseries,
        outer sep=0pt,%
        inner sep=5pt,%
        rounded corners=\dpcorners,
        thick,
        prefix after command={\pgfextra{\let\fixname\tikzlastnode}},
        append after command={\pgfextra{\draw
            \ifnum #1=0{} \else foreach \i in {1,...,#1} { 
            ($(\fixname.north west)!{\i/(#1+1)}!(\fixname.south west)$) +(0,0) node[solid,left,circle,color=darkgreen,draw,fill=darkgreen,scale=0.3] {} coordinate (\fixname_fun\i) -- +(0,0) coordinate (\fixname_fun\i')}\fi %Define the endpoints of tickmarks
            \ifnum #2=0{} \else foreach \i in {1,...,#2} {
            ($(\fixname.north east)!{\i/(#2+1)}!(\fixname.south east)$) +(0,0) coordinate (\fixname_res\i') -- +(0,0) node[solid,right,circle,color=darkred,draw,fill=darkred,scale=0.3] {} coordinate (\fixname_res\i)}\fi;
         }}}
         },
      dp name/.style={append after command={\pgfextra{\node[label=center,inner sep=2pt,fill=white] at (\fixname) {\textbf{#1}};}}}
   }

\tikzset{
   oriented WD/.style={%everything after equals replaces "oriented WD" in key.
      every to/.style={out=0,in=180,draw},
      label/.style={
         font=\everymath\expandafter{\the\everymath\scriptstyle},
         inner sep=0pt,
         node distance=2pt and -2pt},
      semithick,
      node distance=1 and 1,
      decoration={markings, mark=at position .5 with {\arrow{stealth};}},
      ar/.style={postaction={decorate}},
      execute at begin picture={\tikzset{
         x=\bbx, y=\bby,
         every fit/.style={inner xsep=\bbx, inner ysep=\bby}}}
      },
   bbx/.store in=\bbx,
   bbx = 1.5cm,
   bby/.store in=\bby,
   bby = 1.75ex,
   bb port sep/.store in=\bbportsep,
   bb port sep=2,
   % bb wire sep/.store in=\bbwiresep,
   % bb wire sep=1.75ex,
   bb port length/.store in=\bbportlen,
   bb port length=4pt,
   bb min width/.store in=\bbminwidth,
   bb min width=1cm,
   bb rounded corners/.store in=\bbcorners,
   bb rounded corners=2pt,
   bb small/.style={bb port sep=1, bb port length=2.5pt, bbx=.4cm, bb min width=.4cm, bby=.7ex},
   bb/.code 2 args={%When you see this key, run the code below:
      \pgfmathsetlengthmacro{\bbheight}{\bbportsep * (max(#1,#2)+1) * \bby}
      \pgfkeysalso{draw,minimum height=\bbheight,minimum width=\bbminwidth,outer sep=0pt,
         rounded corners=\bbcorners,thick,
         prefix after command={\pgfextra{\let\fixname\tikzlastnode}},
         append after command={\pgfextra{\draw
            \ifnum #1=0{} \else foreach \i in {1,...,#1} {
               ($(\fixname.north west)!{\i/(#1+1)}!(\fixname.south west)$) +(-\bbportlen,0) coordinate (\fixname_in\i) -- +(\bbportlen,0) coordinate (\fixname_in\i')}\fi %Define the endpoints of tickmarks
            \ifnum #2=0{} \else foreach \i in {1,...,#2} {
               ($(\fixname.north east)!{\i/(#2+1)}!(\fixname.south east)$) +(-\bbportlen,0) coordinate (\fixname_out\i') -- +(\bbportlen,0) coordinate (\fixname_out\i)}\fi;
         }}}
   },
   bb name/.style={append after command={\pgfextra{\node[anchor=north] at (\fixname.north) {#1};}}}
}

\tikzset{
   tick/.style={postaction={
      decorate,
      decoration={markings, mark=at position 0.5 with {\draw[-] (0,.4ex) -- (0,-.4ex);}}}
   }
}


\usepackage{subcaption}

\usepackage{blkarray, array}



\graphicspath{{figures/}}

\usepackage{todonotes}
\presetkeys{todonotes}{inline}{}
%%%%%%%%%%%%%%%%%%%%% Microtype


\usepackage{ifxetex}
\ifxetex
\usepackage[protrusion=true,tracking=false,kerning=false,spacing=false]{microtype}
\else
\usepackage[tracking=false,kerning=true,spacing=true]{microtype}

% This is the most stretched...
% \usepackage[activate={true,nocompatibility},tracking=false,kerning=true,spacing=true,stretch=30,final,babel,factor=1100]{microtype}
\pdfprotrudechars=2
\pdfadjustspacing=2
% \newfontfeature{Microtype}{protrusion=default;expansion=default;}
% \directlua{fonts.protrusions.setups.default.factor=.5}

\fi