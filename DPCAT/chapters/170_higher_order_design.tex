% !TEX root = ../CategoricalCoDesign.tex
\section{Higher order design}
\subsection{Diagrams}
\subsection{Compact closed structure}\label{sec:compact_closed}
The basic question is: how do we ``plug in'' the R\&D design problem above into the design problem of a rocket defined in terms of a specific engine $\in \Hom_\DP(\text{Thrust}, \text{Fuel})$? % And how do we solve such design problems?

The set $\Hom_\CatC(A,B)$ of morphisms between $A$ and $B$ is known as the \emph{external hom}, and is canonically defined for every category $\CatC$. For certain categories, however, there is also an \emph{internal hom} $[A,B] \in \CatC$ which satisfies
\begin{equation}\label{eqn:internal_hom}
\Hom_\Cat{C}(A,B) \simeq \{ f : \One \to [A,B] \},
\end{equation}
where $\One$ is the monoidal unit in $\Cat{C}$; we say that $\Hom_\CatC(A,B)$ is the set of \emph{generalized elements} of $[A,B]$. For example, the set of functions between $A$ and $B$ is the internal hom between sets $A,B \in \Set$ (it also happens to be equivalent to the external hom in $\Set$).

\AP{Maybe also add the more intuitive \textit{For $\mathcal{C}$ a category and $X,Y\in \mathcal{C}$ two objects, the internal hom $[X,Y] \in \mathcal{C}$ from $X$ to $Y$ is, if it exists, another object of $\mathcal{C}$ which behaves like the ``object of morphisms'' from $X$ to $Y$} (from nLab)}

In $\DP$, the external hom and the internal hom are not equivalent, but the isomorphism $\Hom_\DP(A,B) \simeq \{ f \colon \One \tickar [A,B] \}$ still holds, allowing us to study the properties of $\Hom_\DP(A,B)$ from ``inside'' $\DP$.

\AP{Inconsistent notation: morphism in \cref{eqn:internal_hom}, profunctor here}

To say that a category $\CatC$ is \emph{closed} is to say, roughly, that the internal hom exists for all pairs of objects in $\CatC$. In $\DP$, this means that there exists a unique poset $[A,B]$ associated to every pair $A,B$ and satisfying \cref{eqn:internal_hom}. % ... is to say that every hom-object $\Hom_\Cat{C}(-,-)$ of $\Cat{C}$ is also an object of $\Cat{C}$. For $\DP$, this means that the set of design problems between any two posets, $\Hom_\DP(A,B)$, is itself a poset (with the ordering $\Imp$).

To say that a category $\CatC$ is \emph{compact closed} is, roughly, to say that every object $A \in \CatC$ has a dual object $A^* \in \CatC$, and that, for any $B \in \CatC$, $A$ and $A^*$ satisfy a unique formula for the internal hom: $[A,B] = A^* \times B$. In $\DP$, the dual of a poset $A \in \DP$ is $A\op$, and the formula for the internal hom is $A\op \times B$.

\begin{example}\label{ex:r&dproblem}
In the simplest case, fix some $\text{engine} \in \text{Engines} \coloneqq \Hom_\DP(\text{Thrust},\text{Fuel})$. Since $\DP$ is compact closed, we can rewrite the R\&D design problem $\text{R\&D}(\text{engine}^*, \tup{t,m})$ from \cref{ex:r&d} as a design problem of the form $\One \tickar \text{Time} \times \text{Money}$
\begin{equation*}
\includesag{60_research}
\end{equation*}
where $\eta \colon I \tickar \text{Thrust}\op \times \text{Thrust}$ is the \emph{unit} design problem described below in \cref{eqn:unit_morphism} and the dependent design problem `R\&D $\mid$ engine' is defined by
\begin{align*}
(\text{R\&D } \mid \text{ engine}) \colon (\text{Thrust}\op \times \text{Fuel})\op \times (\text{Time} \times \text{Money}) &\toinPos \Bool \\
\tup{\tup{h^*, f}^*, \tup{t,m}} &\mapsto \text{R\&D}(\text{engine}, \tup{t,m}).
\end{align*}
As expected, `R\&D $|$ engine' simply throws away the thrust and fuel information.

The composition $(\eta \then \text{engine} \then \text{R\&D } \mid \text{ engine}) (t,m)$ is defined by
\begin{equation*}
    \text{R\&D}(\text{engine}, \tup{t,m}) \wedge \bigvee_{h^*,f} \text{engine}(h^*, f).
\end{equation*} 
In other words, the composition represents a simple threshold of time and money (actually, an antichain in the poset Time $\times$ Money), above which it is feasible to construct `engine', and below which it is not.

This design problem can then simply be tensored with the original engine design problem to create a compiled design problem of the form $(\text{engine} \otimes \text{R\&D}) \colon \text{Thrust} \tickar \text{Fuel} \times \text{Time} \times \text{Money}$. Since we are simply tensoring, the original engine design problem can still be plugged into a larger design problem in all the usual ways.
\end{example}

\GZ{
\begin{shaded}
\begin{definition}[Compact closed category]
Let $\tup{\CatC,\otimes,I,\sigma}$ be a symmetric monoidal category. It is called \emph{compact closed} if, for all $C \in\CatC$ there exists some object $C^*\in\CatC$ (called the \emph{dual of $C$}), a morphism $\eta_C\colon I\to C^*\otimes C$ (called the \emph{unit for $C$}), and a morphism $\epsilon_C\colon C\otimes C^*\to I$ (called the \emph{counit of~$C$}) such that the following diagrams commute for all~$C$:
\begin{equation}\label{eqn:ccc}
\includesag{60_compact_1}
\end{equation}
~
\begin{equation}
    \includesag{60_compact_2}
\end{equation}
\end{definition}
\end{shaded}

\begin{lemma}
The symmetric monoidal category $\tup{\DP,\otimes,\singleton,\sigma}$ is compact closed.
\end{lemma} 
\begin{proof}
For any poset $\cP $, its dual is $\cP \op$.

Define the unit $\eta_P\colon \F{\singleton} \tickar \R{P}\op \times \R{P} $ as
\begin{equation}
\label{eqn:unit_morphism} 
\begin{aligned}
    \eta_P \colon \F{\singleton} \times (\R{P}\op \times \R{P}) & \toinPos \Bool, \\
            \tup{\F{1},\tup{\R{p}^*,\R{q}}} & \mapsto \R{p} \leq_P \R{q}.
\end{aligned}
\end{equation}

Define the counit $\epsilon_P\colon P\op \times P \tickar \{1\} $ as
\begin{equation}
\begin{aligned}
    \epsilon_P \colon (\F{P}\op \times \F{P})\op \times \R{\singleton} & \toinPos \Bool,  \\
            \tup{\tup{\F{p},\F{q}^*}, \R{1}} & \mapsto \F{p} \leq_P \F{q}.
\end{aligned}
\end{equation}

We now check that the first diagram \cref{eqn:ccc} holds; to show that the second holds, is similar. We will show that the composite $\rho^{-1}\then \eta\then \alpha \then \epsilon\then \lambda$, call it $f\colon \F{\cP} \tickar \R{\cP} $, is equal to $\Unit{\cP }$.

First, let's consider each morphism in this composite morphism $f$. For $\rho^{-1}$ one has:
\begin{equation}
	\rho^{-1}\left(\F{p_1}^*,\tup{\R{p_2},\R{*}}\right)=\F{p_1}\leq \R{p_2}.
\end{equation}
For $\eta_P$ one has
\begin{equation}
    	\eta\left(\tup{\F{p_2},\F{*}}^*,\tup{\R{p_3},\tup{\R{p_4}^*,\R{p_5}}}\right)=(\F{p_2}\leq \R{p_3})\wedge(\R{p_4}\leq \R{p_5}).
\end{equation}
For $\alpha$ one has
\begin{equation}
    \alpha\left( \tup{\F{p_3},\tup{\F{p_4}^*,\F{p_5}}}^*,\tup{\tup{\R{p_6},\R{p_7}^*},\R{p_8}}\right)=(\F{p_3}\leq \R{p_6})\wedge(\R{p_7}\leq \F{p_4})\wedge(\F{p_5}\leq \R{p_8}).
\end{equation}
For $\epsilon_P$ one has
\begin{equation}
    \epsilon\left(\tup{\tup{\F{p_6},\F{p_7}^*},\F{p_8}}^*,\tup{\R{*},\R{p_9}}\right)=(\F{p_6}\leq \F{p_7})\wedge (\F{p_8}\leq \R{p_9}).
\end{equation}
Finally, for $\lambda$ one has
\begin{equation}
    \lambda\left(\tup{\F{*},\F{p_9}}^*,\R{p_{10}}\right)=\F{p_9}\leq \R{p_{10}}.
\end{equation}
The composition formula then says that $f$ is given by:
\begin{equation}
    \begin{aligned}
    f(\F{p_1}^*,\R{p_{10}})&=\bigvee_{p_2,\ldots,p_9} (\F{p_1}\leq p_2\leq p_3\leq p_6\leq p_7\leq p_4\leq p_5\leq p_8\leq p_9\leq \R{p_{10}})\\
    &=\F{p_1}\leq \R{p_{10}}\\
    &=\id_P(\F{p_1}^*,\R{p_{10}})
    \end{aligned}
\end{equation}
\end{proof}}
\subsubsection*{Dependent design problems}
\cref{ex:r&dproblem} was relatively simplistic, since we fixed a specific engine $\in \Hom_\DP(\text{Thrust}, \text{Fuel})$. Now, suppose we want to make the engine design problem---``available technologies''---in a rocket design problem \emph{dependent} on the amount of time and money committed in the R\&D design problem, given that time and money could be spent on other things, like building the actual rocket. In other words, we want a design problem involving R\&D, which still retains Fuel and Thrust as ``open'' inputs and outputs. This is a typical kind of design problem one considers when funding science and R\&D projects---a very relevant subject for the authors of this article!

Recall that, for a fixed choice of $f \in \Hom_\DP(A,B)$, any `design problem of design problems' $k : \Hom_\DP(A,B) \tickar C$ can be reframed as a composition of three maps: the unit $\eta_A : \One \tickar A\op \times A$, $f : A \tickar B$, and the dependent design problem $(k | f) : A\op \times B \tickar C$.

\todo{I'm stuck on this; not quite sure how to define these kinds of problems. We may not be able to do this in $\DP$ as defined... maybe it would be easier in $\DPI$?}

Before going to the next example, we introduce a special design problem for adding the output of two wires.
% Should we also define multiplication? E.g., perhaps we want the weight of the motor to be some much smaller proportion of the total weight it can carry.

% Recall that, for a fixed choice of engine $\in$ Engines, Jeb's original R\&D design problem can be reframed as a composition of three maps: $\eta : \One \tickar \text{Thrust}\op \times \text{Thrust}$, $\text{engine} : \text{Thrust} \tickar \text{Fuel}$, and a map $\text{R\&D} : \text{Thrust}\op \times \text{Fuel} \tickar \text{Time} \times \text{Money}$.

\begin{example}
Jeb's R\&D team is made up of three rocket scientists: Howie, who has watched every Fast\&Furious movie, Shirley, an unpaid intern, and Mabie, who was recently prosecuted for insurance fraud. Howie says that given 3 months and \$100,000, he can make the engine much faster at higher fuel inputs. Shirley says that given 1 month and \$10,000, she can make the engine slightly more fuel-efficient at all currently-feasible thrust performances. Mabie promises that with just 1 week and \$10 million, she can make the engine perform spectacularly at a very low fuel input.
\end{example}

One can go to even higher design problems. In the example above, Jeb might want to know whether it's worth spending all that time and money to improve the Jeb-XX so that it is competitive with the Bob-Roc, given the value of the contract from NASA. But this requires us to think about R\&D processes themselves; i.e. it should cost less time and money to achieve Bob-Roc-grade performance, given the Jeb-XX as a starting point, than it does it to achieve Bob-Roc-grade performance, given the Wright engine as a starting point. That is, we would like to treat the set of engine technologies
\[\text{Engines} = \Hom_\DP(\text{Thrust}, \text{Fuel})\]
as a resource input to a design problem which outputs R\&D processes,
\[\text{R\&D Companies} = \Hom_\DP(\text{Engines}, \text{Time} \times \text{Money}).\]

Notably, the design problem
\[
\includesag{60_higher1}
\]
is an element of $\text{R\&D Companies}$ and thus we can consider, simultaneously, ...
\[
\includesag{60_higher2}
\]
Each R\&D process itself outputs an engine technology, so one can imagine tracing the diagram above.

\subsubsection*{TO PUT BACK UP}
We claimed that category theory is an efficient language for talking about \emph{structure}, and showed how the category $\DP$ could accommodate all the basic operations required by a theory of formal engineering design as defined in Section~\XXX. Here, we illustrate some of the applications and advantages of $\DP$ in reasoning about and solving design problems, starting with the fact that that $\DP$ is compact closed, which allows us to compose and reason about ``design problems of design problems''. \GZ{A bit repetitive} We conclude by discussing how to generalize $\DP$ to other kinds of design problems via the categorical idea of enrichment.

Some preliminaries.

\begin{definition}\label{def:DP_loc_pos}
%
Suppose that $A$ and $B$ are two posets, and that $f,g \colon \F{A} \tickar \R{B}$ are design problems.

We say that $f$ \emph{implies} $g$, denoted $f \geq_{\DP} g$, if $f(\F{a}^*,\R{b}) \leq g(\F{a}^*,\R{b} )$ in $\Bool$, for all~$\F{a} \in \F{A}$
and~$\R{b} \in \R{B}$. In other words, if $f$ feasible implies that $g$ is feasible. We often denote the relation $f \geq_{\DP} g$
by the diagram
\begin{equation}
\includesag{60_relation}
\end{equation}
\end{definition}

Note that $f\geq_\DP f$ is always true, and that if $f\geq_\DP g$ and $g\geq_\DP h$ then $f\geq_\DP h$.
In other words, the set $\Hom_\DP(A,B)$ of design problems from $A$ to $B$ (\cref{def:categorymain}), itself forms a poset.\footnote{In fact, $\Hom_\DP(A,B)$ is a bounded lattice with $\vee$ as meet, $\wedge$ as join, and greatest and least elements $1_{A,B}$ (the design problem which is always feasible for any
functionality-resource pair) and $0_{A,B}$ (the design problem which is never feasible for any functionality-resource pair).}
In particular, this means that design problems in $\Hom_\DP(A,B)$ can be counted as functionalities and/or resources in a design problem.

\begin{example}\label{ex:r&d}
Jeb's Spaceship Parts lost their last contract to Starshow Bob after submitting a completely inferior engine in every respect ($\text{Jeb-XX} \Imp \text{Bob-Roc}$). In response, they've decided to invest heavily in R\&D, which can be thought of as a design problem of its own: Given time and money as resources, what kind of engine technology can they produce as a `functionality'?
\[
\includesag{60_engine}
\]
\end{example}
\subsection{A locally-posetal pro-arrow equipment}
\todo{Recall that we had discussed and precisely characterized the relationship between $\DP$ and the category $\Rel$ of relations in \cref{??}: $\Rel$ is a subcategory of $\DP$.} In \cref{def:comp_conj} on companions and conjoints, we saw how any monotone map in $\Pos$ can be turned into a design problem. But $\DP$ is not a subcategory of $\Pos$, nor vice versa. Using the 2-category language, we can now precisely characterize the relationship between $\Poset$ and $\DP$. % Both have the same objects, but the morphisms in $\DP$ are more permissive.

\todo{2-category not defined yet}

\begin{proposition}\label{prop:comp_conj}
Both the companion and conjoint constructions from \cref{def:comp_conj} are functorial: They preserve identities and composition.
\end{proposition}
\begin{proof}
We will show that the companion and conjoint are functors of the following forms:
\begin{equation}
\comp{(\cdot)}\colon\Poset\to\DP\op
\qquad\text{and}\qquad
\conj{(\cdot)}\colon\Poset\to\DP
\end{equation}
First, we see that they send the identity monotone map $f(p)=p$ to the unit $\Unit{\cP }$ for any poset $\cP $, because 
\begin{equation}
    \begin{aligned}
        \comp{\id}(\F{p_1}^*,\R{p_2})&= (\F{p_1} \leq_{\cP} \R{p_2})\\
        &=\conj{\id}(\F{p_1}^*,\R{p_2})
    \end{aligned}
\end{equation}

Now suppose that $f\colon  \cP \toinPos \cQ $ and $g\colon \cQ \toinPos \cR$ are given. We first show that $\conj{f}\then\conj{g}=\conj{f\then g}$.
For any $p\in P$ and $r\in R$, one has
\begin{equation}
\begin{aligned}
	\left(\conj{f}\then \conj{g}\right)(\F{p}^*,\R{r})
	&=\bigvee_{q\in Q}\ \conj{f}(\F{p}^*,\R{q})\wedge\conj{g}(\F{q}^*,\R{r})\\
	&=\bigvee_{q\in Q}\ \left(f(\F{p}) \leq_\cQ \R{q} \right)\wedge \left(g(\F{q}) \leq_\cR \R{r}\right)\\
	&= \left( g(f(\F{p})) \leq_\cR \R{r} \right)\\
    &=\left(\conj{(f\then g)}\right)(\F{p}^*,\R{r}).
\end{aligned}
\end{equation}
A dual calculation proves that $\comp{g}\then \comp{f}=\comp{f\then g}$.
\end{proof}

\begin{proposition}\label{prop:companion_2}
The companion functor $\comp{(\cdot)}\colon\Poset\to\DP\op$ preserves the 2-structure; i.e.\ if $f\Imp g$ as monotone maps $\cP \to\cQ $, then $\comp{f}\Imp\comp{g}$ as profunctors $\F{\cQ} \tickar\R{\cP} $. In fact, it is locally fully faithful (\cref{def:functorfullfaith}): $f\geq_\DP g$ iff $\comp{f}\geq_\DP \comp{g}$.
\end{proposition}
\begin{proof}
Let $f,g$ be as in the proposition statement. We have the following chain of equivalences:
\begin{equation}
\begin{aligned}
	f\geq_\DP g&\text{ iff }
	\forall p\in P, f(p)\leq g(p)\\&\text{ iff }
	\forall p\in P, \forall q\in Q, (q\leq f(p))\Imp (q\leq g(p))\\&\text{ iff }
	\comp{f}\geq_\DP \comp{g}.
\end{aligned}
\end{equation}
\end{proof}

\begin{proposition}\label{prop:comp_conj_adj}
For any monotone map $f\colon\cP \to\cQ $ we have implications
\begin{equation}
\Unit{\cP }\geq_\DP (\conj{f}\then \comp{f})
\qquad\text{and}\qquad
(\comp{f}\then \conj{f})\geq_\DP \Unit{\cQ }
\end{equation}
\end{proposition}
\begin{proof}
For any $p_1,p_2\in P$, we have
\begin{equation*}
	\Unit{\cP }(p_1^*,p_2)=\cP (p_1,p_2)
	\Imp\bigvee_{q\in Q}\cQ (f(p_1),q)\wedge\cQ (q,f(p_2))=(\conj{f}\then \comp{f})(p_1^*,p_2)
\end{equation*}
where the implication arrow comes, e.g.\ from taking $q=f(p_1)$. And just by transitivity, we have for any $q_1,q_2\in Q$:
\begin{equation*}
	[\comp{f}\then \conj{f}](q_1^*,q_2)=\bigvee_{q\in Q}\cQ (q_1,f(p))\wedge\cQ (f(p),q_2)
	\Imp\cQ (q_1,q_2)=\Unit{\cQ }(q_1^*,q_2).\qedhere
\end{equation*}
\end{proof}

For the sake of completeness, we add the following theorem, which is in fact a summary of every proposition we have developed since Section~\ref{sec:compact_closed}.
% : although we have not defined pro-arrow equipments in this paper, the following theorem in fact

\begin{theorem}
The 2-categories $\Poset$ and $\DP\op$, together with the companion and conjoint functors from \cref{prop:comp_conj}, form a locally-posetal pro-arrow equipment.
\end{theorem}
\begin{proof}
A locally-posetal pro-arrow equipment consists of the following data:
\begin{compactitem}
	\item a locally posetal 2-category $\mathbf{P}$ (see \cref{def:loc_pos_cat}),
	\item a locally-posetal 2-category $\mathbf{D}$, and
	\item a 2-functor $c\colon\mathbf{P}\to\mathbf{D}$, having the properties that
	\begin{compactitem}
		\item $c$ is bijective on objects,
		\item $c$ is locally fully faithful, and
		\item for every 1-morphism $f\colon p\to q$ in $\mathbf{P}$, there is a morphism $c'(f)$ such that
		\[\id_p\Imp c(f);c'(f)\quad\text{and}\quad c'(f);c(f)\Imp\id_q\]
	\end{compactitem}
\end{compactitem}
In our situation, the locally-posetal 2-categories are $\mathbf{P}\coloneqq\Poset$, $\mathbf{D}\coloneqq\DP\op$; see \cref{def:Pos_loc_pos, prop:Pos_loc_pos, def:DP_loc_pos, prop:DP_loc_pos, lemma:loc_pos_op}. The 2-functor is basically the companion map; on objects it is the identity, on morphisms it is the companion $c(f)\coloneqq\comp{f}$ as in \cref{def:comp_conj}, and it is 2-functorial and fully faithful by \cref{prop:companion_2}. For every $f$, the final property is satisfied by the conjoint $c'(f)\coloneqq \conj{f}$.
\end{proof}

\todo{Can we give a reference for ``locally posetal proarrow equipment''?
We should do this in many parts of the paper. At the beginning, give references
to the usual introductory books. And when we use some non-trivial words, give references to the literature somewhere, even if it is a bit too difficult for the reader of the paper.}

\AC{Is the 2-category structure preserved by the trace? I suspect it follows from something we already say, but it would be nice to point it out for the slow children.}